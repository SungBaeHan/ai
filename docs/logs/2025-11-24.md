# ë°°í¬ ì´ë ¥ - 2025-11-24

## ì£¼ìš” ì‘ì—… ë‚´ìš©

### 1. í”„ë¡ íŠ¸ì—”ë“œ API ê²½ë¡œì—ì„œ `/api` prefix ì œê±°

#### ë°°ê²½
- nginx í”„ë¡ì‹œ ì œê±° í›„ FastAPIê°€ ë£¨íŠ¸ì— ì§ì ‘ ë…¸ì¶œë˜ë©´ì„œ
- í”„ë¡ íŠ¸ì—”ë“œê°€ ì—¬ì „íˆ `https://api.arcanaverse.ai/api/v1/...` ê²½ë¡œë¡œ í˜¸ì¶œí•˜ì—¬ 404 ë°œìƒ
- API_BASE_URLì—ì„œ `/api` suffixë¥¼ ì œê±°í•˜ì—¬ ìµœì¢… ìš”ì²­ ê²½ë¡œë¥¼ `/v1/...`ë¡œ ë§ì¶¤

#### ìˆ˜ì •ëœ íŒŒì¼
- `apps/web-html/home.html`
- `apps/web-html/chat.html`
- `apps/web-html/my.html`
- `apps/web-html/js/config.js`

#### ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **API_BASE_URL ì„¤ì • ìˆ˜ì •**
   - `https://api.arcanaverse.ai/api` â†’ `https://api.arcanaverse.ai`
   - ë¡œì»¬ ê°œë°œ í™˜ê²½: `http://localhost:8000/api` â†’ `http://localhost:8000`

2. **window.API_BASE_URL ëª…ì‹œì  ì„¤ì •**
   - `home.html`, `chat.html`, `my.html`ì— `window.API_BASE_URL` ì„¤ì • ì¶”ê°€
   - Cloudflare Pages ë°°í¬ í™˜ê²½ì—ì„œ í™•ì‹¤í•˜ê²Œ API ë„ë©”ì¸ ì‚¬ìš© ë³´ì¥

3. **API ìƒìˆ˜ ë¡œì§ ê°œì„ **
   ```javascript
   const isLocal =
     typeof window !== 'undefined' &&
     (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');

   const API_BASE = (typeof window !== 'undefined' && window.API_BASE_URL)
     ? window.API_BASE_URL
     : (typeof window !== 'undefined' && window.API_BASE)
       ? window.API_BASE
       : (isLocal
           ? 'http://localhost:8000'
           : 'https://api.arcanaverse.ai');
   ```

4. **API í˜¸ì¶œ ê²½ë¡œ í™•ì¸**
   - ëª¨ë“  API í˜¸ì¶œì´ `${API_BASE}/v1/...` í˜•íƒœë¡œ ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±ë¨
   - ì˜ˆ: `https://api.arcanaverse.ai/v1/characters?offset=0&limit=200`

#### ìµœì¢… API ìš”ì²­ URL
- **ë°°í¬ í™˜ê²½**: `https://api.arcanaverse.ai/v1/characters`
- **ë¡œì»¬ ê°œë°œ í™˜ê²½**: `http://localhost:8000/v1/characters`

---

### 2. Docker Compose ì„¤ì • ë³€ê²½ (nginx í”„ë¡ì‹œ ì œê±°)

#### ë°°ê²½
- Cloudflare PagesëŠ” í”„ë¡ íŠ¸ìš©, Oracle VMì€ API ì „ìš©ìœ¼ë¡œ ë¶„ë¦¬
- Oracle VMì˜ nginx(web) ì»¨í…Œì´ë„ˆëŠ” í¼ë¸”ë¦­ ì„œë¹„ìŠ¤ì—ì„œ ì œê±°
- FastAPI(api) ì»¨í…Œì´ë„ˆë¥¼ í˜¸ìŠ¤íŠ¸ 80 í¬íŠ¸ì— ë°”ì¸ë”©

#### ìˆ˜ì •ëœ íŒŒì¼
- `infra/docker-compose.yml`

#### ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **web/nginx ì»¨í…Œì´ë„ˆ ë¹„í™œì„±í™”**
   - `web` ì„œë¹„ìŠ¤ ë¸”ë¡ ì „ì²´ ì£¼ì„ ì²˜ë¦¬
   - ì£¼ì„ ì¶”ê°€:
     ```yaml
     # NOTE:
     # Frontend is served via Cloudflare Pages.
     # Oracle VM exposes only FastAPI on port 80 for api.arcanaverse.ai.
     ```

2. **api ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë³€ê²½**
   - ê¸°ì¡´: `"8000:8000"`
   - ë³€ê²½: `"80:8000"`
   - FastAPIê°€ í˜¸ìŠ¤íŠ¸ì˜ 80ë²ˆ í¬íŠ¸ì—ì„œ ì§ì ‘ ì„œë¹„ìŠ¤ë¨

#### ì¬ë°°í¬ ëª…ë ¹
```bash
cd ~/ai/infra
docker compose down
docker compose up -d
```

---

### 3. CORS ì„¤ì • ê°œì„ 

#### ìˆ˜ì •ëœ íŒŒì¼
- `apps/api/main.py`

#### ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **ë¡œê¹… ê°œì„ **
   - `print` ëŒ€ì‹  `logging.getLogger(__name__)` ì‚¬ìš©
   - CORS ì„¤ì • ë¡œê·¸ ì¶”ê°€

2. **CORS ì„¤ì • ì •ë¦¬**
   ```python
   logger = logging.getLogger(__name__)

   raw_origins = os.getenv("CORS_ALLOW_ORIGINS", "")
   if raw_origins:
       origins = [o.strip() for o in raw_origins.split(",") if o.strip()]
   else:
       origins = []

   logger.info("CORS_ALLOW_ORIGINS from env = %s", raw_origins)
   logger.info("Parsed CORS origins = %s", origins)

   app.add_middleware(
       CORSMiddleware,
       allow_origins=origins if origins else ["*"],
       allow_credentials=True,
       allow_methods=["*"],     # ëª¨ë“  ë©”ì†Œë“œ í—ˆìš© (GET, POST, OPTIONS ë“±)
       allow_headers=["*"],     # ëª¨ë“  í—¤ë” í—ˆìš©
   )
   ```

3. **í—ˆìš© Origin ëª©ë¡**
   - `https://arcanaverse.ai`
   - `https://www.arcanaverse.ai`
   - `https://api.arcanaverse.ai`
   - í™˜ê²½ë³€ìˆ˜ `CORS_ALLOW_ORIGINS`ë¡œ ì„¤ì • ê°€ëŠ¥

---

### 4. OpenAI API í‚¤ ë³€ìˆ˜ëª… í˜¸í™˜ì„± ì§€ì›

#### ë°°ê²½
- ê¸°ì¡´ ì½”ë“œê°€ ê¸°ëŒ€í•˜ëŠ” ë³€ìˆ˜ëª… `OPEN_API_KEY` ë³µêµ¬
- ìƒˆë¡œìš´ ë³€ìˆ˜ëª… `OPENAI_API_KEY`ë„ í—ˆìš©í•˜ë„ë¡ í˜¸í™˜ì„± ì§€ì›
- OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œ ë¡œê·¸ ì¶œë ¥

#### ìˆ˜ì •ëœ íŒŒì¼
- `adapters/external/openai/openai_client.py`

#### ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **ë‘ í™˜ê²½ë³€ìˆ˜ ëª¨ë‘ ì§€ì›**
   ```python
   api_key = (
       os.getenv("OPEN_API_KEY")      # ê¸°ì¡´ ë³€ìˆ˜ëª…
       or os.getenv("OPENAI_API_KEY")  # ìƒˆ ë³€ìˆ˜ëª…
   )
   ```

2. **Base URL ì§€ì› í™•ì¥**
   ```python
   base_url = (
       os.getenv("OPENAI_API_BASE")
       or os.getenv("OPENAI_BASE_URL")
       or "https://api.openai.com/v1"
   )
   ```

3. **ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€**
   ```python
   if not api_key:
       logger.error("âŒ No OpenAI API key found. (OPEN_API_KEY / OPENAI_API_KEY both missing)")
   else:
       logger.info(
           f"ğŸ”‘ OpenAI Client Initialized | base={base_url} | model={model_name} | key_len={len(api_key)}"
       )
   ```

#### í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì˜ˆì‹œ
```bash
# ê¸°ì¡´ ì´ë¦„ ë³µêµ¬ (í•„ìˆ˜)
OPEN_API_KEY=sk-...

# ìƒˆ ì´ë¦„ë„ ê°™ì´ ì§€ì› ê°€ëŠ¥ (ì„ íƒ)
OPENAI_API_KEY=sk-...

# ë‚˜ë¨¸ì§€ëŠ” ìœ ì§€
OPENAI_MODEL=gpt-4.1-mini
OPENAI_API_BASE=https://api.openai.com/v1
```

---

### 5. /v1/chat/ ì—”ë“œí¬ì¸íŠ¸ ì˜¤ë¥˜ ì²˜ë¦¬ ê°œì„ 

#### ë°°ê²½
- /v1/chat/ ì—”ë“œí¬ì¸íŠ¸ ë‚´ë¶€ì—ì„œ ë°œìƒí•˜ëŠ” ëª¨ë“  ì˜¤ë¥˜ë¥¼ try/exceptë¡œ ì¡ì•„ì„œ
- FastAPI ì›Œì»¤ê°€ ì£½ì§€ ì•Šë„ë¡ í•˜ê³ , ì •í™•í•œ ì˜¤ë¥˜ë¥¼ logger.exception()ìœ¼ë¡œ ì¶œë ¥
- ì‘ë‹µì€ HTTP 500 JSONìœ¼ë¡œ ë¸Œë¼ìš°ì €ì— ë°˜í™˜

#### ìˆ˜ì •ëœ íŒŒì¼
- `apps/api/routes/chat.py`
- `apps/api/routes/app_chat.py`

#### ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **ì „ì²´ í•¨ìˆ˜ë¥¼ try-exceptë¡œ ê°ì‹¸ê¸°**
   ```python
   @router.post("/")
   async def chat(req: Request):
       try:
           # ... ê¸°ì¡´ ì½”ë“œ ...
           return JSONResponse({"answer": text, "sid": sid}, ...)
       except Exception as e:
           logger.exception("ğŸ”¥ /v1/chat/ ë¼ìš°í„° ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ!")
           raise HTTPException(
               status_code=500,
               detail=f"Internal Chat Error: {str(e)}"
           )
   ```

2. **ë¡œê¹… ê°œì„ **
   - `logger.exception()` ì‚¬ìš©ìœ¼ë¡œ ìƒì„¸í•œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë¡œê¹…
   - ë¸Œë¼ìš°ì €ì— `{"detail": "Internal Chat Error: ..."}` í˜•íƒœì˜ JSON ì‘ë‹µ ë°˜í™˜

3. **Worker Crash ë°©ì§€**
   - ëª¨ë“  ì˜ˆì™¸ë¥¼ í¬ì°©í•˜ì—¬ FastAPI worker crash ë°©ì§€
   - "Failed to fetch" ëŒ€ì‹  ì •í™•í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ

---

## ì£¼ìš” ì»¤ë°‹

1. `c71b01c` - ê¸°ë³¸ ë„ë©”ì¸ ìˆ˜ì •
2. `1e5eda0` - window.API_BASE_URL ì ìš©
3. `4e6142e` - nginx ì„¤ì • ë³€ê²½
4. `7f64bd4` - api í˜¸ì¶œ ê²½ë¡œ ë³€ê²½
5. `762875c` - api url ë³´ì •
6. `ecb0d3e` - API_BASE_URL ìš°ì„  ì‚¬ìš© ë° window.API_BASEë„ í•¨ê»˜ ì„¤ì •í•˜ì—¬ /api prefix ì œê±° ë³´ì¥
7. `252354b` - fix: Update my.html to use window.API_BASE_URL for auth endpoint
8. `93a3e82` - fix: Update CORS configuration with proper logging and allow all methods/headers
9. `13a9f54` - fix: Add OPEN_API_KEY support and improve error handling in chat endpoint
10. `8264854` - fix: Improve error handling in /v1/chat/ endpoint with comprehensive exception catching

---

## ê²€ì¦ ë°©ë²•

### 1. API ê²½ë¡œ í™•ì¸
```bash
# ë¸Œë¼ìš°ì €ì—ì„œ https://arcanaverse.ai/home ì ‘ì† í›„
# DevTools â†’ Network íƒ­ì—ì„œ ì²« API í˜¸ì¶œ í™•ì¸
# ì˜ˆìƒ URL: https://api.arcanaverse.ai/v1/characters?offset=0&limit=200
```

### 2. CORS í™•ì¸
```bash
# Swagger UI í™•ì¸
curl https://api.arcanaverse.ai/docs

# CORS ì„¤ì • í™•ì¸ (ì„œë²„ ë¡œê·¸)
docker logs trpg-api | grep "CORS"
```

### 3. OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í™•ì¸
```bash
# ì„œë²„ ë¡œê·¸ì—ì„œ OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ë©”ì‹œì§€ í™•ì¸
docker logs trpg-api | grep "OpenAI Client Initialized"
```

### 4. ì˜¤ë¥˜ ì²˜ë¦¬ í™•ì¸
```bash
# /v1/chat/ ì—”ë“œí¬ì¸íŠ¸ ì˜¤ë¥˜ ë°œìƒ ì‹œ
# ì„œë²„ ë¡œê·¸ì—ì„œ "ğŸ”¥ /v1/chat/ ë¼ìš°í„° ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ!" í™•ì¸
# ë¸Œë¼ìš°ì €ì—ì„œ {"detail": "Internal Chat Error: ..."} í˜•íƒœì˜ ì‘ë‹µ í™•ì¸
```

---

## ì•„í‚¤í…ì²˜ ë³€ê²½

### ì´ì „ (nginx í”„ë¡ì‹œ í¬í•¨)
```
Cloudflare Pages â†’ Oracle VM (nginx:80) â†’ FastAPI:8000
                    â†“
              í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹™
```

### í˜„ì¬ (nginx í”„ë¡ì‹œ ì œê±°)
```
Cloudflare Pages (í”„ë¡ íŠ¸ì—”ë“œ) â†’ Oracle VM (FastAPI:80)
                              â†“
                    api.arcanaverse.ai
```

---

## í™˜ê²½ë³€ìˆ˜ ìš”ì•½

### í”„ë¡ íŠ¸ì—”ë“œ (Cloudflare Pages)
- `window.API_BASE_URL = 'https://api.arcanaverse.ai'` (ìë™ ì„¤ì •)

### ë°±ì—”ë“œ (Oracle VM)
- `OPEN_API_KEY` ë˜ëŠ” `OPENAI_API_KEY`: OpenAI API í‚¤
- `OPENAI_MODEL`: ì‚¬ìš©í•  ëª¨ë¸ëª… (ê¸°ë³¸ê°’: gpt-4.1-mini)
- `OPENAI_API_BASE`: API ë² ì´ìŠ¤ URL (ê¸°ë³¸ê°’: https://api.openai.com/v1)
- `CORS_ALLOW_ORIGINS`: í—ˆìš©í•  origin ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)

---

## ì£¼ì˜ì‚¬í•­

1. **í”„ë¡ íŠ¸ì—”ë“œ ì¬ë°°í¬**: ë³€ê²½ì‚¬í•­ ì ìš©ì„ ìœ„í•´ Cloudflare Pagesì— ì¬ë°°í¬ í•„ìš”
2. **API ì„œë²„ ì¬ì‹œì‘**: docker-compose.yml ë³€ê²½ í›„ ì„œë²„ ì¬ì‹œì‘ í•„ìš”
3. **í™˜ê²½ë³€ìˆ˜ í™•ì¸**: Oracle VMì˜ `.env` íŒŒì¼ì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸
4. **í¬íŠ¸ ì¶©ëŒ**: ê¸°ì¡´ 80ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸

---

## ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒì‚¬í•­)

1. **ëª¨ë‹ˆí„°ë§ ê°•í™”**: API í˜¸ì¶œ ì‹¤íŒ¨ìœ¨ ëª¨ë‹ˆí„°ë§ ì¶”ê°€
2. **ì—ëŸ¬ ì•Œë¦¼**: ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•Œë¦¼ ì‹œìŠ¤í…œ ì—°ë™
3. **ì„±ëŠ¥ ìµœì í™”**: API ì‘ë‹µ ì‹œê°„ ìµœì í™”
4. **ë¡œê¹… ê°œì„ **: êµ¬ì¡°í™”ëœ ë¡œê¹… (JSON í˜•íƒœ) ë„ì…






