# 작업 로그 - 2025년 12월 4일

## 개요
World(세계관) API 엔드포인트 구현, 이미지 경로 정규화, World 상세 페이지 및 채팅 기능 구현

---

## 주요 작업 내용

### 1. World API GET 엔드포인트 구현
- **커밋**: `27a2dac - feat: implement GET /v1/worlds endpoint with MongoDB async query`
- **문제**: `/v1/worlds` 엔드포인트에서 405 (Method Not Allowed) 오류 발생
- **원인**: World 라우터에 GET 메서드가 등록되지 않음

#### 1.1 World 목록 조회 엔드포인트 추가
- **파일**: `apps/api/routes/worlds.py`
- **엔드포인트**: `GET /v1/worlds`
- **기능**:
  - MongoDB에서 world 컬렉션 조회
  - offset, limit 파라미터 지원
  - created_at 기준 최신순 정렬
  - Motor async 클라이언트 사용
- **응답 형식**:
  ```json
  {
    "total": 0,
    "items": []
  }
  ```

#### 1.2 Pydantic 모델 추가
- **모델**:
  - `World`: world 컬렉션 문서 모델 (id, name 필수, extra 허용)
  - `WorldListResponse`: 목록 응답 모델 (total, items)

#### 1.3 MongoDB 연결 헬퍼 함수
- **함수**: `get_mongo_db()`
- **기능**: Motor AsyncIOMotorClient 싱글톤 인스턴스 반환
- **환경변수**: `MONGO_URI`, `MONGO_DB` (기본값: "arcanaverse")

### 2. World 이미지 경로 정규화
- **커밋**: `c23604b - fix: normalize world image paths to R2 public URL in list endpoint`
- **문제**: World API가 내부 경로(`/assets/world/...`)를 그대로 반환하여 프론트엔드에서 이미지 로드 실패
- **해결**: 캐릭터 API와 동일하게 R2 public URL로 변환

#### 2.1 이미지 경로 정규화 로직 추가
- **파일**: `apps/api/routes/worlds.py`
- **함수**: `normalize_world_image()` (기존 함수 활용)
- **적용 필드**: `image`, `image_path`, `src_file`
- **변환**: `/assets/world/...` → R2 public URL (`https://pub-xxx.r2.dev/assets/world/...`)

### 3. World 이미지 로딩 무한 루프 문제 해결
- **커밋**: `fix: simplify world card image loading to prevent infinite error loop`
- **문제**: World 카드 이미지 로딩 실패 시 무한 루프 발생
- **원인**: 복잡한 경로 처리 로직과 onerror 핸들러에서 placeholder도 실패하는 경우

#### 3.1 이미지 처리 로직 단순화
- **파일**: `apps/web-html/home.html`
- **변경사항**:
  - World 카드 이미지 처리를 캐릭터 카드와 동일하게 단순화
  - 불필요한 경로 처리 로직 제거
  - `onerror` 핸들러 제거 (브라우저 기본 동작 사용)
  - `resolvePath()` 함수만 사용

### 4. World 상세 페이지 구현
- **커밋**: `feat: implement world detail page with chat functionality`
- **파일**: `apps/web-html/world.html` (신규)

#### 4.1 World 상세 API 엔드포인트 추가
- **파일**: `apps/api/routes/worlds.py`
- **엔드포인트**: `GET /v1/worlds/{world_id}`
- **기능**:
  - 숫자 ID 또는 `world_XX` 형태 모두 지원
  - MongoDB에서 world 조회
  - 이미지 경로 R2 public URL로 정규화
- **응답**: World 모델 (Pydantic)

#### 4.2 World 상세 페이지 생성
- **파일**: `apps/web-html/world.html` (신규)
- **기능**:
  - 캐릭터 채팅 페이지(`chat.html`)를 기반으로 구현
  - World 정보 표시 (이름, 소개, 태그 등)
  - World 이미지 표시 (히어로 이미지, 배경)
  - TRPG 채팅 기능
  - **차이점**: 캐릭터와 달리 인사말(greeting) 없이 자유롭게 채팅 시작

#### 4.3 World 이미지 경로 처리
- **함수**: `resolvePath()`
- **로직**: `/assets/world/...` 경로 처리 추가
- **캐릭터와 동일한 방식으로 처리**

#### 4.4 Chat API 연동
- **기능**: World 정보를 Chat API에 전달
- **Payload**:
  ```javascript
  {
    message: string,
    mode: 'trpg',
    world_id: number,
    world: {
      id, name, summary, detail, genre, style, tags
    }
  }
  ```

#### 4.5 Home 페이지 수정
- **파일**: `apps/web-html/home.html`
- **변경사항**:
  - World 카드 클릭 시 `world.html?world={id}`로 이동
  - sessionStorage에 `lastWorld` 저장
  - 기존 "준비 중" 토스트 메시지 제거

---

## 기술 스택

### 백엔드
- FastAPI
- Motor (MongoDB async driver)
- MongoDB
- Pydantic v2

### 프론트엔드
- Vanilla JavaScript
- Fetch API
- sessionStorage

---

## API 엔드포인트

### World API
- `GET /v1/worlds` - World 목록 조회
  - Query Parameters: `offset` (기본값: 0), `limit` (기본값: 20, 최대: 200)
  - 응답: `{ total: number, items: World[] }`
  
- `GET /v1/worlds/{world_id}` - World 상세 조회 (신규)
  - Path Parameters: `world_id` (숫자 또는 `world_XX` 형태)
  - 응답: `World` 객체

---

## 주요 기능

### 1. World 목록 조회
- MongoDB에서 world 컬렉션 조회
- 최신순 정렬 (created_at 기준)
- 이미지 경로 자동 정규화 (R2 public URL)

### 2. World 상세 페이지
- World 정보 표시
- World 이미지 표시
- TRPG 채팅 기능
- 인사말 없이 자유롭게 채팅 시작 (캐릭터와 차이점)

### 3. 이미지 경로 정규화
- 내부 경로 → R2 public URL 자동 변환
- 캐릭터와 동일한 방식으로 처리
- 이미지 로딩 실패 시 무한 루프 방지

---

## 데이터베이스 스키마

### worlds 컬렉션
```javascript
{
  _id: ObjectId,
  id: Number,  // 자동 증가 ID
  name: String,
  genre: String,
  summary: String,
  detail: String,
  tags: [String],
  image: String,  // 내부 경로: /assets/world/...
  image_path: String,
  src_file: String,
  regions: [String],
  factions: [String],
  conflicts: String,
  opening_scene: String,
  style: String,
  status: String,  // "active"
  reg_user: String,  // 등록자 식별자
  created_at: Number,  // UNIX timestamp
  updated_at: Number
}
```

---

## 환경 변수

```bash
# MongoDB
MONGO_URI=mongodb+srv://...
MONGO_DB=arcanaverse  # 기본값

# R2 Storage
R2_PUBLIC_BASE_URL=https://pub-xxx.r2.dev
```

---

## 주요 개선 사항

1. **World API 완성**: 목록 조회 및 상세 조회 기능 구현
2. **이미지 경로 정규화**: R2 public URL로 자동 변환하여 프론트엔드에서 정상 로드
3. **이미지 로딩 안정성**: 무한 루프 문제 해결
4. **World 상세 페이지**: 캐릭터와 유사한 UX로 World 채팅 기능 제공
5. **자유로운 채팅 시작**: World는 인사말 없이 바로 채팅 가능

---

## 향후 개선 사항

1. World 검색 기능 추가 (이름, 태그, 요약에서 검색)
2. World 필터링 기능 (장르, 스타일별 필터)
3. World 생성 시 이미지 자동 정규화
4. World 상세 페이지에서 World 정보 편집 기능

---

## 참고 파일

- `apps/api/routes/worlds.py` - World API 엔드포인트
- `apps/web-html/world.html` - World 상세 페이지 (신규)
- `apps/web-html/home.html` - Home 페이지 (World 카드 링크 수정)
- `apps/api/utils.py` - `build_public_image_url()` 함수 (이미지 경로 정규화)

---

**작성일**: 2025-12-04  
**작성자**: novaworks-dev

