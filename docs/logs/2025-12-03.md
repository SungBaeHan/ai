# 작업 로그 - 2025년 12월 3일

## 개요
암호화된 user_info_v2 토큰 시스템 구현, 세션 검증 엔드포인트 추가, 프론트엔드 세션 관리 개선

---

## 주요 작업 내용

### 1. 암호화된 user_info_v2 토큰 시스템 구현
- **커밋**: `910d78c - feat: implement encrypted user_info_v2 token system with session validation`

#### 1.1 의존성 추가
- **파일**: `requirements.txt`
- **내용**: `cryptography>=43.0.0` 추가 (Fernet 암호화 사용)

#### 1.2 Settings 환경변수 추가
- **파일**: `apps/api/config.py`
- **추가 필드**:
  - `AUTH_USER_INFO_V2_SECRET`: 토큰 암호화용 시크릿 키 (기본값: "arcanaverse.ai.secret.v2")
  - `AUTH_USER_INFO_V2_EXPIRE_MINUTES`: 토큰 만료 시간 (기본값: 4320분 = 3일)

#### 1.3 User Info Token 모듈 생성
- **파일**: `apps/api/core/user_info_token.py` (신규)
- **주요 함수**:
  - `create_user_info_token()`: 사용자 정보를 암호화된 토큰으로 생성
    - Fernet 암호화 사용 (SHA256으로 시크릿 키 파생)
    - Payload: user_id, email, display_name, member_level, last_login_at, expired_at, issued_at, version
  - `decode_user_info_token()`: 암호화된 토큰을 복호화하여 사용자 정보 추출
- **데이터 모델**: `UserInfoTokenPayload` (Pydantic BaseModel)

#### 1.4 세션 검증 스키마 생성
- **파일**: `apps/api/schemas/user_session.py` (신규)
- **스키마**:
  - `SessionValidateRequest`: 토큰 검증 요청 (token: str)
  - `SessionValidateResponse`: 토큰 검증 응답 (ok, user_id, email, display_name, member_level, is_use, is_lock)

#### 1.5 Google 로그인 엔드포인트 수정
- **파일**: `apps/api/routes/auth_google.py`
- **주요 변경사항**:
  - `get_or_create_user()` 함수에 `last_login_at` 필드 추가
    - 새 사용자 생성 시: `last_login_at` 필드 포함
    - 기존 사용자 업데이트 시: `last_login_at` 필드 업데이트
  - `google_login()` 엔드포인트 응답 변경:
    - 기존: `{ access_token, email, name, is_use, is_lock, member_level }` (plain JSON)
    - 변경: `{ access_token, user_info_v2 }` (암호화된 토큰만 반환)
  - `user_info_v2` 토큰 생성 및 반환

#### 1.6 세션 검증 엔드포인트 추가
- **파일**: `apps/api/routes/auth.py`
- **엔드포인트**: `POST /v1/auth/validate-session`
- **기능**:
  - `user_info_v2` 토큰 검증
  - 토큰 만료 시간 확인
  - DB의 `last_login_at`과 토큰의 `last_login_at` 비교 (세션 무효화 감지)
  - 사용자 계정 상태 반환 (is_use, is_lock, member_level)

#### 1.7 프론트엔드 세션 관리 개선

##### 1.7.1 My 페이지 (my.html)
- **주요 변경사항**:
  - 로그인 성공 시: 암호화된 `user_info_v2` 토큰을 localStorage에 저장
  - `updateUIFromSession()` 함수 개선:
    - 세션 검증 API 호출하여 사용자 정보 가져오기
    - 세션 만료 시 자동 로그아웃 처리
    - 세션 만료 토스트 메시지 표시
  - `getUserInfo()` 함수: 세션 검증 API를 통한 비동기 사용자 정보 조회
  - 기존 `user_info` localStorage 키 제거

##### 1.7.2 Chat 페이지 (chat.html)
- **주요 변경사항**:
  - `getUserInfo()` 함수: 세션 검증 API를 통한 비동기 사용자 정보 조회
  - `checkAccountStatus()` 함수: 비동기 처리로 변경
  - 계정 상태 체크 로직 개선 (is_use, is_lock boolean 처리)

##### 1.7.3 세션 유틸리티 생성
- **파일**: `apps/web-html/static/js/session.js` (신규)
- **주요 함수**:
  - `getSessionToken()`: localStorage에서 user_info_v2 토큰 가져오기
  - `clearSessionToken()`: 세션 토큰 삭제
  - `ensureSessionValid()`: 세션 유효성 검사
  - `ensureChatAccessible()`: 채팅 접근 가능 여부 확인

### 2. 로그아웃 버튼 버그 패치 및 사용자 정보 표기 변경
- **커밋**: `6b2050a - [1] logo out 버튼 버그 패치 [2] 사용자 정보 표기 변경`
- **파일**: `apps/web-html/my.html`

#### 2.1 로그아웃 버튼 버그 패치
- 로그아웃 버튼 동작 개선

#### 2.2 사용자 정보 표기 변경
- `updateUIFromSession()` 함수 개선:
  - 세션 검증 실패 시 자동 로그아웃 처리
  - 세션 만료 토스트 메시지 표시
  - 상태 라벨 개선 (is_lock/is_use를 'Y'/'N' 문자열과 boolean 모두 대응)
  - 이메일 표시 우선순위 변경 (email 우선, 없으면 user_id)

### 3. 세션 검증 응답에 email 필드 추가
- **커밋**: `05fabff - fix: add email field to session validation response`
- **파일**: 
  - `apps/api/schemas/user_session.py`
  - `apps/api/routes/auth.py`

#### 3.1 스키마 수정
- `SessionValidateResponse`에 `email: str` 필드 추가

#### 3.2 응답 수정
- `validate_session()` 함수에서 email 필드 반환 추가
- DB의 email 또는 토큰의 email 사용

---

## 기술 스택

### 백엔드
- FastAPI
- Cryptography (Fernet 암호화)
- MongoDB (PyMongo)
- Pydantic v2

### 프론트엔드
- Vanilla JavaScript
- localStorage (암호화된 토큰 저장)
- Fetch API (세션 검증)

---

## 데이터베이스 스키마 변경

### users 컬렉션
```javascript
{
  _id: ObjectId,
  email: String,
  google_id: String,
  display_name: String,
  is_use: "Y" | "N",
  is_lock: "Y" | "N",
  member_level: Number,
  created_at: DateTime,
  updated_at: DateTime,
  last_login_at: DateTime  // 신규 추가
}
```

---

## API 엔드포인트

### 인증
- `POST /v1/auth/google` - Google OAuth 로그인
  - 요청: `{ token: string }`
  - 응답: `{ access_token: string, user_info_v2: string }` (암호화된 토큰)
  
- `POST /v1/auth/validate-session` - 세션 검증 (신규)
  - 요청: `{ token: string }` (user_info_v2 토큰)
  - 응답: `{ ok: bool, user_id: str, email: str, display_name: str, member_level: int, is_use: bool, is_lock: bool }`

---

## 주요 기능

### 1. 암호화된 토큰 시스템
- Fernet 대칭키 암호화 사용
- SHA256으로 시크릿 키 파생
- 토큰 만료 시간 관리 (기본 3일)
- 토큰 버전 관리 (version 필드)

### 2. 세션 무효화 감지
- DB의 `last_login_at`과 토큰의 `last_login_at` 비교
- 로그인 시마다 `last_login_at` 업데이트
- 이전 세션 토큰 자동 무효화

### 3. 프론트엔드 세션 관리
- 세션 만료 시 자동 로그아웃
- 세션 만료 토스트 메시지 표시
- 계정 상태 실시간 확인

---

## 환경 변수

```bash
# User Info Token V2
AUTH_USER_INFO_V2_SECRET=arcanaverse.ai.secret.v2  # 기본값
AUTH_USER_INFO_V2_EXPIRE_MINUTES=4320  # 기본값 (3일)

# MongoDB
MONGO_URI=mongodb+srv://...
MONGO_DB=arcanaverse

# Google OAuth
GOOGLE_CLIENT_ID=...

# JWT
JWT_SECRET=...
```

---

## 보안 개선 사항

1. **토큰 암호화**: 사용자 정보를 평문으로 저장하지 않고 암호화된 토큰으로 저장
2. **세션 무효화**: 로그인 시마다 이전 세션 토큰 자동 무효화
3. **토큰 만료**: 토큰 만료 시간 관리로 보안 강화
4. **세션 검증**: 모든 사용자 정보 조회 시 세션 검증 API 호출

---

## 향후 개선 사항

1. 리프레시 토큰 시스템 도입
2. 토큰 무효화 목록(블랙리스트) 관리
3. 세션 만료 전 자동 갱신 기능
4. 관리자 페이지에서 세션 관리 기능

---

## 참고 파일

- `apps/api/core/user_info_token.py` - 토큰 암호화/복호화 모듈
- `apps/api/schemas/user_session.py` - 세션 검증 스키마
- `apps/api/routes/auth.py` - 세션 검증 엔드포인트
- `apps/api/routes/auth_google.py` - Google 로그인 (토큰 생성)
- `apps/web-html/my.html` - My 페이지 (세션 관리)
- `apps/web-html/chat.html` - Chat 페이지 (세션 검증)
- `apps/web-html/static/js/session.js` - 세션 유틸리티

---

**작성일**: 2025-12-03  
**작성자**: novaworks-dev




