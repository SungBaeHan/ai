# 작업 로그 - 2025년 1월 27일

## 개요
사용자 인증 및 계정 관리 시스템 구축, MongoDB 연동, 프론트엔드 계정 상태 관리 기능 추가

---

## 주요 작업 내용

### 1. 디렉토리 구조 문서화
- **파일**: `docs/DIRECTORY_STRUCTURE.md`
- **내용**: 현재 프로젝트의 전체 디렉토리 구조를 마크다운 형식으로 정리
- **포함 내용**:
  - 전체 디렉토리 트리 구조
  - 주요 디렉토리별 설명 (adapters, apps, assets, data, src 등)

### 2. User CRUD API 구현
- **커밋**: `ef18836 - Add user CRUD API with clean schema and MongoDB integration`

#### 2.1 User Schema 생성
- **파일**: `apps/api/schemas/user.py`
- **내용**:
  - `UserBase`: 기본 사용자 모델 (email, google_id, display_name, is_use, is_lock, member_level)
  - `UserCreate`: 사용자 생성용 스키마
  - `UserUpdate`: 사용자 수정용 스키마
  - `UserOut`: 응답용 스키마 (id 포함)
  - MongoDB "Y"/"N" 값 사용을 위한 `YN` Literal 타입

#### 2.2 User CRUD 라우트 생성
- **파일**: `apps/api/routes/user.py`
- **엔드포인트**:
  - `POST /v1/users` - 사용자 생성
  - `GET /v1/users/{user_id}` - 사용자 조회
  - `PATCH /v1/users/{user_id}` - 사용자 수정
  - `DELETE /v1/users/{user_id}` - 사용자 삭제
- **기능**:
  - MongoDB users 컬렉션 연동
  - email, google_id 중복 확인
  - ObjectId 검증 및 에러 처리

#### 2.3 MongoDB Factory 함수 추가
- **파일**: `adapters/persistence/mongo/factory.py`
- **추가 함수**: `get_mongo_client()` - MongoDB 데이터베이스 인스턴스 반환

#### 2.4 Main.py 라우터 등록
- **파일**: `apps/api/main.py`
- **변경**: user router 등록 (`/v1/users`)

### 3. 의존성 추가
- **커밋**: `bf69e70`, `fe369da - Add pydantic[email] for EmailStr validation`
- **파일**: `requirements.txt`
- **내용**: `pydantic[email]` 추가 (EmailStr 타입 검증용)

### 4. Google OAuth 인증 개선
- **커밋**: `aa2a9a2 - Refactor Google OAuth endpoint with improved error handling and user management`
- **파일**: `apps/api/routes/auth_google.py`

#### 4.1 주요 변경사항
- MongoDB users 컬렉션 자동 연동
- `get_or_create_user()` 함수 구현:
  - email 또는 google_id로 기존 사용자 조회
  - 없으면 새 사용자 생성 (기본값: is_use='N', is_lock='Y', member_level=1)
  - 있으면 email/display_name/updated_at 갱신
- 응답에 계정 플래그 포함 (is_use, is_lock, member_level)
- 에러 처리 개선 및 코드 정리

### 5. 프론트엔드 계정 상태 관리

#### 5.1 My 페이지 (my.html) 개선
- **커밋**: `d31f451 - Improve login flow: store account status flags and add debugging logs`
- **파일**: `apps/web-html/my.html`

**변경사항**:
- `handleGoogleLogin()` 함수 개선:
  - 로그인 응답에서 `is_use`, `is_lock`, `member_level` 포함하여 저장
  - `picture` 필드 추가 저장
  - `setToken()` 공용 setter 사용
  - 디버깅 로그 추가
- `updateUI()` 함수 개선:
  - 이메일 아래에 계정 상태 표시 (정상/차단됨/사용 불가)

#### 5.2 Chat 페이지 (chat.html) 계정 상태 체크
- **파일**: `apps/web-html/chat.html`

**추가 기능**:
- `getUserInfo()`: 로컬스토리지에서 user_info 읽기
- `checkAccountStatus()`: 계정 상태 체크 함수
  - 반환값: `{ ok: boolean, reason: 'login' | 'lock' | 'use' | null }`
  - 디버깅 로그 추가
- `checkLoginAndSend()` 함수 수정:
  - 단순 로그인 체크 → 계정 상태 체크로 변경
  - 상태별 메시지 표시 (로그인 필요/계정 차단/사용 불가)
- 입력 필드 이벤트 수정:
  - `focus`/`click` 이벤트에서도 계정 상태 체크

### 6. MongoDB 데이터베이스 이름 변경
- **커밋**: `7794566 - Change default MongoDB database name from trpg_ai to arcanaverse`
- **파일**: `adapters/persistence/mongo/__init__.py`
- **변경**: 기본 데이터베이스 이름을 `"trpg_ai"`에서 `"arcanaverse"`로 변경

### 7. localStorage 키 버전 관리
- **커밋**: `36cc21e - Update USER_INFO_KEY from user_info to user_info_v2 for localStorage versioning`
- **파일**: 
  - `apps/web-html/my.html`
  - `apps/web-html/chat.html`
  - `scripts/patch_user_info_key_v2.sh` (신규)
- **변경**: `USER_INFO_KEY`를 `'user_info'`에서 `'user_info_v2'`로 변경
- **목적**: localStorage 버전 관리 및 기존 데이터와 분리

---

## 기술 스택

### 백엔드
- FastAPI
- MongoDB (PyMongo)
- Pydantic v2 (EmailStr 포함)
- PyJWT

### 프론트엔드
- Vanilla JavaScript
- Google Identity Services
- localStorage (토큰 및 사용자 정보 저장)

---

## 데이터베이스 스키마

### users 컬렉션
```javascript
{
  _id: ObjectId,
  email: String (EmailStr),
  google_id: String,
  display_name: String,
  is_use: "Y" | "N",  // 서비스 사용 가능 여부
  is_lock: "Y" | "N", // 계정 차단 여부
  member_level: Number, // 0=관리자, 1=일반유저
  created_at: DateTime,
  updated_at: DateTime
}
```

---

## API 엔드포인트

### 인증
- `POST /v1/auth/google` - Google OAuth 로그인
  - 요청: `{ token: string }`
  - 응답: `{ access_token, email, name, is_use, is_lock, member_level }`

### 사용자 관리
- `POST /v1/users` - 사용자 생성
- `GET /v1/users/{user_id}` - 사용자 조회
- `PATCH /v1/users/{user_id}` - 사용자 수정
- `DELETE /v1/users/{user_id}` - 사용자 삭제

---

## 주요 기능

### 1. 자동 사용자 생성
- Google 로그인 시 자동으로 MongoDB users 컬렉션에 레코드 생성
- 기존 사용자는 정보 업데이트만 수행

### 2. 계정 상태 관리
- `is_use`: 서비스 사용 가능 여부 (기본값: 'N')
- `is_lock`: 계정 차단 여부 (기본값: 'Y')
- `member_level`: 사용자 등급 (기본값: 1)

### 3. 프론트엔드 계정 상태 체크
- 채팅 페이지에서 계정 상태에 따라 접근 제어
- 상태별 적절한 메시지 표시

---

## 환경 변수

```bash
# MongoDB
MONGO_URI=mongodb+srv://...
MONGO_DB=arcanaverse  # 기본값

# Google OAuth
GOOGLE_CLIENT_ID=...

# JWT
JWT_SECRET=...
```

---

## 향후 개선 사항

1. 관리자 페이지에서 사용자 계정 상태 관리 UI
2. 계정 상태 변경 알림 기능
3. 세션/리프레시 토큰 구조로 확장
4. 사용자 권한 기반 접근 제어 강화

---

## 참고 파일

- `docs/DIRECTORY_STRUCTURE.md` - 프로젝트 디렉토리 구조
- `apps/api/schemas/user.py` - User 스키마 정의
- `apps/api/routes/user.py` - User CRUD API
- `apps/api/routes/auth_google.py` - Google OAuth 인증
- `apps/web-html/my.html` - My 페이지 (로그인/계정 정보)
- `apps/web-html/chat.html` - Chat 페이지 (계정 상태 체크)

---

**작성일**: 2025-01-27  
**작성자**: novaworks-dev




