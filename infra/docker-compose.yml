# ~/ai/infra/docker-compose.yml
services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - 127.0.0.1:6333:6333
      - 127.0.0.1:6334:6334
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - ../_volumes/qdrant_storage:/qdrant/storage
      - ../_volumes/qdrant_snapshots:/qdrant/snapshots
    # NOTE: disable default image HEALTHCHECK (curl not installed in container)
    healthcheck:
      disable: true  # 이미지에 내장된 curl 기반 HEALTHCHECK 완전 비활성화


  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ../_volumes/ollama_models:/root/.ollama
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      ollama serve &
      echo "Waiting for Ollama service to start..." &&
      for i in 1 2 3 4 5 6 7 8 9 10; do
        sleep 2 &&
        curl -f http://localhost:11434/api/tags >/dev/null 2>&1 && break || true
      done &&
      echo "Pulling Ollama models..." &&
      ollama pull trpg-gen || echo "Failed to pull trpg-gen (may already exist)" &&
      ollama pull trpg-polish || echo "Failed to pull trpg-polish (may already exist)" &&
      echo "Ollama models ready" &&
      wait
    # NOTE: disable default image HEALTHCHECK (curl not installed in container)
    healthcheck:
      disable: true  # ollama도 도커 HEALTHCHECK는 사용하지 않음

  api:
    build:
      context: ..                   # repo 루트(~/ai)
      dockerfile: docker/api.Dockerfile
    container_name: trpg-api
    restart: unless-stopped
    depends_on:
      - qdrant
      # 로컬 Ollama 모델을 실제로 쓸 경우 주석 해제
      # - ollama
    env_file:
      - ../.env
      - ./.env
    environment:
      # .env에서 PORT, JWT, CORS 등 읽어옴. 여긴 필요한 override만.
      QDRANT_URL: "http://qdrant:6333"
    ports:
      - "8000:8000"
    volumes:
      - ../apps:/app/apps:ro
      - ../packages:/app/packages:ro
      - ../adapters:/app/adapters:ro
      - ../src:/app/src:ro
      - ../assets:/app/assets:ro
      - ../data/json:/app/data/json:ro
    entrypoint: ["/app/infra/docker-entrypoint.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  web:
    build:
      context: ..                   # repo 루트(~/ai)
      dockerfile: docker/nginx.Dockerfile
    container_name: trpg-web
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "80:80"
    volumes:
      - ../apps/web-html:/usr/share/nginx/html
      - ../assets:/usr/share/nginx/html/assets:ro

volumes:
  qdrant_storage:
    driver: local
  ollama_models:
    driver: local
