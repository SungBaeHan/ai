# ~/ai/infra/docker-compose.yml
services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - 127.0.0.1:6333:6333
      - 127.0.0.1:6334:6334
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - ../_volumes/qdrant_storage:/qdrant/storage


  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ../_volumes/ollama_models:/root/.ollama
    entrypoint: ["/bin/sh", "-lc", "ollama serve"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:11434/api/tags || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  api:
    build:
      context: ..                   # repo 루트(~/ai)
      dockerfile: docker/api.Dockerfile
    container_name: trpg-api
    restart: unless-stopped
    depends_on:
      qdrant:
        condition: service_healthy
      # 로컬 Ollama 모델을 실제로 쓸 경우 주석 해제
      # ollama:
      #   condition: service_healthy
    env_file:
      - ../.env                     # 루트 .env만 사용
    environment:
      # .env에서 PORT, JWT, CORS 등 읽어옴. 여긴 필요한 override만.
      QDRANT_URL: "http://qdrant:6333"
    ports:
      - "8000:8000"
    volumes:
      - ../apps:/app/apps:ro
      - ../packages:/app/packages:ro
      - ../adapters:/app/adapters:ro
      - ../src:/app/src:ro
      - ../assets:/app/assets:ro
      - ../data/json:/app/data/json:ro
    entrypoint: ["/app/infra/docker-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 20

  web:
    build:
      context: ..                   # repo 루트(~/ai)
      dockerfile: docker/nginx.Dockerfile
    container_name: trpg-web
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "8080:80"
    volumes:
      - ../apps/web-html:/usr/share/nginx/html
      - ../assets:/usr/share/nginx/html/assets:ro

volumes:
  qdrant_storage:
    driver: local
  ollama_models:
    driver: local
