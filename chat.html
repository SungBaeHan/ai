<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<title>RAG Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>

  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 780px; margin: 40px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .row { display:flex; gap:8px; align-items:center; margin:6px 0; }
  select, input, button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; }
  #log { border: 1px solid #ddd; border-radius: 12px; padding: 16px; min-height: 320px; max-height: 60vh; overflow: auto; background: rgba(0,0,0,0.03); }
  .me { color: #444; margin: 8px 0; white-space: pre-wrap; }
  .bot { color: #0a5; margin: 8px 0; white-space: pre-wrap; }
  form { display: flex; gap: 8px; margin-top: 12px; }
  input[type="text"] { flex: 1; }
  button { background: #0a5; color: white; border: none; cursor: pointer; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .hint { font-size: 12px; color: #666; margin-top: 8px; }

  /* ===== ChatGPT ìŠ¤íƒ€ì¼ ì…ë ¥ ì»´í¬ì € ===== */
  :root{
    --send: 40px;     /* ì „ì†¡ ë²„íŠ¼ ì§€ë¦„ */
    --gap:  12px;     /* ì¢Œìš° ì—¬ë°± */
  }
  /* í•˜ë‹¨ ê³ ì • ëŠë‚Œì˜ ë˜í¼(ì„ íƒ) */
  /* fixed ëª¨ë“œ */
  .composer-wrap.fixed {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 10;
    background: linear-gradient(180deg, rgba(255,255,255,0), #fff 24%, #fff 100%);
    padding: 12px 16px calc(env(safe-area-inset-bottom) + 12px);
  }
  /* ë³¸ë¬¸ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ ë°”ë‹¥ ì—¬ë°± ì¶”ê°€ */
  body { padding-bottom: 140px; } /* ì»´í¬ì € ë†’ì´ì— ë§ì¶° ì¡°ì ˆ */

  /* í° ë¼ìš´ë“œ ë°•ìŠ¤ */
  .composer-wrap{
    position: sticky; bottom: 0; z-index: 10;
    background: linear-gradient(180deg, rgba(255,255,255,0), var(--bg, #fff) 24%, var(--bg, #fff) 100%);
    padding-top: 12px;
    margin-top: auto; /* â¬…ï¸ ë°”ë‹¥ ë°€ì°©ì˜ í•µì‹¬ */
    padding-bottom: calc(env(safe-area-inset-bottom) + 8px);
  }

  .composer{
    position: relative;
    display:flex; align-items:flex-end; gap:12px;
    border:1px solid var(--border, #e5e7eb);
    border-radius: var(--radius, 20px);
    /* â¬‡ï¸ ì˜¤ë¥¸ìª½ íŒ¨ë”©ì„ ë²„íŠ¼ í¬ê¸° + ì—¬ë°±ë§Œí¼ í™•ë³´ */
    padding: 12px calc(var(--send) + 16px) 12px 44px;
    background: var(--bg, #fff);
    box-shadow: var(--shadow, 0 2px 10px rgba(0,0,0,.06));
    min-height: calc(var(--send) + 24px); 
    box-sizing: border-box;
  }

  /* ì»´í¬ì € ë‚´ë¶€ ë²„íŠ¼ì€ ê¸°ë³¸ ë°°ê²½ ì œê±° */
  .composer button{ background: transparent; border: 0; }

  /* í…ìŠ¤íŠ¸ ì˜ì—­: íˆ¬ëª… ë°°ê²½, ìë™ í™•ì¥, ìµœëŒ€ 45vh */
  #chat-input{
    flex:1; border:none; outline:none; resize:none; background:transparent;
    font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    min-height:28px; max-height:45vh; overflow-y:auto; padding:0; margin:0;
  }
  #chat-input::placeholder{ color:#9ca3af; }
  #chat-input.collapsed{ height:28px; overflow:hidden; }

  /* í¬ì»¤ìŠ¤ ì‹œ ê°•ì¡° */
  .composer:focus-within{
    border-color:#93c5fd;
    box-shadow: 0 0 0 3px rgba(59,130,246,.12), var(--shadow, 0 2px 10px rgba(0,0,0,.06));
  }

  /* ì™¼ìª½ + ë²„íŠ¼(ì•„ì´ì½˜ ë²„íŠ¼) â€” í•„ìš” ì—†ìœ¼ë©´ ìˆ¨ê²¨ë„ ë¨ */
  /* ì™¼ìª½ + ë²„íŠ¼ */
  .attach-btn{
    position:absolute; left: var(--gap); top:50%;
    transform: translateY(-50%);
    width:28px; height:28px; border-radius:999px;
    color: var(--muted, #6b7280);
    display:grid; place-items:center; cursor:pointer;
    left: var(--gap); bottom: 12px; top:auto; transform:none; 
  }
  .attach-btn:hover{ background:rgba(0,0,0,.04); }

  /* ì˜¤ë¥¸ìª½ ë‘¥ê·¼ ì „ì†¡ FAB ë²„íŠ¼ */
  #send-btn{
    position:absolute;
    right: var(--gap);
    bottom: 12px;          /* â¬…ï¸ ì•„ë˜ìª½ ê³ ì • */
    top: auto;
    transform: none;
    width: var(--send);
    height: var(--send);
    border-radius: 9999px;
    background: var(--blue, #0ea5e9);
    color:#fff; display:grid; place-items:center;
    box-shadow:0 2px 6px rgba(14,165,233,.3);
    cursor:pointer;
  }
  #send-btn:active{ transform: translateY(1px); }  /* ëˆŒë €ì„ ë•Œë§Œ ì‚´ì§ */

  /* ì‚¬ìš©ì ë©”ì‹œì§€ ì¤„ë°”ê¿ˆ í‘œì‹œ(ì´ë¯¸ ìˆìœ¼ë‚˜ í•©ì³ì„œ í•œ ì¤„ë¡œ) */
  .me { color:#444; margin:8px 0; white-space:pre-wrap; }

  html, body { height: 100%; }
  .page { min-height: 100dvh; display: flex; flex-direction: column; }
  #log { flex: 1 1 auto; }

  /* ìœ„ìª½ ì½˜í…ì¸ ê°€ ëª¨ìë„ ë•Œë„ ì»´í¬ì €ë¥¼ ë°”ë‹¥ìœ¼ë¡œ ë°€ì–´ë‚´ê¸° */
  .composer-wrap { margin-top: auto; }

  /* iOS í•˜ë‹¨ ì•ˆì „ì˜ì—­ ì—¬ë°± (ì„ íƒ) */
  .composer-wrap { padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }


</style>

<main class="page">
  
<h1>RAG Chat</h1>

<div class="row">
  <label>ëª¨ë“œ</label>
  <select id="mode">
    <option value="qa" selected>QA</option>
    <option value="trpg">TRPG</option>
  </select>
  <label>ëª¨ë¸</label>
  <input id="model" value="llama3.1" size="12" />
  <label>Temp</label>
  <input id="temp" type="number" step="0.1" min="0" max="1.5" value="0.7" style="width:80px" />
</div>

<div id="log" aria-live="polite"></div>

<div class="row">
  <button id="clear" style="background:#777">ëŒ€í™” ì´ˆê¸°í™”</button>
</div>
<div class="hint">API: <code>http://localhost:8000/chat</code></div>

<!-- ë°˜ë“œì‹œ ë§ˆì§€ë§‰ -->
<div class="composer-wrap">
  <form id="f" class="composer" autocomplete="off">
    <button type="button" id="attach-btn" class="attach-btn">ï¼‹</button>
    <textarea id="chat-input" class="collapsed" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦"></textarea>
    <button id="send-btn" type="submit" aria-label="ë©”ì‹œì§€ ì „ì†¡">â–¶</button>
  </form>
</div>
</main>

<script>
  const API = 'http://localhost:8000';
  const log   = document.getElementById('log');
  const mode  = document.getElementById('mode');
  const model = document.getElementById('model');
  const temp  = document.getElementById('temp');
  const clearBtn = document.getElementById('clear');
  
  const form = document.getElementById('f');
  const ta   = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  
  // ê¸°ì¡´: const MAX_PX = 220;
  let MAX_PX = Math.round(window.innerHeight * 0.45);
  function autoResize(){
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, MAX_PX) + 'px';
  }
  window.addEventListener('resize', () => {
    MAX_PX = Math.round(window.innerHeight * 0.45);
    if (!ta.classList.contains('collapsed')) autoResize();
  });

  function add(type, text){
    const div = document.createElement('div');
    div.className = type;
    div.textContent = (type === 'me' ? 'ğŸ™‚ ' : 'ğŸ¤– ') + text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }
  
  async function callChat(message){
    const payload = {
      message,
      mode: mode.value,
      model: model.value,
      temperature: parseFloat(temp.value || "0.7"),
    };
    const res = await fetch(API + '/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
      credentials: 'include'
    });
    if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
    return res.json();
  }
  
  // --- ìë™ ë¦¬ì‚¬ì´ì¦ˆ & ì»´í¬ì € UX ---
  function autoResize(){
    ta.style.height = 'auto';
    const next = Math.min(ta.scrollHeight, MAX_PX);
    ta.style.height = next + 'px';
  }
  function collapseIfEmpty(){
    if(!ta.value.trim()){
      ta.classList.add('collapsed');
      ta.style.height = '';
    }
  }
  
  let busy = false;

  // --- ì „ì†¡ ë¡œì§ ---
  async function send(){
    if (busy) return;                 // ì „ì†¡ ì¤‘ì´ë©´ ë¬´ì‹œ
    const text = ta.value.trim();
    if (!text) return;

    busy = true;
    add('me', text);

    // ì…ë ¥ì°½ ë¦¬ì…‹ & ì ‘ê¸°
    ta.value = '';
    ta.style.height = '';
    ta.classList.add('collapsed');
    autoResize();

    sendBtn.disabled = true;
    add('bot', 'ìƒê°ì¤‘â€¦');
    const placeholder = log.lastChild;  // ë°©ê¸ˆ ì¶”ê°€í•œ "ìƒê°ì¤‘â€¦" ë…¸ë“œ

    try {
      const data = await callChat(text);
      placeholder.textContent = 'ğŸ¤– ' + (data.answer || '(ì‘ë‹µ ì—†ìŒ)');
    } catch (err) {
      placeholder.textContent = 'ğŸ¤– ì—ëŸ¬: ' + (err?.message || String(err));
    } finally {
      sendBtn.disabled = false;
      ta.focus();
      busy = false;
    }
  }
  
  // í¼ ì œì¶œ(ë²„íŠ¼ í´ë¦­/ì—”í„°) ì²˜ë¦¬
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    send();
  });
  
  // ì…ë ¥ í™•ì¥
  ta.addEventListener('input', autoResize);
  
  // í¬ì»¤ìŠ¤ ì‹œ í¼ì¹˜ê¸°
  ta.addEventListener('focus', () => {
    ta.classList.remove('collapsed');
    autoResize();
  });
  
  // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ë¹„ì–´ìˆìœ¼ë©´ ì ‘ê¸°
  ta.addEventListener('blur', collapseIfEmpty);
  
  // IME(í•œê¸€ ì¡°í•©) ì¤‘ ì—”í„° ì „ì†¡ ë°©ì§€ + Enter ì „ì†¡ / Shift+Enter ì¤„ë°”ê¿ˆ
  let composing = false;
  ta.addEventListener('compositionstart', () => composing = true);
  ta.addEventListener('compositionend',   () => composing = false);
  ta.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey){
      if(composing || e.isComposing) return; // ì¡°í•© ì¤‘ì´ë©´ ë¬´ì‹œ
      e.preventDefault();
      send();
    }
  });
  
  // ëŒ€í™” ì´ˆê¸°í™”
  clearBtn.onclick = async ()=>{
    try {
      await fetch(API + '/reset', {method:'POST', credentials: 'include'});
      add('bot', '(ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤)');
    } catch(e) {
      add('bot', 'ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
    }
  };
  
  // ì´ˆê¸° ìƒíƒœ ì ‘í˜ ìœ ì§€
  ta.classList.add('collapsed');
  </script>
</html>