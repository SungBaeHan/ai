<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Â· TRPG</title>
<style>
  :root{ --bg:#0b0f14; --ink:#e5ecf3; --sub:#a7bed6; --accent:#60a5fa; --border:#1f2a36; }
  *{box-sizing:border-box} body{margin:0; background:var(--bg); color:var(--ink); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .page{min-height:100dvh; display:flex; flex-direction:column; position:relative;}
  .hero{position:fixed; inset:0; z-index:-2; background:center/cover no-repeat; filter: blur(14px) brightness(.45); transform:scale(1.04);}
  .veil{position:fixed; inset:0; z-index:-1; background: radial-gradient(ellipse at 50% 20%, rgba(0,0,0,.12), rgba(0,0,0,.7) 60%, rgba(0,0,0,.9));}
  header{ display:flex; align-items:center; gap:10px; padding:12px 14px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.7), rgba(11,15,20,0)); }
  header img.avatar{ width:28px; height:28px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,.2);}
  header .title{ font-weight:700; letter-spacing:.2px; }
  a.back{ color:#cfe4ff; text-decoration:none; padding:6px 8px; border-radius:8px; background:rgba(0,0,0,.25); border:1px solid var(--border);}
  main{ flex:1 1 auto; padding:10px 12px 94px; }
  .day{ align-self:center; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:999px; color:#cfe4ff; font-size:12px; margin:8px 0; border:1px solid var(--border); }
  .row{ display:flex; gap:10px; margin:10px 0; align-items:flex-end; }
  .row .bubble{ max-width: 76vw; padding:12px 14px; border-radius:16px; line-height:1.6; box-shadow:0 6px 18px rgba(0,0,0,.35); }
  .row.me{ justify-content:flex-end; }
  .row.me .bubble{ background: linear-gradient(180deg, rgba(96,165,250,.15), rgba(96,165,250,.08)); border:1px solid rgba(96,165,250,.35); }
  .row.ai .bubble{ background: rgba(10,14,18,.78); border:1px solid var(--border); }
  .row img.avatar{ width:32px; height:32px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,.2);}
  .inputbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(0deg, rgba(11,15,20,1), rgba(11,15,20,.92)); border-top:1px solid var(--border); padding:10px 12px calc(env(safe-area-inset-bottom)+10px); display:flex; gap:8px; }
  .inputbar textarea{ flex:1 1 auto; resize:none; border:1px solid var(--border); background:rgba(15,20,26,.8); color:var(--ink); border-radius:12px; min-height:42px; max-height:120px; padding:10px 12px; }
  .inputbar button{ background: var(--accent); color:#05223e; border:none; border-radius:12px; padding: 0 14px; font-weight:700; min-width:74px; }
  .choices{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0 42px; }
  .choice{ background:rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.35); color:#cfe4ff; padding:8px 10px; border-radius:12px; cursor:pointer; }
  .hint{ color:var(--sub); font-size:12px; }

  /* --- profile card in first message --- */
  .profile { width: 100%; }
  .profile-hero{
    height: 200px; border-radius:12px;
    background-size:cover; background-position:center;
    margin:-6px -6px 8px -6px; filter: brightness(.9);
  }
  .profile-body{ display:flex; flex-direction:column; gap:6px; }
  .profile-title{ font-weight:700; opacity:.9; }
  .profile-name{ font-size:18px; font-weight:800; letter-spacing:.2px; }
  .profile-arch{ font-size:13px; color:var(--sub); }
  .profile-bio{ font-size:14px; color:#cfe4ff; line-height:1.6; }
  .profile-tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top:2px; }
  .profile-tags span{
    font-size:12px; color:#cfe4ff; background:rgba(96,165,250,.15);
    border:1px solid rgba(96,165,250,.35); border-radius:999px; padding:4px 8px;
  }

</style>

<body class="page">
  <div id="hero" class="hero"></div>
  <div class="veil"></div>

  <header>
    <a class="back" href="home.html">â† í™ˆ</a>
    <img id="avatar" class="avatar" alt="">
    <div id="title" class="title">ì„¸ì…˜</div>
  </header>

  <main id="log"><div class="day">ì˜¤ëŠ˜</div></main>

  <div class="inputbar">
    <textarea id="input" placeholder="ë©”ì‹œì§€ ì…ë ¥..."></textarea>
    <button id="send">ë³´ë‚´ê¸°</button>
  </div>

<script>
  // ğŸ‘‰ í•„ìš”í•˜ë©´ /json/characters.json ëŒ€ì‹  ê°™ì€ ë””ë ‰í† ë¦¬ì˜ characters.jsonë„ íƒìƒ‰
  const CANDIDATES = ['characters.json','json/characters.json','/json/characters.json'];
  const API = ''; // same-origin

  function qs(key){ return new URL(location.href).searchParams.get(key); }
  function resolvePath(p){ if(!p) return ''; if(/^https?:|^data:/.test(p)) return p; return p.replace(/^\/+/, ''); }

  function profileHTML(ch){
    const tags = (ch.tags||[]).map(t=>`<span>${t}</span>`).join('');
    const bio  = ch.longBio || ch.shortBio || '';
    return `
      <div class="profile">
        <div class="profile-hero" style="background-image:url('${resolvePath(ch.image||'')}')"></div>
        <div class="profile-body">
          <div class="profile-title">ì†Œê°œ</div>
          <div class="profile-name">${ch.name||''}</div>
          <div class="profile-arch">${ch.archetype||''}</div>
          <div class="profile-bio">${bio}</div>
          ${tags ? `<div class="profile-tags">${tags}</div>`:''}
        </div>
      </div>`;
  }

  function appendHTML(kind, html, avatar){
    const wrap = row(kind, html, avatar);
    // md() ë³€í™˜ ì—†ì´ raw HTML ê·¸ëŒ€ë¡œ
    wrap.querySelector('.bubble').innerHTML = html;
    document.getElementById('log').appendChild(wrap);
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  async function loadFirst(paths){
    for(const p of paths){
      try{ const r = await fetch(p); if(!r.ok) throw new Error(r.statusText); return await r.json(); }
      catch(_){}
    }
    // ì•„ì£¼ ìµœì†Œí•œì˜ í´ë°±
    return {characters:[{id:'char_01',name:'ë™ë£Œ',image:'',greeting:'ì•ˆë…•! ê°™ì´ ì‹œì‘í•´ë³´ì.'}]};
  }

  function md(text){
    return (text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>');
  }

  function row(kind, html, avatarSrc){
    const me = kind==='me';
    const wrap = document.createElement('div');
    wrap.className = 'row ' + (me?'me':'ai');
    if(!me){
      const av = document.createElement('img'); av.className='avatar'; av.src = resolvePath(avatarSrc||''); av.alt=''; wrap.appendChild(av);
    }
    const b = document.createElement('div'); b.className='bubble'; b.innerHTML = html; wrap.appendChild(b);
    return wrap;
  }

  function extractChoices(answer){
    const out = []; let seen = new Set(); let inChoices = false;
    for(const raw of (answer||'').split(/\r?\n/)){
      const line = raw.trim();
      if(!inChoices){ if(/\[ì„ íƒì§€\]/.test(line)) inChoices = true; continue; }
      if(!line) break;
      const m = line.match(/^(?:[-â€¢]|\(?\d+\)?[.)])\s*(.+)$|^\((.+)\)$|^\[(.+)\]$/);
      const t = (m ? (m[1]||m[2]||m[3]) : line).replace(/^[\(\[]|[\)\]]$/g,'');
      if(t && !seen.has(t)){ out.push(t); seen.add(t); }
      if(out.length>=3) break;
    }
    return out;
  }

  (async function init(){
    const charId = qs('character') || sessionStorage.getItem('lastChar') || 'char_01';
    const data = await loadFirst(CANDIDATES);
    const byId = Object.fromEntries((data.characters||[]).map(c=>[c.id,c]));
    const ch = byId[charId] || (data.characters||[])[0];

    // UI ì„¸íŒ…
    document.getElementById('title').textContent = (ch.name||'ì„¸ì…˜');
    document.getElementById('avatar').src = resolvePath(ch.image||'');
    document.getElementById('hero').style.backgroundImage = 'url(' + resolvePath(ch.image||'') + ')';
    sessionStorage.setItem('lastChar', ch.id);

    const log   = document.getElementById('log');
    const input = document.getElementById('input');
    const send  = document.getElementById('send');

    function append(kind, text){ log.appendChild(row(kind, md(text), ch.image)); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); }

    // 1) ìºë¦­í„° ì „ì²´ í”„ë¡œí•„ ë¨¼ì € ë…¸ì¶œ
    appendHTML('ai', profileHTML(ch), ch.image);

    // 2) ë°°ê²½ ì„¤ëª… ì¶œë ¥ (longBio ìš°ì„ )
    if(ch.longBio || ch.shortBio){
      append('ai', `ë°°ê²½\n${ch.longBio || ch.shortBio}`);
    }

    // 3) ì´ì–´ì„œ ìºë¦­í„° ê³ ìœ  greeting ì¶œë ¥
    if(ch.greeting){
      append('ai', ch.greeting);
    }

    // ì²« ì „ì†¡ë§Œ ìºë¦­í„° í˜ë¥´ì†Œë‚˜ë¥¼ ë©”ì‹œì§€ ì•ì— ì£¼ì…(ë°±ì—”ë“œ ìˆ˜ì • ì—†ì´ ìºë¦­í„° í†¤ ë°˜ì˜)
    let injected = false;

    async function callChat(message){
      let msg = message;
      if(!injected){
        const persona =
          '[ìºë¦­í„° ë™ë£Œ]\n'
          + `- ì´ë¦„: ${ch.name||''}\n`
          + `- ì„±ê²©/ì—­í• : ${ch.archetype||''}\n`
          + `- ë°°ê²½ìš”ì•½: ${(ch.longBio||ch.shortBio||'')}\n`
          + `- íƒœê·¸: ${(ch.tags||[]).join(', ')}\n`
          + '- ë§íˆ¬: êµ¬ì–´ì²´, ê°„ê²°, 1ì¸ì¹­.\n\n';
        msg = persona + message;
        injected = true;
      }
      const payload = {
        message: msg,           // â† í˜ë¥´ì†Œë‚˜+ì‚¬ìš©ì ì…ë ¥
        mode: 'trpg',           // â† TRPG ëª¨ë“œ ê³ ì •
        model: 'trpg-gen',
        temperature: 0.9,
        top_p: 0.95
      };
      const r = await fetch(API + '/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload), credentials:'include'
      });
      if(!r.ok) throw new Error(r.statusText);
      return await r.json();
    }

    async function handleSend(){
      const t = (input.value||'').trim(); if(!t) return;
      append('me', t); input.value='';
      const ph = row('ai','<span class="hint">ìƒê° ì¤‘â€¦</span>', ch.image); log.appendChild(ph);
      try{
        const data = await callChat(t);
        const ans = data.answer || '';
        // ë³¸ë¬¸
        ph.querySelector('.bubble').innerHTML = md(ans.split('\n\n[ì„ íƒì§€]')[0]||ans);
        // ì„ íƒì§€ ë²„íŠ¼
        const choices = extractChoices(ans);
        if(choices.length){
          const bar = document.createElement('div'); bar.className='choices';
          for(const c of choices){
            const btn = document.createElement('button'); btn.className='choice'; btn.textContent = c;
            btn.onclick = ()=>{ input.value = c; handleSend(); };
            bar.appendChild(btn);
          }
          log.appendChild(bar);
        }
      }catch(e){
        ph.querySelector('.bubble').innerHTML = 'ì—ëŸ¬: ' + (e?.message || String(e));
      }finally{
        window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
      }
    }

    send.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });
  })();
</script>
</body>
</html>
