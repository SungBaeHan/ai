<!-- ========================================
     apps/web-html/world.html â€” ì„¸ê³„ê´€ ìƒì„¸(ì±„íŒ…) í™”ë©´
     - URL ?world=1 ë˜ëŠ” ?world_id=1 ì§€ì›
     - /v1/worlds/:id ë‹¨ê±´ í˜¸ì¶œí•´ì„œ ë Œë”
     - ì´ë¯¸ì§€ ê²½ë¡œ ë³´ì •(resolvePath)ë¡œ /assets/world/â€¦ ë³´ì¥
     - ìºë¦­í„°ì™€ ë‹¬ë¦¬ ì¸ì‚¬ë§ ì—†ì´ ììœ ë¡­ê²Œ ì±„íŒ… ì‹œì‘
     ======================================== -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>World Chat â€¢ TRPG</title>
  <script>
    // ASSET_BASE_URL ê°•ì œ ì„¤ì • (r2.dev ì°¨ë‹¨)
    window.__ASSET_BASE_URL__ = 'https://img.arcanaverse.ai';
  </script>
  <script src="/js/config.js"></script>
  <script>
    // Cloudflare Pages ë°°í¬ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ê¸°ë³¸ API ì—”ë“œí¬ì¸íŠ¸
    window.API_BASE_URL = 'https://api.arcanaverse.ai';
    window.API_BASE = 'https://api.arcanaverse.ai';  // API_BASEë„ í•¨ê»˜ ì„¤ì •
  </script>
  <style>
    :root { color-scheme: dark; } /* ë‹¤í¬ í…Œë§ˆ íŒíŠ¸ */
    html, body { height:100%; margin:0; overflow:hidden; }
    body { background:#0b0f14; color:#e5e7eb; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,'Apple SD Gothic Neo','Malgun Gothic',sans-serif; display:flex; flex-direction:column; }
    .topbar-wrap { display:flex; justify-content:center; border-bottom:1px solid #1b2430; background:#0e141c; position:sticky; top:0; z-index:20; flex-shrink:0; }
    .topbar { width:100%; max-width:980px; display:flex; align-items:center; gap:10px; padding:10px 14px; justify-content:space-between; }
    .topbar-left { display:flex; align-items:center; gap:10px; flex:1; }
    .topbar-right { display:flex; align-items:center; gap:10px; }
    .back { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid #223042; background:#0f172a; color:#cbd5e1; cursor:pointer; }
    .title { font-weight:700; font-size:15px; color:#f1f5f9; }
    .persona-btn { padding:6px 12px; border-radius:8px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; font-size:13px; cursor:pointer; transition:all .15s ease; }
    .persona-btn:hover { background:#334155; border-color:#475569; }
    .header-persona-badge { display:flex; align-items:center; gap:8px; padding:4px 8px; border-radius:8px; border:1px solid #334155; background:#1f2937; cursor:pointer; transition:all .15s ease; }
    .header-persona-badge:hover { background:#334155; border-color:#475569; }
    .header-persona-avatar { width:24px; height:24px; border-radius:50%; object-fit:cover; box-shadow:0 0 4px rgba(0,0,0,.3); }
    .header-persona-name { font-size:13px; color:#e5e7eb; }
    .chat-page-content { flex:1 1 auto; min-height:0; display:flex; flex-direction:column; overflow:hidden; }
    .chat-top-section { flex-shrink:0; padding-top:12px; }
    .hero { position:relative; margin:18px auto; max-width:980px; height:220px; min-height:220px; overflow:hidden; }
    .hero img { width:100%; height:100%; object-fit:cover; border-radius:14px; border:1px solid #1f2937; box-shadow:0 10px 28px rgba(0,0,0,.35); display:block; }
    .panel { max-width:980px; margin:10px auto 18px; background:#0f172a; border:1px solid #1e293b; border-radius:12px; padding:12px 14px; }
    .chips { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip { padding:3px 8px; font-size:11px; border-radius:999px; border:1px solid #334155; color:#a5b4fc; background:#0b1220; }
    .hint { font-size:12px; color:#9ca3af; margin-top:6px; }
    .chat-container { flex:1 1 auto; min-height:0; overflow-y:auto; display:flex; flex-direction:column; scrollbar-width:none; -ms-overflow-style:none; }
    .chat-container::-webkit-scrollbar { width:0; height:0; }
    .chat { max-width:980px; margin:0 auto; padding:14px 4px; width:100%; flex:1; }
    .msg { display:flex; align-items:flex-end; gap:8px; margin:14px 0; animation:fadeInUp .35s ease; }
    .msg.me { justify-content:flex-end; }
    .avatar { width:42px; height:42px; border-radius:50%; object-fit:cover; box-shadow:0 0 6px rgba(0,0,0,.4); }
    .bubble { background:#111827; border:1px solid #1f2937; padding:10px 14px; border-radius:14px; white-space:pre-wrap; line-height:1.6; max-width:70%; }
    .me .bubble { background:rgba(63,131,248,0.25); border-color:#334155; }
    .user-persona-badge { display:flex; align-items:center; padding:0; }
    .user-persona-avatar { width:38px; height:38px; border-radius:50%; object-fit:cover; box-shadow:0 0 4px rgba(0,0,0,.3); }
    .user-persona-name { display:none !important; } /* ì´ë¦„ ì œê±° - ì•„ì´ì½˜ë§Œ í‘œì‹œ */
    .inputBar { border-top:1px solid #1b2430; background:#0e141c; padding:12px; flex-shrink:0; }
    .inputIn { max-width:980px; margin:0 auto; display:flex; gap:8px; }
    textarea { flex:1; resize:none; background:#0b1220; border:1px solid #1f2937; border-radius:10px; color:#e5e7eb; padding:10px 12px; min-height:44px; }
    button { padding:0 14px; border-radius:10px; border:1px solid #334155; background:#111827; color:#c7d2fe; height:44px; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .bg { position:fixed; inset:0; background-position:center; background-size:cover; opacity:.4; filter:blur(1.5px) brightness(0.9); z-index:-1; transition:filter .5s ease, opacity .5s ease; }
    .debug { max-width:980px; margin:6px auto 0; font-size:12px; color:#93c5fd; opacity:.9; white-space:pre-wrap; }
    /* toast layer */
    .toast { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition:opacity .18s ease; z-index:50; }
    .toast.show { opacity:1; }
    .toast .box { pointer-events:auto; min-width:200px; max-width:80vw; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; padding:14px 18px; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.45); text-align:center; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    
    /* persona modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .modal-backdrop.show { opacity:1; pointer-events:auto; }
    .modal { background:#111827; border:1px solid #1f2937; border-radius:12px; width:90%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #1f2937; }
    .modal-header h2 { margin:0; font-size:18px; color:#f3f4f6; }
    .modal-close { background:none; border:none; color:#94a3b8; font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; }
    .modal-close:hover { color:#e5e7eb; }
    .modal-body { padding:20px; max-height:60vh; overflow-y:auto; }
    
    /* Persona Card Styles (from personas.html) */
    .persona-list { display:flex; flex-direction:column; gap:12px; }
    .persona-card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; transition:all .15s ease; cursor:pointer; }
    .persona-card:hover { border-color:#3b82f6; }
    .persona-card.selected { border-color:#3b82f6; border-width:2px; background:#1e3a8a; }
    .persona-card.default { border-color:#3b82f6; background:#1e3a8a; }
    .persona-card-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .persona-avatar { width:64px; height:64px; border-radius:8px; background:#1f2937; object-fit:cover; border:2px solid #334155; }
    .persona-info { flex:1; }
    .persona-name { font-size:16px; font-weight:600; color:#f3f4f6; margin-bottom:4px; }
    .persona-badge { display:inline-block; padding:2px 8px; background:#3b82f6; color:#fff; border-radius:4px; font-size:11px; font-weight:600; margin-right:6px; }
    .persona-gender { font-size:12px; color:#94a3b8; }
    .persona-bio { font-size:13px; color:#cbd5e1; line-height:1.5; margin-bottom:12px; max-height:60px; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
    .persona-selected-info { padding:12px; background:#1e293b; border-radius:8px; margin-top:12px; font-size:13px; color:#cbd5e1; }
    .persona-selected-info strong { color:#3b82f6; }
    .modal-footer { padding:20px; border-top:1px solid #1f2937; flex-shrink:0; }
    .btn-modal { padding:10px 20px; border-radius:6px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; font-size:14px; font-weight:500; cursor:pointer; transition:all .15s ease; }
    .btn-modal:hover { background:#334155; }
    .btn-modal.primary { background:#3b82f6; border-color:#2563eb; color:#fff; }
    .btn-modal.primary:hover { background:#2563eb; }
    .modal-loading { text-align:center; padding:40px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div> <!-- íë¦¼ ë°°ê²½ -->

  <div class="topbar-wrap">
    <div class="topbar">
      <div class="topbar-left">
        <button id="backBtn" class="back" title="ë’¤ë¡œ ê°€ê¸°">â†</button> <!-- ë’¤ë¡œê°€ê¸° -->
        <div class="title" id="title">ë¡œë”© ì¤‘â€¦</div>                   <!-- ì„¸ê³„ê´€ ì´ë¦„ -->
      </div>
      <div class="topbar-right">
        <div id="headerPersonaBadge" class="header-persona-badge" style="display:none;" title="í˜ë¥´ì¡°ë‚˜ ì„¤ì •" onclick="openPersonaModal()">
          <img id="headerPersonaAvatar" class="header-persona-avatar" src="" alt="" />
          <span id="headerPersonaName" class="header-persona-name"></span>
        </div>
        <button id="personaBtn" class="persona-btn" title="í˜ë¥´ì¡°ë‚˜ ì„¤ì •" style="display:none;">Persona</button> <!-- í˜ë¥´ì¡°ë‚˜ ë²„íŠ¼ (fallback) -->
      </div>
    </div>
  </div>

  <div class="chat-page-content">
    <div class="chat-top-section">
      <div class="hero"><img id="hero" alt="cover" src="/assets/img/placeholder.jpg" /></div> <!-- íˆì–´ë¡œ ì´ë¯¸ì§€ -->
      <div class="debug" id="dbg"></div> <!-- ë””ë²„ê·¸ ë¡œê·¸(ìš”ì²­/ì´ë¯¸ì§€ ê²½ë¡œ) -->

      <div class="panel" id="about">
        <div style="font-weight:700; margin-bottom:6px;">ì†Œê°œ</div>
        <div id="bio" style="opacity:.9"></div> <!-- ì¥ë¬¸ ì†Œê°œ/ë°°ê²½ -->
        <div class="chips">
          <span class="chip">TRPG</span>
          <span class="chip" id="chip-name">ì„¸ê³„ê´€</span>
        </div>
        <div class="hint">Tip: ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ë©´ /v1/chat (TRPG ëª¨ë“œ)ë¡œ ìš”ì²­í•©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat" id="chat"></div> <!-- ì±„íŒ… ë¡œê·¸ -->
    </div>

    <div class="inputBar" style="flex-shrink:0;">
    <div class="inputIn">
      <textarea id="ta" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦"></textarea>  <!-- ì…ë ¥ì°½ -->
      <button id="send">ë³´ë‚´ê¸°</button>                         <!-- ì „ì†¡ -->
    </div>
  </div>

  <!-- Toast Layer -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <div class="box">ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</div>
  </div>

  <!-- Persona Modal -->
  <div id="personaModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>í˜ë¥´ì¡°ë‚˜ ì„ íƒ</h2>
        <button class="modal-close" onclick="closePersonaModal()">Ã—</button>
      </div>
      <div class="modal-body" id="personaModalBody">
        <div class="modal-loading">ë¡œë”© ì¤‘...</div>
      </div>
      <div class="modal-footer">
        <div id="personaSelectedInfo" class="persona-selected-info" style="display:none;"></div>
        <div style="display:flex; justify-content:flex-end; gap:12px; width:100%;">
          <button class="btn-modal" onclick="closePersonaModal()">ì·¨ì†Œ</button>
          <button class="btn-modal primary" id="personaConfirmBtn" onclick="confirmPersonaSelection()" disabled>ì™„ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ì ˆëŒ€ê²½ë¡œ API_BASE_URL ìƒìˆ˜ ì •ì˜
    const API_BASE_URL =
      window.location.hostname === "arcanaverse.ai" ||
      window.location.hostname === "www.arcanaverse.ai"
        ? "https://api.arcanaverse.ai"
        : "http://localhost:8000";

    // --- ì „ì—­/ìœ í‹¸ -------------------------------------------------------------
    let CURRENT_WORLD = null;  // í˜„ì¬ ì„¸ê³„ê´€
    let CURRENT_WORLD_SESSION = null;  // í˜„ì¬ ì„¸ì…˜
    let PERSONAS_LIST = [];  // í˜ë¥´ì¡°ë‚˜ ëª©ë¡
    let SELECTED_PERSONA_ID = null;  // ì„ íƒëœ í˜ë¥´ì¡°ë‚˜ ID
    const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#0e141c"/><text x="50%" y="50%" fill="#94a3b8" font-size="48" font-family="sans-serif" text-anchor="middle" dominant-baseline="middle">No Image</text></svg>`
    );
    const dbg = (m) => { 
      const el=document.getElementById('dbg'); 
      // el.textContent = (el.textContent?el.textContent+"\n":"") + m; 
      // console.log(m); 
    };

    function qs(k){ return new URL(location.href).searchParams.get(k); } // ì¿¼ë¦¬ íŒŒì„œ

    // 'world_1' â†’ 1 / '1' â†’ 1
    function normalizeWorldId(v){
      if(!v) return null;
      if(/^world_\d{1,6}$/i.test(v)) return parseInt(v.split('_')[1],10);
      if(/^\d+$/.test(v)) return parseInt(v,10);
      return v;
    }

    // ì´ë¯¸ì§€ ê²½ë¡œ ë³´ì • â†’ í•­ìƒ /assets/world/... ë˜ëŠ” /assets/img/... ë¡œ
    function resolvePath(p){
      if (!p) return '/assets/img/placeholder.jpg';
      if (/^https?:\/\//i.test(p)) return p;
      p = String(p).replace(/\\/g, '/').trim();
      if (p.startsWith('/')) return p;
      if (p.startsWith('assets/')) return '/' + p;

      if (p.includes('/world/') || p.startsWith('world/') || p.startsWith('assets/world/')) {
        if (p.startsWith('assets/')) return '/' + p;
        if (p.startsWith('world/'))   return '/assets/' + p;
        return '/assets/world/' + p.replace(/^\/+/, '');
      }
      return '/assets/img/' + p.replace(/^\/+/, '');
    }

    // ì•ˆì „í•œ hero ì´ë¯¸ì§€ ë¡œë”(404 ì‹œ SVGë¡œ ëŒ€ì²´)
    function safeSetHero(imgUrl){
      const hero=document.getElementById('hero');
      hero.onerror=()=>{ dbg('[hero 404] '+imgUrl); hero.src=FALLBACK_SVG; };
      hero.onload =()=>{ dbg('[hero 200] '+imgUrl); };
      hero.src=imgUrl||'/assets/img/placeholder.jpg';
      dbg('[hero set] '+hero.src);
    }

    // ë‹¨ì¼ ì„¸ê³„ê´€ API í˜¸ì¶œ (ìƒì„¸)
    async function fetchWorld(id){
      dbg('[fetch] /v1/worlds/'+id);
      const r = await fetch(`${API_BASE_URL}/v1/worlds/${id}`, {
        method: "GET",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        cache: 'no-store'
      });
      dbg('[fetch status] '+r.status);
      if(!r.ok) throw new Error('ì„¸ê³„ê´€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: HTTP '+r.status);
      const j = await r.json();
      dbg('[fetch image] '+j.image);
      return j;
    }

    // ì„¸ê³„ê´€ ì±„íŒ… bootstrap API í˜¸ì¶œ (ê¸°ì¡´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°)
    async function bootstrapWorldChat(worldId, limit = 50){
      const token = getToken();

      // world_id ì •ê·œí™” (world_XX í˜•íƒœ ì²˜ë¦¬)
      let worldIdStr = worldId;
      if (typeof worldIdStr === 'string' && worldIdStr.startsWith('world_')) {
        try {
          worldIdStr = String(parseInt(worldIdStr.split('_')[1], 10));
        } catch (e) {
          worldIdStr = String(worldId);
        }
      } else if (typeof worldIdStr === 'string' && worldIdStr.startsWith('world-')) {
        // world-3 í˜•íƒœ ì²˜ë¦¬
        try {
          worldIdStr = worldIdStr.replace('world-', '');
        } catch (e) {
          worldIdStr = String(worldId);
        }
      } else {
        worldIdStr = String(worldId);
      }

      console.log(`[CHAT][BOOTSTRAP] request world_id=${worldIdStr} limit=${limit} token_exists=${!!token} token_len=${token ? token.length : 0}`);

      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        
        // tokenì´ ìˆì„ ë•Œë§Œ Authorization í—¤ë” ì¶”ê°€
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const url = `${API_BASE_URL}/v1/worlds/${worldIdStr}/chat/bootstrap?limit=${limit}`;
        const r = await fetch(url, {
          method: "GET",
          credentials: "include",  // ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ ì§€ì›
          headers: headers,
          cache: 'no-store'
        });

        console.log(`[CHAT][BOOTSTRAP] response status=${r.status} statusText=${r.statusText}`);

        if (!r.ok) {
          const errorText = await r.text();
          console.error(`[CHAT][BOOTSTRAP] fail status=${r.status} statusText=${r.statusText} detail=${errorText}`);
          console.error(`[CHAT][BOOTSTRAP] request_url=${url} headers=${JSON.stringify(headers)}`);
          
          if (r.status === 401) {
            console.error('[CHAT][BOOTSTRAP] Authentication failed - token may be expired or missing');
            showToast('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 3000);
          }
          
          return { session: null, messages: [] };
        }

        const data = await r.json();
        const messages = data.messages || [];
        const session = data.session;

        console.log(`[CHAT][BOOTSTRAP] ok messages=${messages.length} session_id=${session ? session.id : 'null'}`);

        return { session, messages };
      } catch (e) {
        console.error(`[CHAT][BOOTSTRAP] fail error=${e.message}`, e);
        return { session: null, messages: [] };
      }
    }

    // ìƒë‹¨/ë°°ê²½/ì¹© ë Œë”
    function paintWorld(world){
      document.getElementById('title').textContent=world.name||world.id;
      document.getElementById('chip-name').textContent=world.name||'ì„¸ê³„ê´€';
      document.getElementById('bio').textContent=(world.detail||world.summary||'').toString();

      const img=resolvePath(world.image||world.image_path||world.cover);
      dbg('[resolved img] '+img);
      safeSetHero(img);                                         // íˆì–´ë¡œ ì´ë¯¸ì§€
      document.getElementById('bg').style.backgroundImage=`url("${img}")`; // íë¦¼ ë°°ê²½

      const wrap=document.querySelector('.chips');              // genre/style/tags ì¹©
      wrap.querySelectorAll('.chip.extra').forEach(n=>n.remove());
      ['genre','style'].forEach(k=>{
        const v=(world[k]||'').toString().trim();
        if(v){ const s=document.createElement('span'); s.className='chip extra'; s.textContent=v; wrap.appendChild(s); }
      });
      // tags ë°°ì—´ ì²˜ë¦¬
      if(world.tags && Array.isArray(world.tags)){
        world.tags.forEach(tag=>{
          if(tag){ const s=document.createElement('span'); s.className='chip extra'; s.textContent=tag; wrap.appendChild(s); }
        });
      }
    }

    // ì±„íŒ… ë©”ì‹œì§€ DOM ìœ í‹¸
    function escapeHtml(s){ 
      return String(s||'').replace(
        /[&<>"']/g,
        c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
      );
    }
    function addUser(text){
      const chat=document.getElementById('chat');
      const row=document.createElement('div');
      row.className='msg me';
      
      // persona ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì„¸ì…˜ ìš°ì„ , ì—†ìœ¼ë©´ default)
      const persona = getActivePersonaForSession();
      
      // persona ë±ƒì§€ ìƒì„± (ì´ë¦„ ì œê±° - ì•„ì´ì½˜ë§Œ)
      let personaBadge = '';
      if (persona) {
        const personaImageUrl = resolvePersonaUrl(`/assets/persona/${persona.image_key || 'F01'}.png`);
        personaBadge = `
          <div class="user-persona-badge" data-role="persona-badge-message">
            <img src="${personaImageUrl}" alt="${escapeHtml(persona.name || '')}" class="user-persona-avatar" onerror="this.src='${resolvePersonaUrl('/assets/persona/F01.png')}'" />
          </div>
        `;
      }
      
      row.innerHTML=`<div class="bubble">${escapeHtml(text)}</div>${personaBadge}`;
      chat.appendChild(row);
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } else {
        chat.scrollTop = chat.scrollHeight;
      }
    }
    function addBot(text){  
      const chat=document.getElementById('chat'); 
      const row=document.createElement('div'); 
      row.className='msg'; 
      const img=resolvePath(CURRENT_WORLD?.image); 
      row.innerHTML=`<img class="avatar" src="${img}" alt="bot"/><div class="bubble">${escapeHtml(text)}</div>`; 
      chat.appendChild(row); 
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } else {
        chat.scrollTop = chat.scrollHeight;
      }
    }

    // í† í° ê´€ë¦¬
    const TOKEN_KEY = 'access_token';
    const USER_INFO_KEY = 'user_info_v2';

    function getToken() { return localStorage.getItem(TOKEN_KEY); }
    function isLoggedIn() { return !!getToken(); }

    async function getUserInfo() {
      const userInfoV2 = localStorage.getItem(USER_INFO_KEY);
      if (!userInfoV2) {
        return null;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/v1/auth/validate-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: userInfoV2 }),
          credentials: "include",
        });

        if (res.ok) {
          return await res.json();
        }
        return null;
      } catch (err) {
        console.error('Failed to get user info:', err);
        return null;
      }
    }

    /**
     * ê³„ì • ìƒíƒœ ì²´í¬
     * - ok: true ë©´ ì±„íŒ… ê°€ëŠ¥
     * - ok: false ì´ë©´ reason ìœ¼ë¡œ ìƒíƒœ êµ¬ë¶„
     *   - 'login': ë¡œê·¸ì¸ í•„ìš”
     *   - 'lock': ê³„ì • ì°¨ë‹¨
     *   - 'use': ì‚¬ìš© ë¶ˆê°€
     */
    async function checkAccountStatus() {
      const token = getToken();
      const info  = await getUserInfo();

      console.log('[ACCOUNT] token:', !!token, 'info:', info);

      if (!token) return { ok: false, reason: 'login' };

      if (!info)  return { ok: false, reason: 'login' };

      const is_use = info.is_use || false;
      const is_lock = info.is_lock || false;

      console.log('[ACCOUNT] is_use:', is_use, 'is_lock:', is_lock);

      if (is_lock) return { ok: false, reason: 'lock' };
      if (!is_use) return { ok: false, reason: 'use' };

      return { ok: true, reason: null };
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    function showToast(msg='ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤', ms=2000){
      const el = document.getElementById('toast');
      el.querySelector('.box').textContent = msg;
      el.classList.add('show');
      clearTimeout(showToast.tid);
      showToast.tid = setTimeout(() => el.classList.remove('show'), ms);
    }

    // í˜ë¥´ì¡°ë‚˜ ì´ë¯¸ì§€ URL ì •ê·œí™” í•¨ìˆ˜ (r2.dev ì°¨ë‹¨ í¬í•¨)
    function resolvePersonaUrl(u) {
      if (!u) return "";
      // r2.dev URL ì°¨ë‹¨ ë° ì •ê·œí™”
      if (typeof window.normalizeAssetUrl === 'function') {
        u = window.normalizeAssetUrl(u);
      } else if (u.includes('r2.dev') || u.includes('cloudflarestorage.com')) {
        console.error('ğŸš¨ r2.dev image URL blocked:', u);
        const assetBase = window.ASSET_BASE_URL || 'https://img.arcanaverse.ai';
        try {
          const urlObj = new URL(u);
          u = assetBase + urlObj.pathname + urlObj.search;
        } catch (e) {
          const pathMatch = u.match(/\/assets\/[^?]+/);
          u = assetBase + (pathMatch ? pathMatch[0] : '/assets/persona/placeholder.png');
        }
      }
      // ì´ë¯¸ ì ˆëŒ€ URLì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ì´ë¯¸ ì •ê·œí™”ë¨)
      if (u.startsWith("http://") || u.startsWith("https://")) return u;
      // buildAssetUrl ì‚¬ìš© (ASSET_BASE_URL ê¸°ë°˜)
      const assetBase = window.ASSET_BASE_URL || window.IMAGE_BASE?.replace('/assets', '') || 'https://img.arcanaverse.ai';
      if (u.startsWith("/")) {
        return assetBase + u;
      }
      // /ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ /assets/persona/ë¥¼ prefixë¡œ ì¶”ê°€
      return assetBase + "/assets/persona/" + u;
    }
    
    // í™œì„± persona ë°˜í™˜ (ì„¸ì…˜ ìš°ì„ , ì—†ìœ¼ë©´ default persona)
    function getActivePersonaForSession() {
      // 1) ì„¸ì…˜ persona ìŠ¤ëƒ…ìƒ· ìµœìš°ì„ 
      if (CURRENT_WORLD_SESSION?.persona?.persona_id) {
        return CURRENT_WORLD_SESSION.persona;
      }
      
      // 2) fallback: PERSONAS_LISTì—ì„œ default persona
      const ps = PERSONAS_LIST || [];
      const d = ps.find(p => p.is_default) || ps[0];
      if (d?.persona_id) {
        return {
          persona_id: d.persona_id,
          name: d.name,
          gender: d.gender,
          image_key: d.image_key
        };
      }
      
      // 3) nothing
      return null;
    }
    
    // ëª¨ë“  ìœ ì € ë©”ì‹œì§€ì˜ persona ë±ƒì§€ ê°±ì‹ 
    function refreshAllUserMessageBadges() {
      const persona = getActivePersonaForSession();
      document.querySelectorAll('[data-role="persona-badge-message"]').forEach(badge => {
        if (!persona) {
          badge.style.display = 'none';
          return;
        }
        
        badge.style.display = 'flex';
        const img = badge.querySelector('img');
        
        if (img) {
          const personaImageUrl = resolvePersonaUrl(`/assets/persona/${persona.image_key || 'F01'}.png`);
          img.src = personaImageUrl;
          img.onerror = function() {
            this.src = resolvePersonaUrl('/assets/persona/F01.png');
          };
        }
        // ì´ë¦„ ìš”ì†ŒëŠ” ì œê±°ë¨ (ì•„ì´ì½˜ë§Œ í‘œì‹œ)
      });
    }

    // í—¤ë”ì˜ persona ë±ƒì§€ ê°±ì‹ 
    function refreshHeaderPersonaBadge() {
      const persona = getActivePersonaForSession();
      const badgeEl = document.getElementById('headerPersonaBadge');
      const avatarEl = document.getElementById('headerPersonaAvatar');
      const nameEl = document.getElementById('headerPersonaName');
      const personaBtn = document.getElementById('personaBtn');
      
      if (!badgeEl || !avatarEl || !nameEl) return;
      
      if (!persona) {
        badgeEl.style.display = 'none';
        // personaê°€ ì—†ìœ¼ë©´ Persona ë²„íŠ¼ í‘œì‹œ (fallback)
        if (personaBtn) personaBtn.style.display = 'inline-block';
        return;
      }
      
      // personaê°€ ìˆìœ¼ë©´ badge í‘œì‹œ
      badgeEl.style.display = 'flex';
      if (personaBtn) personaBtn.style.display = 'none';
      
      // ì´ë¯¸ì§€ ë° ì´ë¦„ ì—…ë°ì´íŠ¸
      const personaImageUrl = resolvePersonaUrl(`/assets/persona/${persona.image_key || 'F01'}.png`);
      avatarEl.src = personaImageUrl;
      avatarEl.alt = persona.name || 'persona';
      avatarEl.onerror = function() {
        this.src = resolvePersonaUrl('/assets/persona/F01.png');
      };
      nameEl.textContent = persona.name || 'persona';
    }

    // í˜ë¥´ì¡°ë‚˜ í”„ë¦¬ë·° í…ìŠ¤íŠ¸ ì¶”ì¶œ (ìš°ì„ ìˆœìœ„: bio > summary > detail > ë¹ˆ ë¬¸ìì—´)
    function getPersonaPreview(p) {
      if (p.bio) return p.bio;
      if (p.summary) return p.summary;
      if (p.detail) return p.detail.substring(0, 120) + (p.detail.length > 120 ? '...' : '');
      return '';
    }

    // í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ì¡°íšŒ
    async function fetchPersonas() {
      try {
        const token = localStorage.getItem('user_info_v2');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['X-User-Info-Token'] = token;
        }

        const res = await fetch(`${API_BASE_URL}/v1/users/me/personas`, {
          credentials: 'include',
          headers
        });

        if (!res.ok) {
          if (res.status === 401) {
            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          }
          throw new Error(`Failed to load: ${res.status}`);
        }

        const personas = await res.json();
        return personas;
      } catch (e) {
        console.error('[PERSONA] Load error:', e);
        throw e;
      }
    }

    // í˜ë¥´ì¡°ë‚˜ ëª¨ë‹¬ ì—´ê¸°
    async function openPersonaModal() {
      const modal = document.getElementById('personaModal');
      const body = document.getElementById('personaModalBody');
      
      modal.classList.add('show');
      SELECTED_PERSONA_ID = null;
      body.innerHTML = '<div class="modal-loading">ë¡œë”© ì¤‘...</div>';

      try {
        PERSONAS_LIST = await fetchPersonas();
        renderPersonaList();
      } catch (e) {
        body.innerHTML = `<div class="modal-loading" style="color:#ef4444;">í˜ë¥´ì¡°ë‚˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${e.message}</div>`;
        console.error('[PERSONA] Failed to load personas:', e);
      }
    }

    // í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ë Œë”ë§
    function renderPersonaList() {
      const body = document.getElementById('personaModalBody');
      const selectedInfo = document.getElementById('personaSelectedInfo');
      const confirmBtn = document.getElementById('personaConfirmBtn');
      
      if (PERSONAS_LIST.length === 0) {
        body.innerHTML = '<div class="modal-loading">í˜ë¥´ì¡°ë‚˜ê°€ ì—†ìŠµë‹ˆë‹¤. My ë©”ë‰´ì—ì„œ í˜ë¥´ì¡°ë‚˜ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</div>';
        selectedInfo.style.display = 'none';
        confirmBtn.disabled = true;
        return;
      }

      // ì¹´ë“œ UIë¡œ ë Œë”ë§
      body.innerHTML = `<div class="persona-list">${PERSONAS_LIST.map(p => {
        const genderText = {
          male: 'ë‚¨ì„±',
          female: 'ì—¬ì„±',
          nonbinary: 'ë…¼ë°”ì´ë„ˆë¦¬'
        }[p.gender] || 'ë…¼ë°”ì´ë„ˆë¦¬';

        // image_key ì²˜ë¦¬
        let imageKey = p.image_key || 'F01';
        if (imageKey && imageKey.startsWith('preset_')) {
          try {
            const num = parseInt(imageKey.replace('preset_', ''));
            if (num <= 4 || num === 9 || num === 10 || num === 13 || num === 15) {
              const mIndex = num <= 4 ? num : (num === 9 ? 5 : num === 10 ? 6 : num === 13 ? 7 : 8);
              imageKey = `M${String(mIndex).padStart(2, '0')}`;
            } else {
              const fIndex = num <= 8 ? num - 4 : (num === 11 ? 3 : num === 12 ? 4 : num === 14 ? 5 : 6);
              imageKey = `F${String(fIndex).padStart(2, '0')}`;
            }
          } catch {
            imageKey = 'F01';
          }
        }
        const imageUrl = resolvePersonaUrl(`/assets/persona/${imageKey}.png`);
        const previewText = getPersonaPreview(p);
        const selected = SELECTED_PERSONA_ID === p.persona_id ? 'selected' : '';
        const defaultClass = p.is_default ? 'default' : '';

        return `
          <div class="persona-card ${selected} ${defaultClass}" onclick="selectPersona('${p.persona_id}')">
            <div class="persona-card-header">
              <img src="${imageUrl}" alt="${escapeHtml(p.name)}" class="persona-avatar" onerror="this.src='${resolvePersonaUrl('/assets/persona/F01.png')}'" />
              <div class="persona-info">
                <div class="persona-name">
                  ${p.is_default ? '<span class="persona-badge">ê¸°ë³¸</span>' : ''}
                  ${escapeHtml(p.name)}
                </div>
                <div class="persona-gender">${genderText}</div>
              </div>
            </div>
            ${previewText ? `<div class="persona-bio">${escapeHtml(previewText)}</div>` : ''}
          </div>
        `;
      }).join('')}</div>`;

      // ì„ íƒëœ í˜ë¥´ì¡°ë‚˜ ì •ë³´ í‘œì‹œ
      if (SELECTED_PERSONA_ID) {
        const selectedPersona = PERSONAS_LIST.find(p => p.persona_id === SELECTED_PERSONA_ID);
        if (selectedPersona) {
          selectedInfo.innerHTML = `ì„ íƒë¨: <strong>${escapeHtml(selectedPersona.name)}</strong>`;
          selectedInfo.style.display = 'block';
          confirmBtn.disabled = false;
        } else {
          selectedInfo.style.display = 'none';
          confirmBtn.disabled = true;
        }
      } else {
        selectedInfo.style.display = 'none';
        confirmBtn.disabled = true;
      }
    }

    // í˜ë¥´ì¡°ë‚˜ ì„ íƒ
    function selectPersona(personaId) {
      SELECTED_PERSONA_ID = personaId;
      renderPersonaList();
    }

    // í˜ë¥´ì¡°ë‚˜ ëª¨ë‹¬ ë‹«ê¸°
    function closePersonaModal() {
      const modal = document.getElementById('personaModal');
      modal.classList.remove('show');
      SELECTED_PERSONA_ID = null;
    }

    // í˜ë¥´ì¡°ë‚˜ ì„ íƒ ì™„ë£Œ
    async function confirmPersonaSelection() {
      if (!SELECTED_PERSONA_ID) {
        showToast('í˜ë¥´ì¡°ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!CURRENT_WORLD_SESSION || !CURRENT_WORLD_SESSION.id) {
        console.warn('[PERSONA] No session ID available');
        showToast('ì„¸ì…˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const sessionId = CURRENT_WORLD_SESSION.id;
      const confirmBtn = document.getElementById('personaConfirmBtn');
      const originalText = confirmBtn.textContent;
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'ì ìš© ì¤‘...';

      try {
        const token = localStorage.getItem('user_info_v2');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['X-User-Info-Token'] = token;
        }

        // world-sessions API í˜¸ì¶œ
        const res = await fetch(`${API_BASE_URL}/v1/world-sessions/${sessionId}/persona`, {
          method: 'POST',
          credentials: 'include',
          headers,
          body: JSON.stringify({ persona_id: SELECTED_PERSONA_ID })
        });

        if (!res.ok) {
          if (res.status === 404) {
            console.log('[PERSONA] API endpoint not found (404) - this is expected if backend is not implemented yet');
            showToast('í˜ë¥´ì¡°ë‚˜ ì ìš© APIê°€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          } else {
            const errorText = await res.text().catch(() => 'Unknown error');
            console.error(`[PERSONA] API error: ${res.status} ${errorText}`);
            showToast(`í˜ë¥´ì¡°ë‚˜ ì ìš© ì‹¤íŒ¨: HTTP ${res.status}`);
          }
          return;
        }

        const data = await res.json().catch(() => ({}));
        console.log('[PERSONA] Successfully applied persona:', data);
        
        // CURRENT_WORLD_SESSION.persona ì—…ë°ì´íŠ¸
        if (CURRENT_WORLD_SESSION && data.persona) {
          CURRENT_WORLD_SESSION.persona = data.persona;
          console.log('[PERSONA] Updated CURRENT_WORLD_SESSION.persona:', CURRENT_WORLD_SESSION.persona);
          
          // UI ë±ƒì§€ ì¦‰ì‹œ ê°±ì‹ 
          refreshAllUserMessageBadges();
          refreshHeaderPersonaBadge();
        }
        
        showToast('í˜ë¥´ì¡°ë‚˜ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closePersonaModal();
      } catch (e) {
        console.error('[PERSONA] Failed to apply persona:', e);
        showToast(`í˜ë¥´ì¡°ë‚˜ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    }

    // ë°±ì—”ë“œ LLM í˜¸ì¶œ
    async function askLLM(message, mode='trpg', choices=0){
      try {
      // chat_send ì´ë²¤íŠ¸ ë¡œê¹… (ì±„íŒ… ì›ë¬¸ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
      if (window.logEvent) {
        window.logEvent(
          window.EVENT.CHAT_SEND,
          'world',
          {
            chat_type: 'world',
            message_len: message ? message.length : 0,
          },
          {
            entity_id: CURRENT_WORLD?.id ? String(CURRENT_WORLD.id) : null,
          }
        );
      }
      
      const token = getToken();
      const headers = { 'Content-Type': 'application/json' };
      
      // ë¡œê·¸ì¸ í† í°ì´ ìˆìœ¼ë©´ í—¤ë”ì— ì¶”ê°€
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const payload = {
        message, mode,
        model:'trpg-gen', polish_model:'trpg-polish', choices,
        world_id: CURRENT_WORLD?.id ?? null,
        world: CURRENT_WORLD ? {
          id: CURRENT_WORLD.id, name: CURRENT_WORLD.name,
          summary: CURRENT_WORLD.summary, detail: CURRENT_WORLD.detail,
          genre: CURRENT_WORLD.genre, style: CURRENT_WORLD.style,
          tags: CURRENT_WORLD.tags || [],
        } : null,
      };
        
        const url = `${API_BASE_URL}/v1/chat/`;
        console.log('[askLLM] Request URL:', url);
        console.log('[askLLM] API_BASE_URL:', API_BASE_URL);
        console.log('[askLLM] Payload:', payload);
        
        const r = await (window.apiFetch || fetch)(url, {
          method: "POST",
          credentials: "include",
          headers: headers,
          body: JSON.stringify(payload),
        });
        
        console.log('[askLLM] Response status:', r.status, r.statusText);
        console.log('[askLLM] Response headers:', Object.fromEntries(r.headers.entries()));
        
        if (!r.ok) {
          const errorText = await r.text();
          console.error(`[askLLM] HTTP ${r.status} Error:`, errorText);
          throw new Error(`HTTP ${r.status}: ${errorText || 'Server error'}`);
        }
        
      const j = await r.json();
        console.log('[askLLM] Response JSON:', j);
      return (j?.answer||'').trim();
      } catch(e) {
        console.error('[askLLM] Error:', e);
        console.error('[askLLM] Error stack:', e.stack);
        const errorMsg = e.message || String(e);
        return `(ì˜¤ë¥˜ ë°œìƒ) ${errorMsg}`;
      }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async ()=>{
      // ë’¤ë¡œê°€ê¸°
      document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); else location.href='/'; };
      
      // Persona ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById('personaBtn').onclick = openPersonaModal;
      
      // ëª¨ë‹¬ backdrop í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
      document.getElementById('personaModal').addEventListener('click', (e) => {
        if (e.target.id === 'personaModal') {
          closePersonaModal();
        }
      });

      // URL â†’ ì„¸ê³„ê´€ id ì •ê·œí™”
      const raw  = qs('world') || qs('world_id') || null;
      const norm = normalizeWorldId(raw) || 1;
      dbg('[param] raw='+raw+' norm='+norm);

      // ìƒì„¸ API í˜¸ì¶œ
      let world=null;
      try { world = await fetchWorld(norm); }
      catch(e){ dbg('[error] '+e.message); world = {id:norm, name:'ë¯¸í™•ì¸ ì„¸ê³„ê´€', image:'/assets/img/placeholder.jpg', summary:'ì •ë³´ ì—†ìŒ'}; }
      CURRENT_WORLD = world;
      paintWorld(world);

      // Bootstrap: ê¸°ì¡´ ì±„íŒ… ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
      let isLoadingBootstrap = true;
      const sendBtn = document.getElementById('send');
      const inputTa = document.getElementById('ta');
      
      // ë¡œë”© ì¤‘ì—ëŠ” ì…ë ¥ ë¹„í™œì„±í™”
      sendBtn.disabled = true;
      inputTa.disabled = true;

      try {
        const bootstrapResult = await bootstrapWorldChat(norm, 50);
        const messages = bootstrapResult.messages || [];
        const session = bootstrapResult.session;
        
        // CURRENT_WORLD_SESSION ì„¤ì •
        if (session) {
          CURRENT_WORLD_SESSION = session;
          console.log('[WORLD][BOOTSTRAP] Session loaded:', session.id);
        }
        
        // ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ (created_at ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ ë³´ì¥)
        if (messages.length > 0) {
          // created_at ê¸°ì¤€ìœ¼ë¡œ í•œ ë²ˆ ë” ì •ë ¬ (ì•ˆì „ì¥ì¹˜)
          messages.sort((a, b) => {
            const timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
            const timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
            return timeA - timeB;
          });

          // ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§
          messages.forEach(msg => {
            if (msg.role === 'user') {
              addUser(msg.content || '');
            } else if (msg.role === 'assistant') {
              addBot(msg.content || '');
            }
          });
          
          // í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ë¡œë“œ (fallbackìš©)
          try {
            PERSONAS_LIST = await fetchPersonas();
          } catch (e) {
            console.warn('[WORLD][BOOTSTRAP] Failed to load personas:', e);
          }
          
          // ë±ƒì§€ ê°±ì‹ 
          refreshAllUserMessageBadges();
          refreshHeaderPersonaBadge();
        } else {
          // ë©”ì‹œì§€ê°€ ì—†ì–´ë„ ì„¸ì…˜ì´ ìˆìœ¼ë©´ í—¤ë” badge í‘œì‹œ
          if (session) {
            // í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ë¡œë“œ (fallbackìš©)
            try {
              PERSONAS_LIST = await fetchPersonas();
            } catch (e) {
              console.warn('[WORLD][BOOTSTRAP] Failed to load personas:', e);
            }
            refreshHeaderPersonaBadge();
          }
        }
      } catch (e) {
        console.error('[CHAT][BOOTSTRAP] Error loading messages:', e);
      } finally {
        // ë¡œë”© ì™„ë£Œ í›„ ì…ë ¥ í™œì„±í™”
        isLoadingBootstrap = false;
        sendBtn.disabled = false;
        inputTa.disabled = false;
        inputTa.focus();
      }

      // ì…ë ¥ ë™ì‘
      const ta=document.getElementById('ta'), btn=document.getElementById('send');
      
      // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ì…ë ¥/ì „ì†¡ ì‹œë„ ì‹œ ê³„ì • ìƒíƒœ ì²´í¬
      async function checkLoginAndSend(){
        const status = await checkAccountStatus();

        if (!status.ok) {
          if (status.reason === 'login') {
            showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'lock') {
            showToast('í˜„ì¬ ê³„ì •ì´ ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'use') {
            showToast('í˜„ì¬ ì‚¬ìš©ì´ ë¶ˆê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else {
            showToast('ê³„ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 2000);
          }
          ta.blur();
          return false;
        }
        return true;
      }

      async function send(){
        // ë¡œê·¸ì¸ ì²´í¬
        if (!(await checkLoginAndSend())) return;
        
        const v=ta.value.trim(); if(!v)return;
        addUser(v); ta.value=''; btn.disabled=true;
        
        console.log('[send] Starting API call with message:', v);
        console.log('[send] API_BASE_URL:', API_BASE_URL);
        
        try{ 
          const ans=await askLLM(v,'trpg');
          console.log('[send] Received answer:', ans);
          addBot(ans||'(ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤)');
        }
        catch(e){ 
          console.error('[send] Error caught:', e);
          addBot('ì„œë²„ ì˜¤ë¥˜: '+e.message);
        }
        finally{ 
          btn.disabled=false; 
          ta.focus(); 
        }
      }
      
      // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ ê³„ì • ìƒíƒœ ì²´í¬
      ta.addEventListener('focus', async (ev) => {
        const status = await checkAccountStatus();
        if (!status.ok) {
          ev.preventDefault();
          ta.blur();

          if (status.reason === 'login') {
            showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'lock') {
            showToast('í˜„ì¬ ê³„ì •ì´ ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'use') {
            showToast('í˜„ì¬ ì‚¬ìš©ì´ ë¶ˆê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else {
            showToast('ê³„ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 2000);
          }
        }
      });

      // í´ë¦­ ì‹œë„ ì‹œ ê³„ì • ìƒíƒœ ì²´í¬
      ta.addEventListener('click', async (ev) => {
        const status = await checkAccountStatus();
        if (!status.ok) {
          ev.preventDefault();
          ta.blur();

          if (status.reason === 'login') {
            showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'lock') {
            showToast('í˜„ì¬ ê³„ì •ì´ ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'use') {
            showToast('í˜„ì¬ ì‚¬ìš©ì´ ë¶ˆê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else {
            showToast('ê³„ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 2000);
          }
        }
      });

      btn.onclick=send;
      ta.addEventListener('keydown', ev=>{ 
        if (ev.key==='Enter' && !ev.shiftKey){ 
          ev.preventDefault(); 
          send(); 
        }
      });
    });
  </script>
</body>
</html>

