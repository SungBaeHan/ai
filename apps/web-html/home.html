<!-- =============================================
 home.html (캐릭터 목록) — 상세 주석 버전
 구조: 헤더 <style>, 본문 레이아웃, 스크립트(데이터 로드/렌더)
 ============================================= -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>캐릭터 선택</title>
  <script src="/js/config.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, 'Apple SD Gothic Neo','Malgun Gothic',sans-serif; background:#0b0f14; color:#e5e7eb;}

    /* top nav (moved from bottom) */
    .nav { position:sticky; top:0; z-index:30; background:#0b1118; border-bottom:1px solid #18212c; }
    .navin { max-width:1200px; margin:0 auto; padding:8px 12px; display:flex; align-items:center; gap:12px; }
    .navin .tabs { display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; flex: 1; }
    .tab { text-align:center; padding:10px 8px; border-radius:10px; background:#0f172a; color:#a5b4fc; border:1px solid #1e293b; font-size:12px; cursor:pointer; user-select:none; }
    .tab:active { transform:translateY(1px); }

    .wrap { max-width:1200px; margin:24px auto 40px; padding:0 16px;}
    h1 { font-size:20px; font-weight:700; margin:8px 0 20px; color:#d1d5db; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:18px; }
    .card { display:block; background:#111827; border-radius:14px; overflow:hidden; border:1px solid #1f2937; text-decoration:none; color:inherit; box-shadow:0 6px 18px rgba(0,0,0,.25); transition: transform .15s ease, box-shadow .15s ease; }
    .card:hover { transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.35); }
    .thumb { width:100%; aspect-ratio: 16/10; object-fit:cover; background:#0f172a; display:block; }
    .body { padding:12px 14px 16px; }
    .name { font-size:16px; font-weight:700; color:#f3f4f6; }
    .meta { margin-top:6px; font-size:12px; color:#94a3b8; line-height:1.4; display:block; height:32px; overflow:hidden; }

    /* toast layer */
    .toast { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition:opacity .18s ease; z-index:50; }
    .toast.show { opacity:1; }
    .toast .box { pointer-events:auto; min-width:200px; max-width:80vw; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; padding:14px 18px; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.45); text-align:center; }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <div class="nav"><div class="navin">
    <div class="tabs">
      <div class="tab" data-nav="logo">Logo</div>
      <div class="tab" data-nav="search">Search</div>
      <div class="tab" data-nav="create">Create</div>
      <div class="tab" data-nav="list">My List</div>
      <div class="tab" data-nav="my">My</div>
    </div>
  </div></div>

  <div class="wrap">
    <h1>캐릭터 선택</h1>
    <div id="grid" class="grid"></div>
  </div>

  <!-- Toast Layer -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <div class="box">준비중입니다</div>
  </div>

  <script>
    // API_BASE는 config.js에서 설정된 window.API_BASE를 사용
    const API_BASE = (typeof window !== 'undefined' && window.API_BASE) ? window.API_BASE : 'https://api.arcanaverse.ai';
    
    // API 실패 시 로컬 JSON 대체 경로(있다면 사용됨)
    const CANDIDATES = ['/json/characters.json','/characters.json','/static/characters.json'];

        // 서버 API에서 캐릭터 목록 로드
    async function loadFromApi() {
      const r = await fetch(`${API_BASE}/v1/characters?offset=0&limit=200`);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      return j.items || [];
    }
        // 로컬 정적 JSON에서 캐릭터 목록 로드 (개발/오프라인용)
    async function loadFromLocal(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      return j.characters || j.items || j || [];
    }
        // 캐릭터 목록 로드 진입점: 1) API 시도 → 2) 실패 시 로컬 JSON들 순차 시도
    async function loadCharacters() {
      try { return await loadFromApi(); }
      catch(_) {
        for (const url of CANDIDATES) { try { return await loadFromLocal(url); } catch(__){} }
        return [];
      }
    }

        // 숫자/char_XX 형태를 일관된 char_## 로 통일
    function normalizeCharId(v){
      if(!v) return 'char_01';
      if(/^\d+$/.test(v)) return 'char_' + String(parseInt(v,10)).padStart(2,'0');
      if(/^char_\d{1,2}$/.test(v)) return 'char_' + String(parseInt(v.split('_')[1],10)).padStart(2,'0');
      return v;
    }

    // ✅ 목록 썸네일도 동일 로직
    function resolvePath(p){
      if (!p) return '/assets/img/placeholder.jpg';
      if (/^https?:\/\//i.test(p)) return p;
      p = String(p).replace(/\\/g, '/').trim();
      if (p.startsWith('/')) return p;
      if (p.startsWith('assets/')) return '/' + p;
      if (p.includes('/char/') || p.startsWith('char/') || /^char_\d+/i.test(p) || p.startsWith('assets/char/')) {
        p = p.replace(/^assets\/?/, '');
        p = p.replace(/^char\//, 'char/');
        return '/assets/' + p;
      }
      return '/assets/img/' + p;
    }
    
        // 카드 DOM을 생성하여 그리드에 추가
    function card(item) {
      const id = normalizeCharId(item.id || item.pk || item.slug || item.name || 'char_01');
      const a  = document.createElement('a');
      a.className = 'card';
      a.href = `/chat?character=${id}`;
      a.addEventListener('click', () => { try { sessionStorage.setItem('lastChar', id); } catch(_){ } });

      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = item.name || id;
      img.src = resolvePath(item.image || item.cover || '/assets/img/placeholder.jpg');

      const body = document.createElement('div'); body.className='body';
      const name = document.createElement('div'); name.className='name'; name.textContent = item.name || id;
      const meta = document.createElement('span'); meta.className='meta';
      meta.textContent = (item.shortBio || item.oneLiner || item.greeting || '').toString();

      body.appendChild(name); body.appendChild(meta);
      // <!-- .meta 밑에 한 줄 추가 -->
      const chips = document.createElement('div');
      chips.style.marginTop='6px';
      chips.style.display='flex';
      chips.style.gap='6px';
      chips.innerHTML = [item.genre, item.style, item.world].filter(Boolean).map(v=>`<span style="font-size:11px;padding:2px 8px;border:1px solid #334155;border-radius:999px;background:#0b1220;color:#a5b4fc">${v}</span>`).join('');
      body.appendChild(chips);      
      a.appendChild(img); a.appendChild(body);
      return a;
    }

    // 토큰 관리
    const TOKEN_KEY = 'access_token';
    
    function getToken() {
      return localStorage.getItem(TOKEN_KEY);
    }
    
    function isLoggedIn() {
      return !!getToken();
    }

        // 상단 탭 클릭 시 처리 (토스트 또는 로그인 체크)
    function showToast(msg='준비중입니다', ms=1200){
      const el = document.getElementById('toast');
      el.querySelector('.box').textContent = msg;
      el.classList.add('show');
      clearTimeout(showToast.tid);
      showToast.tid = setTimeout(() => el.classList.remove('show'), ms);
    }

        // 초기화: 네비게이션 바 핸들러+캐릭터 목록 렌더링
    (async function init(){
      // nav buttons -> 처리
            // 상단 네비게이션 탭 클릭 시 처리
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const navType = btn.getAttribute('data-nav');
          
          if (navType === 'my') {
            // My 메뉴는 바로 이동
            e.preventDefault();
            window.location.href = '/my.html';
            return;
          }
          
          // 다른 메뉴는 로그인 체크
          if (!isLoggedIn()) {
            e.preventDefault();
            showToast('로그인이 필요합니다.', 2000);
            return;
          }
          
          // 로그인되어 있으면 준비중 표시
          e.preventDefault();
          showToast('준비중입니다.', 1500);
        });
      });

      const grid = document.getElementById('grid');
            // 캐릭터 데이터 로드 (API 우선)
      const items = await loadCharacters();
            // 데이터 없을 때 안내 문구 표시
      grid.innerHTML = items.length ? '' : '<div style="opacity:.7">표시할 캐릭터가 없습니다.</div>';
            // 각 아이템을 카드로 변환해 그리드에 추가
             items.forEach(it => grid.appendChild(card(it)));
     })();
   </script>
  <div id="gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;"></div>
<script>
(async () => {
  try {
    const API = (typeof window !== 'undefined' && window.API_BASE_URL) ? window.API_BASE_URL : '';
    const url = `${API}/assets/images?prefix=char/&limit=60&signed=true`;

    const res = await fetch(url, { credentials: 'omit' });
    const data = await res.json();

    const $g = document.getElementById('gallery') || (() => {
      const div = document.createElement('div');
      div.id = 'gallery';
      div.style.display = 'grid';
      div.style.gridTemplateColumns = 'repeat(auto-fill,minmax(140px,1fr))';
      div.style.gap = '12px';
      document.body.appendChild(div);
      return div;
    })();

    $g.innerHTML = '';
    (data.items || []).forEach(item => {
      const img = document.createElement('img');
      img.src = item.url;
      img.alt = item.key || '';
      img.loading = 'lazy';
      img.style.width = '100%';
      img.style.height = '200px';
      img.style.objectFit = 'cover';
      img.referrerPolicy = 'no-referrer';
      img.crossOrigin = 'anonymous';
      $g.appendChild(img);
    });
  } catch (e) {
    console.error('Failed to load images', e);
  }
})();
</script>
 </body>
 </html>
