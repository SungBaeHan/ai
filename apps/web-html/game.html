<!-- ========================================
     apps/web-html/game.html â€” ê²Œì„ ìƒì„¸(ì±„íŒ…) í™”ë©´
     - URL ?game=1 ë˜ëŠ” ?game_id=1 ì§€ì›
     - /v1/games/:id ë‹¨ê±´ í˜¸ì¶œí•´ì„œ ë Œë”
     - ì´ë¯¸ì§€ ê²½ë¡œ ë³´ì •(resolvePath)ë¡œ /assets/game/â€¦ ë³´ì¥
     - ê²Œì„ ì±„íŒ… ì‹œì‘
     ======================================== -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Chat â€¢ TRPG</title>
  <script>
    // ASSET_BASE_URL ê°•ì œ ì„¤ì • (r2.dev ì°¨ë‹¨)
    window.__ASSET_BASE_URL__ = 'https://img.arcanaverse.ai';
  </script>
  <script src="/js/config.js"></script>
  <script src="/js/assets.js"></script>
  <script>
    // ì „ì—­ API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (ì–´ë””ì„œë“  window.API_BASE_URLë¡œ ì ‘ê·¼)
    window.API_BASE_URL = 'https://api.arcanaverse.ai';
    window.API_BASE = 'https://api.arcanaverse.ai';
    
    // ê²Œì„ ID ì£¼ì… (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ì¶”ì¶œ)
    (function() {
      const params = new URLSearchParams(window.location.search);
      const gameId = params.get('game') || params.get('game_id');
      if (gameId) {
        // 'game_1' í˜•ì‹ì´ë©´ ìˆ«ìë§Œ ì¶”ì¶œ
        const match = gameId.match(/^game_(\d+)$/i);
        window.GAME_ID = match ? parseInt(match[1], 10) : parseInt(gameId, 10);
      }
    })();
  </script>
  <script src="/js/game_turn.js"></script>
  <style>
    :root { 
      color-scheme: dark; /* ë‹¤í¬ í…Œë§ˆ íŒíŠ¸ */
      --hud-width: 900px; /* ìƒë‹¨ HUD(.game-hero-card) í­ê³¼ ë™ì¼ */
    }
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }
    body { 
      background:#0b0f14; 
      color:#e5e7eb; 
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,'Apple SD Gothic Neo','Malgun Gothic',sans-serif; 
    }
    /* í˜ì´ì§€ ì „ì²´ë¥¼ 100vhë¡œ ê³ ì • */
    .game-body {
      height: 100vh;
    }
    /* ë£¨íŠ¸ ì»¨í…Œì´ë„ˆ: ìœ„/ê°€ìš´ë°/ì•„ë˜ ì„¸ë¡œ í”Œë ‰ìŠ¤ */
    .game-root {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    /* ìƒë‹¨ HUD + ì†Œê°œ ì˜ì—­: ë‚´ìš© ë†’ì´ì— ë§ê²Œ, ìŠ¤í¬ë¡¤ X */
    .game-top {
      flex: 0 0 auto;
    }
    /* ê°€ìš´ë° ì±„íŒ… ì˜ì—­: ë‚¨ëŠ” ê³µê°„ ë‹¤ ì°¨ì§€ + ì—¬ê¸°ë§Œ ìŠ¤í¬ë¡¤ */
    .game-middle {
      flex: 1 1 auto;
      min-height: 0;          /* ì¤‘ìš”: ìì‹ì´ overflow í•  ìˆ˜ ìˆê²Œ */
      display: flex;
      flex-direction: column;
    }
    .topbar-wrap { display:flex; justify-content:center; border-bottom:1px solid #1b2430; background:#0e141c; position:sticky; top:0; z-index:20; }
    .topbar { width:100%; max-width:980px; display:flex; align-items:center; gap:10px; padding:10px 14px; justify-content:space-between; }
    .topbar-left { display:flex; align-items:center; gap:10px; flex:1; }
    .topbar-right { display:flex; align-items:center; gap:10px; }
    .back { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid #223042; background:#0f172a; color:#cbd5e1; cursor:pointer; }
    .title { font-weight:700; font-size:15px; color:#f1f5f9; }
    .persona-btn { padding:6px 12px; border-radius:8px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; font-size:13px; cursor:pointer; transition:all .15s ease; }
    .persona-btn:hover { background:#334155; border-color:#475569; }
    .header-persona-badge { display:flex; align-items:center; gap:8px; padding:4px 8px; border-radius:8px; border:1px solid #334155; background:#1f2937; cursor:pointer; transition:all .15s ease; }
    .header-persona-badge:hover { background:#334155; border-color:#475569; }
    .header-persona-avatar { width:24px; height:24px; border-radius:50%; object-fit:cover; box-shadow:0 0 4px rgba(0,0,0,.3); }
    .header-persona-name { font-size:13px; color:#e5e7eb; }
    .hero { position:relative; margin:18px auto; max-width:980px; }
    .hero img { width:100%; border-radius:14px; border:1px solid #1f2937; box-shadow:0 10px 28px rgba(0,0,0,.35); display:block; }
    .panel { max-width:980px; margin:10px auto 18px; background:#0f172a; border:1px solid #1e293b; border-radius:12px; padding:12px 14px; }
    .chips { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip { padding:3px 8px; font-size:11px; border-radius:999px; border:1px solid #334155; color:#a5b4fc; background:#0b1220; }
    .hint { font-size:12px; color:#9ca3af; margin-top:6px; }
    /* game-hud-boxëŠ” game-hero-statsë¡œ ëŒ€ì²´ë˜ì—ˆìœ¼ë¯€ë¡œ ì œê±° */
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ì€ game-hero-statsì— í†µí•©ë¨ */
    .game-hud-section {
      min-width:180px;
    }
    .game-hud-title {
      font-weight:600;
      margin-bottom:4px;
      opacity:0.7;
    }
    .game-hud-char {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:4px;
      font-size:12px;
    }
    .game-hud-char-name {
      font-weight:600;
      margin-right:8px;
    }
    .game-hud-char-stats {
      display:flex;
      gap:8px;
      opacity:0.85;
    }
    /* ì „ì²´ ê²Œì„ í˜ì´ì§€: ìƒë‹¨ ê³ ì • + í•˜ë‹¨ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    .game-page {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px); /* topbar ë†’ì´ ì œì™¸ (ì•½ 60px) */
      overflow: hidden;       /* í˜ì´ì§€ ë ˆë²¨ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }
    /* game-bodyê°€ ì¶”ê°€ëœ ê²½ìš° ë†’ì´ ì¡°ì • */
    .game-page.game-body {
      height: calc(100vh - 60px);
    }
    /* ì „ì²´ ê²Œì„ ë ˆì´ì•„ì›ƒ: ë°°ê²½ ìœ„ì—ì„œ ì¤‘ì•™ ì •ë ¬ */
    .game-layout {
      width: 100%;
      display: flex;
      justify-content: center;
    }
    /* âœ… HUD / ì†Œê°œ / ì±„íŒ…ì´ ëª¨ë‘ ë“¤ì–´ê°€ëŠ” ì¤‘ì•™ ì»¬ëŸ¼ */
    /* game-root ì—­í• ë„ í•¨ê»˜ ìˆ˜í–‰ */
    .game-main-column {
      /* ìƒë‹¨ HUD ì¹´ë“œ í­ê³¼ ë§ì¶°ì¤„ ê°’ (ê¸°ì¡´ HUD width ì— ë§ì¶° ìˆ˜ì • ê°€ëŠ¥) */
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      height: 100%;  /* game-root ì—­í•  */
    }
    /* ìƒë‹¨ ìŠ¤íƒ¯ ì¹´ë“œì™€ ì†Œê°œ/ì±„íŒ…ì´ ê³µìœ í•  ê°€ë¡œ í­ ë˜í¼ */
    .game-inner-width {
      max-width: 960px;      /* ìƒë‹¨ ì¹´ë“œ ì‹¤ì œ í­ì— ë§ê²Œ ì¡°ì ˆí•´ë„ ë¨ */
      width: 100%;
      margin: 0 auto;        /* ê°€ìš´ë° ì •ë ¬ */
      box-sizing: border-box;
    }
    /* HUD ì™€ ì†Œê°œëŠ” ì´ ì»¬ëŸ¼ ì•ˆì—ì„œ ì „ì²´ í­ ì‚¬ìš© */
    .game-top-panel {
      width: 100%;
    }
    /* ìƒë‹¨ íˆì–´ë¡œ ì˜ì—­: ë†’ì´ ì œí•œí•˜ì—¬ ì••ì¶• */
    .game-hero {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-height: 25vh;    /* í™”ë©´ì˜ 25%ê¹Œì§€ë§Œ ì‚¬ìš© (ë” ì••ì¶•) */
      min-height: 150px;   /* ìµœì†Œê°’ ë” ì¤„ì„ */
      z-index: 10;
      margin-bottom: 0;
      overflow: hidden;
      width: 100%;  /* game-main-column ì•ˆì—ì„œ ì „ì²´ í­ ì‚¬ìš© */
    }
    /* ì´ë¯¸ì§€ ì¹´ë“œ ì „ì²´ */
    .game-hero-card {
      position: relative;
      width: 100%;
      max-width: 100%;  /* game-main-column í­ì— ë§ì¶¤ */
      margin: 0 auto;
      border-radius: 16px;
      overflow: hidden;
    }
    /* ì´ë¯¸ì§€ */
    .game-hero-image {
      width: 100%;
      display: block;
      border-radius: 16px;
    }
    /* ì†Œê°œ íŒ¨ë„ (ì´ë¯¸ì§€+ìŠ¤íƒ¯ ì•„ë˜ ë°°ì¹˜) - HUD í­ê³¼ ì •í™•íˆ ë§ë„ë¡ */
    .game-intro-panel {
      flex-shrink: 0;
      max-height: 110px;  /* 2ì¤„ ì •ë„ ë” í‘œì‹œ ê°€ëŠ¥í•˜ë„ë¡ ë†’ì´ ì¦ê°€ */
      overflow-y: auto;  /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
      box-sizing: border-box;
      margin: 8px auto 0;  /* ê°€ìš´ë° ì •ë ¬, ìƒë‹¨ ì—¬ë°± */
      background: #0f172a;
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 6px 0;  /* ì¢Œìš° íŒ¨ë”© ì œê±°í•˜ì—¬ ë…¸ë€ìƒ‰ ì˜ì—­ì— ë‹¿ë„ë¡ */
      font-size: 0.85rem;  /* í°íŠ¸ í¬ê¸° ì¡°ì • */
      scrollbar-width: none;  /* Firefox: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
      -ms-overflow-style: none;  /* IE/Edge: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    /* ì†Œê°œ íŒ¨ë„ ë‚´ë¶€ ì½˜í…ì¸ ì—ë§Œ ì¢Œìš° íŒ¨ë”© ì ìš© */
    .game-intro-panel > div {
      padding-left: 14px;
      padding-right: 14px;
    }
    .game-intro-panel::-webkit-scrollbar {
      display: none;  /* Chrome/Safari: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    /* â­ ìŠ¤íƒ¯ HUD ì˜¤ë²„ë ˆì´ */
    .game-hero-stats {
      position: absolute;
      bottom: 12px;                 /* ì´ë¯¸ì§€ ì•ˆì—ì„œì˜ ì•„ë˜ìª½ ìœ„ì¹˜ */
      left: 12px;
      right: 12px;                  /* ì¢Œìš° ì—¬ë°±ì´ exactly ì´ë¯¸ì§€ ì¹´ë“œ í­ì— ë§ë„ë¡ */
      padding: 14px 18px;
      border-radius: 12px;
      background: rgba(10, 12, 20, 0.80);  /* ë°˜íˆ¬ëª… HUD */
      backdrop-filter: blur(6px);
      color: #fff;
      z-index: 10;                  /* ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ */
      display: flex;
      gap: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      font-size: 0.9rem;
    }
    /* í…ìŠ¤íŠ¸ ë„ˆë¬´ ë¶™ì§€ ì•Šë„ë¡ */
    .game-hero-stats table,
    .game-hero-stats div {
      width: 100%;
    }
    /* ì±„íŒ… ì˜ì—­ ìì²´ëŠ” ì¤‘ì•™ ì»¬ëŸ¼ ì•ˆì—ì„œë§Œ ë™ì‘ */
    /* ê°€ìš´ë° ì±„íŒ… ë¡œê·¸ë§Œ ìŠ¤í¬ë¡¤ */
    .game-chat-log {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: 12px 24px 16px;
      /* ìŠ¤í¬ë¡¤ë°”ë§Œ ìˆ¨ê¸°ê¸° (ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ì€ ìœ ì§€) */
      scrollbar-width: none;  /* Firefox: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
      -ms-overflow-style: none;  /* IE/Edge: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    /* ì±„íŒ… ë¡œê·¸ ë³¸ë¬¸ì€ ì „ì²´ í­ ì‚¬ìš© */
    #chat, #chat-log, #game-log-messages {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    /* ë©”ì‹œì§€ í–‰ ìŠ¤íƒ€ì¼ */
    .msg { display:flex; align-items:flex-end; gap:8px; margin:8px 0; }
    .msg.me { justify-content:flex-end; }
    .bubble { background:#111827; border:1px solid #1f2937; padding:10px 14px; border-radius:14px; white-space:pre-wrap; line-height:1.6; max-width:70%; }
    .me .bubble { background:rgba(63,131,248,0.25); border-color:#334155; }
    .user-persona-badge { display:flex; align-items:center; gap:8px; }
    .user-persona-avatar { width:28px; height:28px; border-radius:50%; object-fit:cover; box-shadow:0 0 4px rgba(0,0,0,.3); }
    .user-persona-name { font-size:12px; color:#cbd5e1; opacity:0.85; }
    .game-chat-log::-webkit-scrollbar {
      display: none;  /* Chrome/Safari: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    /* í•˜ë‹¨ ì…ë ¥ì°½: ê³ ì • */
    .game-bottom {
      flex: 0 0 auto;
    }
    /* ì…ë ¥ì°½ì€ flex í•˜ë‹¨ì— ê³ ì • */
    /* ì¤‘ì•™ ì»¬ëŸ¼ ì•ˆì—ì„œ ì „ì²´ í­ ì‚¬ìš© */
    .game-chat-input {
      flex-shrink: 0;
      width: 100%;
      padding: 8px 16px 12px;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      /* position: fixed/absolute/bottom ì œê±° í™•ì¸ - flexë§Œ ì‚¬ìš© */
    }
    /* ì±„íŒ… ë¡œê·¸ ì˜ì—­ ì•ˆì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜ë  ì„ íƒì§€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬ */
    .game-turn-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0 8px;
      width: 100%;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    /* ë²„íŠ¼ì´ ìœ„ë¡œ ë”¸ë ¤ê°€ì§€ ì•Šë„ë¡ position ê´€ë ¨ ìŠ¤íƒ€ì¼ì€ ì ˆëŒ€ ë„£ì§€ ë§ ê²ƒ */
    .game-turn-actions button {
      /* ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìœ ì§€ */
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #111827;
      color: #c7d2fe;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .game-turn-actions button:hover {
      background: #1f2937;
      border-color: #475569;
    }
    .game-turn-actions button:active {
      transform: translateY(1px);
    }
    /* í•œ ì¤„ ë ˆì´ì•„ì›ƒ ê³µí†µ */
    .chat-row {
      display: flex;
      margin: 4px 0;
      animation: fadeInUp .35s ease;
    }
    /* ë§í’ì„  ê³µí†µ ìŠ¤íƒ€ì¼ */
    .chat-bubble {
      max-width: 70%;      /* ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ */
      padding: 8px 12px;
      border-radius: 16px;
      box-sizing: border-box;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    /* âœ… NPC: ì™¼ìª½ ì •ë ¬ (ë…¸ë€ ë°•ìŠ¤ ì™¼ìª½ì— ë¶™ê²Œ) */
    .chat-row.chat-npc {
      justify-content: flex-start;   /* ì™¼ìª½ ì •ë ¬ */
    }
    .chat-row.chat-npc .chat-bubble {
      background: #111827;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      margin-left: 8px;              /* ì•„ë°”íƒ€ì™€ ê°„ê²© */
      margin-right: auto;            /* ì˜¤ë¥¸ìª½ì€ ìë™ */
    }
    /* âœ… í”Œë ˆì´ì–´: ì˜¤ë¥¸ìª½ ì •ë ¬ (ë…¸ë€ ë°•ìŠ¤ ì˜¤ë¥¸ìª½ì— ë¶™ê²Œ) */
    .chat-row.chat-player {
      justify-content: flex-end;     /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
    }
    .chat-row.chat-player .chat-bubble {
      background: rgba(63,131,248,0.25);
      border: 1px solid #334155;
      color: #e5e7eb;
      margin-left: auto;             /* ì™¼ìª½ì€ ìë™ */
      margin-right: 0;
    }
    /* ë§í’ì„  ê³µí†µ - ê¸°ì¡´ .msg í´ë˜ìŠ¤ í˜¸í™˜ì„± ìœ ì§€ */
    .msg { 
      display: flex; 
      align-items: flex-start; 
      gap: 10px; 
      margin: 4px 0; 
      padding: 0;
      animation: fadeInUp .35s ease; 
      max-width: 100%;
    }
    /* NPC: ì™¼ìª½ ì •ë ¬ (ë…¸ë€ ë°•ìŠ¤ ì™¼ìª½ì— ë¶™ê²Œ) */
    .msg:not(.me) {
      justify-content: flex-start;
    }
    /* í”Œë ˆì´ì–´: ì˜¤ë¥¸ìª½ ì •ë ¬ (ë…¸ë€ ë°•ìŠ¤ ì˜¤ë¥¸ìª½ì— ë¶™ê²Œ) */
    .msg.me { 
      flex-direction: row-reverse; 
      margin-left: auto;           /* ìë™ìœ¼ë¡œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ê¸° */
      justify-content: flex-end;
      align-items: flex-end;
    }
    .avatar { width:42px; height:42px; border-radius:50%; object-fit:cover; box-shadow:0 0 6px rgba(0,0,0,.4); }
    .bubble { background:#111827; border:1px solid #1f2937; padding:10px 14px; border-radius:14px; white-space:pre-wrap; line-height:1.6; max-width:70%; }
    .me .bubble { background:rgba(63,131,248,0.25); border-color:#334155; }
    /* chat-row êµ¬ì¡°ì—ì„œ ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ */
    .chat-row .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 0 6px rgba(0,0,0,.4);
      flex-shrink: 0;
    }
    .inputBar { 
      /* position:fixed ì œê±° - flex layoutìœ¼ë¡œ ì²˜ë¦¬ */
      border-top:1px solid #1b2430; 
      background:#0e141c; 
      padding:12px; 
    }
    .inputIn { width: 100%; display:flex; gap:8px; }
    textarea { flex:1; resize:none; background:#0b1220; border:1px solid #1f2937; border-radius:10px; color:#e5e7eb; padding:10px 12px; min-height:44px; }
    button { padding:0 14px; border-radius:10px; border:1px solid #334155; background:#111827; color:#c7d2fe; height:44px; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .bg { position:fixed; inset:0; background-position:center; background-size:cover; opacity:.4; filter:blur(1.5px) brightness(0.9); z-index:-1; transition:filter .5s ease, opacity .5s ease; }
    .debug { max-width:980px; margin:6px auto 0; font-size:12px; color:#93c5fd; opacity:.9; white-space:pre-wrap; }
    /* toast layer */
    .toast { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition:opacity .18s ease; z-index:50; }
    .toast.show { opacity:1; }
    .toast .box { pointer-events:auto; min-width:200px; max-width:80vw; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; padding:14px 18px; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.45); text-align:center; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    
    /* persona modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .modal-backdrop.show { opacity:1; pointer-events:auto; }
    .modal-backdrop.force-open { pointer-events:auto; } /* ê°•ì œ ëª¨ë‹¬ (ë‹«ê¸° ë¶ˆê°€) */
    .modal { background:#111827; border:1px solid #1f2937; border-radius:12px; width:90%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #1f2937; }
    .modal-header h2 { margin:0; font-size:18px; color:#f3f4f6; }
    .modal-close { background:none; border:none; color:#94a3b8; font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; }
    .modal-close:hover { color:#e5e7eb; }
    .modal-close.hidden { display:none; } /* ê°•ì œ ëª¨ë‹¬ì—ì„œ ë‹«ê¸° ë²„íŠ¼ ìˆ¨ê¹€ */
    .modal-body { padding:20px; max-height:60vh; overflow-y:auto; }
    
    /* Persona Card Styles */
    .persona-list { display:flex; flex-direction:column; gap:12px; }
    .persona-card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; transition:all .15s ease; cursor:pointer; }
    .persona-card:hover { border-color:#3b82f6; }
    .persona-card.selected { border-color:#3b82f6; border-width:2px; background:#1e3a8a; }
    .persona-card.default { border-color:#3b82f6; background:#1e3a8a; }
    .persona-card-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .persona-avatar { width:64px; height:64px; border-radius:8px; background:#1f2937; object-fit:cover; border:2px solid #334155; }
    .persona-info { flex:1; }
    .persona-name { font-size:16px; font-weight:600; color:#f3f4f6; margin-bottom:4px; }
    .persona-badge { display:inline-block; padding:2px 8px; background:#3b82f6; color:#fff; border-radius:4px; font-size:11px; font-weight:600; margin-right:6px; }
    .persona-gender { font-size:12px; color:#94a3b8; }
    .persona-bio { font-size:13px; color:#cbd5e1; line-height:1.5; margin-bottom:12px; max-height:60px; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
    .persona-selected-info { padding:12px; background:#1e293b; border-radius:8px; margin-top:12px; font-size:13px; color:#cbd5e1; }
    .persona-selected-info strong { color:#3b82f6; }
    .modal-footer { padding:20px; border-top:1px solid #1f2937; flex-shrink:0; }
    .btn-modal { padding:10px 20px; border-radius:6px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; font-size:14px; font-weight:500; cursor:pointer; transition:all .15s ease; }
    .btn-modal:hover { background:#334155; }
    .btn-modal.primary { background:#3b82f6; border-color:#2563eb; color:#fff; }
    .btn-modal.primary:hover { background:#2563eb; }
    .modal-loading { text-align:center; padding:40px; color:#94a3b8; }
    
    /* Confirm Dialog */
    .confirm-dialog { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:110; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .confirm-dialog.show { opacity:1; pointer-events:auto; }
    .confirm-dialog-box { background:#111827; border:1px solid #1f2937; border-radius:12px; width:90%; max-width:400px; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    .confirm-dialog-title { font-size:18px; font-weight:600; color:#f3f4f6; margin-bottom:16px; }
    .confirm-dialog-message { font-size:14px; color:#cbd5e1; margin-bottom:24px; line-height:1.5; }
    .confirm-dialog-actions { display:flex; gap:12px; justify-content:flex-end; }
    
    /* ===== Game Chat Message System (UX v1) ===== */
    .game-msg {
      display: flex;
      margin: 10px 0;
    }
    .game-bubble {
      position: relative;
      max-width: 62%;
      padding: 10px 12px;
      border-radius: 12px;
      line-height: 1.35;
      font-size: 13px;
    }
    /* Alignment (role ê¸°ë°˜, actionì€ modifierë¡œ ì •ë ¬ ì˜í–¥ ì—†ìŒ) */
    .game-msg--player {
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      gap: 8px;  /* bubbleê³¼ badge ê°„ê²© */
    }
    .game-msg--npc,
    .game-msg--narrator { justify-content: flex-start; }
    /* Color/tones (no hard-coded brand colors, use existing theme vars if any) */
    .game-msg--player .game-bubble {
      background: rgba(80, 120, 255, 0.22);
      max-width: 70%;
    }
    .game-msg--npc .game-bubble { background: rgba(255, 255, 255, 0.14); }
    .game-msg--narrator .game-bubble {
      background: rgba(255, 255, 255, 0.08);
      font-style: italic;
    }
    /* action style as modifier (do not override alignment) */
    .game-msg--action .game-bubble {
      background: rgba(255, 200, 80, 0.14);
      border: 1px solid rgba(255, 200, 80, 0.25);
    }
    /* Action head */
    .game-action-head {
      font-size: 11px;
      letter-spacing: 0.08em;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    /* NPC avatar next to bubble (ìºë¦­í„°/ì„¸ê³„ê´€ ì±„íŒ… ìˆ˜ì¤€ í¬ê¸°) */
    .game-avatar {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      margin-right: 10px;
      align-self: flex-end;
      border: 1px solid rgba(255,255,255,0.25);
      background-color: rgba(0,0,0,0.25);
      flex: 0 0 auto;
    }
    .game-avatar--fallback {
      display: grid;
      place-items: center;
      font-size: 13px;
      color: rgba(255,255,255,0.9);
    }
    /* Mini persona badge: stamp style (bubble ë°–, í˜•ì œë¡œ ë°°ì¹˜) */
    .persona-badge--mini {
      position: static;  /* absolute ì œê±° - bubble ë°– í˜•ì œë¡œ ë°°ì¹˜ */
      width: 38px;
      height: 38px;
      border-radius: 50%;
      overflow: hidden;
      padding: 0;  /* pill í˜•íƒœ ë°©ì§€ */
      box-sizing: border-box;
      flex: 0 0 auto;
      display: inline-flex;  /* inline-flexë¡œ ë³€ê²½ */
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.25);
      user-select: none;
      pointer-events: auto;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }
    .persona-badge--mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
    }
    .persona-badge--mini .persona-badge__fallback {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      line-height: 1;
      color: rgba(255,255,255,0.9);
    }
    /* Small tags */
    .game-npc-tag,
    .game-narrator-tag {
      position: absolute;
      left: 8px;
      top: -8px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.30);
      border: 1px solid rgba(255,255,255,0.15);
      opacity: 0.85;
    }
    .game-narrator-tag { opacity: 0.6; }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div> <!-- íë¦¼ ë°°ê²½ -->

  <div class="topbar-wrap">
    <div class="topbar">
      <div class="topbar-left">
        <button id="backBtn" class="back" title="ë’¤ë¡œ ê°€ê¸°">â†</button> <!-- ë’¤ë¡œê°€ê¸° -->
        <div class="title" id="title">ë¡œë”© ì¤‘â€¦</div>                   <!-- ê²Œì„ ì´ë¦„ -->
      </div>
      <div class="topbar-right">
        <div id="headerPersonaBadge" class="header-persona-badge" style="display:none;" title="í˜ë¥´ì¡°ë‚˜ ì„¤ì •" onclick="openPersonaModal()">
          <img id="headerPersonaAvatar" class="header-persona-avatar" src="" alt="" />
          <span id="headerPersonaName" class="header-persona-name"></span>
        </div>
        <button id="personaBtn" class="persona-btn" title="í˜ë¥´ì¡°ë‚˜ ì„¤ì •" style="display:none;">Persona</button> <!-- í˜ë¥´ì¡°ë‚˜ ë²„íŠ¼ (fallback) -->
      </div>
    </div>
  </div>

  <div id="game-page" class="game-page game-layout game-body">
    <!-- âœ… ë©”ì¸ ì»¬ëŸ¼ ë˜í¼: HUD / ì†Œê°œ / ì±„íŒ…ì„ ëª¨ë‘ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ -->
    <div class="game-main-column game-root">
      <!-- ìƒë‹¨: HUD + ì†Œê°œ ì˜ì—­ (ê³ ì •) -->
      <div class="game-top">
        <!-- ìƒë‹¨: ì´ë¯¸ì§€ + ì‹œë‚˜ë¦¬ì˜¤ + HUD(ìŠ¤íƒ¯) -->
        <section class="game-hero game-top-panel">
          <div class="game-hero-card top-hud game-inner-width">
            <img id="hero" class="game-hero-image" alt="cover" src="/assets/img/placeholder.jpg" /> <!-- íˆì–´ë¡œ ì´ë¯¸ì§€ -->
            <div class="debug" id="dbg"></div> <!-- ë””ë²„ê·¸ ë¡œê·¸(ìš”ì²­/ì´ë¯¸ì§€ ê²½ë¡œ) -->

            <!-- â­ HUD ìŠ¤íƒ¯ íŒ¨ë„ (ì´ë¯¸ì§€ ìœ„ì— ì˜¤ë²„ë ˆì´) -->
            <div id="game-hud" class="game-hero-stats">
              <div class="game-hud-section">
                <div class="game-hud-title">ìƒíƒœ</div>
                <div class="game-hud-body">ê²Œì„ì„ ì‹œì‘í•˜ë©´ ìƒíƒœê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- ì†Œê°œ ë°•ìŠ¤ -->
        <div id="game-intro" class="game-intro-panel game-inner-width">
          <div id="game-intro-title" style="font-weight:700; margin-bottom:6px;">ì†Œê°œ</div>
          <div id="game-narration" style="opacity:.9"></div> <!-- ë‚´ë ˆì´ì…˜ ì˜ì—­ -->
          <div class="chips">
            <span class="chip">TRPG</span>
            <span class="chip" id="chip-name">ê²Œì„</span>
          </div>
          <div class="hint">Tip: ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ë©´ ê²Œì„ í„´ì´ ì§„í–‰ë©ë‹ˆë‹¤.</div>
        </div>
      </div> <!-- /game-top -->

      <!-- ê°€ìš´ë°: ì±„íŒ… ë¡œê·¸ë§Œ ìŠ¤í¬ë¡¤ ë˜ëŠ” ì˜ì—­ -->
      <div class="game-middle">
        <section id="chat-log" class="game-chat-log game-inner-width">
          <div id="game-log-messages">
            <div class="chat" id="chat"></div> <!-- ì±„íŒ… ë¡œê·¸ -->
            <div class="chat" id="chat-log-old" style="display:none;"></div> <!-- í„´ ì‹œìŠ¤í…œìš© ì±„íŒ… ë¡œê·¸ -->
          </div>
          <!-- â­ ì„ íƒì§€ ë²„íŠ¼ì€ ì—¬ê¸° -->
          <div id="game-turn-actions" class="game-turn-actions">
            <!-- JSê°€ ì—¬ê¸° ì•ˆì— ë²„íŠ¼ë“¤ì„ append í•˜ë„ë¡ ìœ ì§€ -->
          </div>
          <!-- ìŠ¤í¬ë¡¤ í•˜ë‹¨ ë§ˆì»¤ (ìë™ ìŠ¤í¬ë¡¤ìš©) -->
          <div id="chat-bottom-marker" style="height: 1px;"></div>
        </section>
      </div> <!-- /game-middle -->

      <!-- í•˜ë‹¨: ì…ë ¥ì°½ ê³ ì • -->
      <div class="game-bottom">
        <div class="game-chat-input" id="chat-input">
          <div class="inputIn">
            <textarea id="ta" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦"></textarea>  <!-- ì…ë ¥ì°½ (ê¸°ì¡´) -->
            <textarea id="user-input" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦" style="display:none;"></textarea>  <!-- í„´ ì‹œìŠ¤í…œìš© ì…ë ¥ì°½ -->
            <button id="send">ë³´ë‚´ê¸°</button>                         <!-- ì „ì†¡ (ê¸°ì¡´) -->
            <button id="send-btn" style="display:none;">ë³´ë‚´ê¸°</button>  <!-- í„´ ì‹œìŠ¤í…œìš© ì „ì†¡ ë²„íŠ¼ -->
          </div>
        </div>
      </div> <!-- /game-bottom -->
    </div> <!-- /game-main-column /game-root -->
  </div>

  <!-- Toast Layer -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <div class="box">ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</div>
  </div>

  <!-- Persona Modal -->
  <div id="personaModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>í˜ë¥´ì¡°ë‚˜ ì„ íƒ</h2>
        <button class="modal-close" id="personaModalClose" onclick="closePersonaModal()">Ã—</button>
      </div>
      <div class="modal-body" id="personaModalBody">
        <div class="modal-loading">ë¡œë”© ì¤‘...</div>
      </div>
      <div class="modal-footer">
        <div id="personaSelectedInfo" class="persona-selected-info" style="display:none;"></div>
        <div style="display:flex; justify-content:flex-end; gap:12px; width:100%;">
          <button class="btn-modal" id="personaCancelBtn" onclick="closePersonaModal()" style="display:none;">ì·¨ì†Œ</button>
          <button class="btn-modal primary" id="personaConfirmBtn" onclick="confirmPersonaSelection()" disabled>ì™„ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Dialog (ì „íˆ¬ ì¤‘ ë³€ê²½ í™•ì¸) -->
  <div id="confirmDialog" class="confirm-dialog">
    <div class="confirm-dialog-box">
      <div class="confirm-dialog-title">í˜ë¥´ì¡°ë‚˜ ë³€ê²½ í™•ì¸</div>
      <div class="confirm-dialog-message" id="confirmDialogMessage">ê²Œì„ ì¤‘ì— í˜ë¥´ì¡°ë‚˜ë¥¼ ë³€ê²½í•˜ë©´ ì´í›„ ëŒ€ì‚¬ì™€ ì „íˆ¬ íŒì •ì— ì¦‰ì‹œ ì˜í–¥ì„ ì¤ë‹ˆë‹¤. ì •ë§ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
      <div class="confirm-dialog-actions">
        <button class="btn-modal" onclick="closeConfirmDialog(false)">ì•„ë‹ˆì˜¤</button>
        <button class="btn-modal primary" onclick="closeConfirmDialog(true)">ì˜ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // API_BASE_URLì€ ì´ë¯¸ ìœ„ìª½ì—ì„œ window.API_BASE_URLë¡œ ì„¤ì •ë¨

    // --- ì „ì—­/ìœ í‹¸ -------------------------------------------------------------
    let CURRENT_GAME = null;  // í˜„ì¬ ê²Œì„
    let PERSONAS_LIST = [];  // í˜ë¥´ì¡°ë‚˜ ëª©ë¡
    let SELECTED_PERSONA_ID = null;  // ì„ íƒëœ í˜ë¥´ì¡°ë‚˜ ID
    let isPersonaModalForceOpen = false;  // ê°•ì œ ëª¨ë‹¬ ì—¬ë¶€
    let pendingPersonaSelection = null;  // ì „íˆ¬ ì¤‘ í™•ì¸ ëŒ€ê¸° ì¤‘ì¸ persona ì„ íƒ
    const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#0e141c"/><text x="50%" y="50%" fill="#94a3b8" font-size="48" font-family="sans-serif" text-anchor="middle" dominant-baseline="middle">No Image</text></svg>`
    );
    const dbg = (m) => { 
      const el=document.getElementById('dbg'); 
      // el.textContent = (el.textContent?el.textContent+"\n":"") + m; 
      // console.log(m); 
    };

    function qs(k){ return new URL(location.href).searchParams.get(k); } // ì¿¼ë¦¬ íŒŒì„œ

    // 'game_1' â†’ 1 / '1' â†’ 1
    function normalizeGameId(v){
      if(!v) return null;
      if(/^game_\d{1,6}$/i.test(v)) return parseInt(v.split('_')[1],10);
      if(/^\d+$/.test(v)) return parseInt(v,10);
      return v;
    }

    // ì´ë¯¸ì§€ ê²½ë¡œ ë³´ì • â†’ ìƒëŒ€ ê²½ë¡œë¥¼ í’€ URLë¡œ ë³€í™˜
    // ASSET_BASE_URL ì‚¬ìš© (config.jsì—ì„œ ì„¤ì •ë¨)
    const ASSET_BASE_URL = window.ASSET_BASE_URL || window.IMAGE_BASE?.replace('/assets', '') || 'https://img.arcanaverse.ai';
    
    function resolveAssetUrl(path) {
      if (!path) return "";
      // r2.dev URL ì°¨ë‹¨ ë° ì •ê·œí™”
      if (path.includes('r2.dev') || path.includes('cloudflarestorage.com')) {
        console.error('ğŸš¨ r2.dev image URL blocked:', path);
        if (typeof window.normalizeAssetUrl === 'function') {
          path = window.normalizeAssetUrl(path);
        } else {
          try {
            const urlObj = new URL(path);
            path = ASSET_BASE_URL + urlObj.pathname + urlObj.search;
          } catch (e) {
            const pathMatch = path.match(/\/assets\/[^?]+/);
            path = ASSET_BASE_URL + (pathMatch ? pathMatch[0] : '/assets/img/placeholder.jpg');
          }
        }
      }
      // ì´ë¯¸ í’€ URLì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ì´ë¯¸ ì •ê·œí™”ë¨)
      if (path.startsWith("http://") || path.startsWith("https://")) return path;
      
      // ìƒëŒ€ ê²½ë¡œ(/assets/...)ë¥¼ Asset Base URLë¡œ ë³€í™˜
      if (path.startsWith("/")) {
        return `${ASSET_BASE_URL}${path}`;
      }
      // ìƒëŒ€ ê²½ë¡œê°€ /ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ /assets/char/ ë˜ëŠ” /assets/img/ ê²½ë¡œë¡œ ê°€ì •
      if (path.includes('/char/') || path.includes('char_')) {
        return `${ASSET_BASE_URL}/assets/char/${path.replace(/^.*\/(char\/|char_)/, '').replace(/^.*\//, '')}`;
      }
      return `${ASSET_BASE_URL}/assets/img/${path}`;
    }
    
    function resolvePath(p){
      if (!p) {
        return resolveAssetUrl('/assets/img/placeholder.jpg');
      }
      // ì´ë¯¸ í’€ URLì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
      if (/^https?:\/\//i.test(p)) return p;
      
      p = String(p).replace(/\\/g, '/').trim();
      
      // resolveAssetUrl ì‚¬ìš© (unreachable code ì œê±°)
      return resolveAssetUrl(p);
    }

    // ì•ˆì „í•œ hero ì´ë¯¸ì§€ ë¡œë”(404 ì‹œ SVGë¡œ ëŒ€ì²´)
    function safeSetHero(imgUrl){
      const hero=document.getElementById('hero');
      hero.onerror=()=>{ dbg('[hero 404] '+imgUrl); hero.src=FALLBACK_SVG; };
      hero.onload =()=>{ dbg('[hero 200] '+imgUrl); };
      hero.src=imgUrl||'/assets/img/placeholder.jpg';
      dbg('[hero set] '+hero.src);
    }

    // ë‹¨ì¼ ê²Œì„ API í˜¸ì¶œ (ìƒì„¸)
    async function fetchGame(id){
      dbg('[fetch] /v1/games/'+id);
      const r = await fetch(`${API_BASE_URL}/v1/games/${id}`, {
        method: "GET",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        cache: 'no-store'
      });
      dbg('[fetch status] '+r.status);
      if(!r.ok) throw new Error('ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: HTTP '+r.status);
      const j = await r.json();
      dbg('[fetch image] '+j.background_image_path);
      return j;
    }

    // ìƒë‹¨/ë°°ê²½/ì¹© ë Œë”
    function paintGame(game){
      document.getElementById('title').textContent=game.title||game.id;
      document.getElementById('chip-name').textContent=game.title||'ê²Œì„';
      const bioText = game.scenario_summary || game.scenario_detail || game.title || '';
      // bio ëŒ€ì‹  game-narration ì‚¬ìš©
      const narrationEl = document.getElementById('game-narration');
      if (narrationEl) {
        narrationEl.textContent = bioText.toString();
      }

      // ê²Œì„ ë°°ê²½ ì´ë¯¸ì§€: ë°±ì—”ë“œì—ì„œ R2 public URLë¡œ ë³€í™˜ëœ í•„ë“œ ìš°ì„  ì‚¬ìš©
      const img = game.image || 
                 game.background_image_url || 
                 (game.world_snapshot && game.world_snapshot.image_url) || 
                 '/assets/img/placeholder.jpg';
      dbg('[resolved img] '+img);
      safeSetHero(img);                                         // íˆì–´ë¡œ ì´ë¯¸ì§€
      document.getElementById('bg').style.backgroundImage=`url("${img}")`; // íë¦¼ ë°°ê²½

      const wrap=document.querySelector('.chips');              // tags ì¹©
      wrap.querySelectorAll('.chip.extra').forEach(n=>n.remove());
      // tags ë°°ì—´ ì²˜ë¦¬
      if(game.tags && Array.isArray(game.tags)){
        game.tags.forEach(tag=>{
          if(tag){ const s=document.createElement('span'); s.className='chip extra'; s.textContent=tag; wrap.appendChild(s); }
        });
      }
    }

    // ì±„íŒ… ë©”ì‹œì§€ DOM ìœ í‹¸
    function escapeHtml(s){ 
      return String(s||'').replace(
        /[&<>"']/g,
        c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
      );
    }
    function addUser(text){ 
      const chat=document.getElementById('chat'); 
      const row=document.createElement('div'); 
      row.className='msg me'; 
      
      // persona ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê²Œì„ ì„¸ì…˜ì˜ player_persona)
      const persona = getActivePersonaForGame();
      
      // persona ë±ƒì§€ ìƒì„±
      let personaBadge = '';
      if (persona) {
        let imageKey = persona.image_key || 'F01';
        if (imageKey && imageKey.startsWith('preset_')) {
          try {
            const match = imageKey.match(/preset_([MF]\d+)/);
            if (match) imageKey = match[1];
          } catch (e) {}
        }
        const personaImageUrl = `/assets/persona/${imageKey}.png`;
        personaBadge = `
          <div class="user-persona-badge" data-role="persona-badge-message">
            <img src="${personaImageUrl}" alt="${escapeHtml(persona.name || '')}" class="user-persona-avatar" onerror="this.src='/assets/persona/F01.png'" />
            <span class="user-persona-name" data-role="persona-name">${escapeHtml(persona.name || '')}</span>
          </div>
        `;
      }
      
      row.innerHTML=`<div class="bubble">${escapeHtml(text)}</div>${personaBadge}`; 
      chat.appendChild(row); 
      
      const chatContainer = document.querySelector('.game-chat-log');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } else {
        chat.scrollTop = chat.scrollHeight;
      }
    }
    function addBot(text, name=null){  
      const chat=document.getElementById('chat'); 
      const row=document.createElement('div'); 
      row.className='msg'; 
      // ê²Œì„ ë°°ê²½ ì´ë¯¸ì§€: ë°±ì—”ë“œì—ì„œ R2 public URLë¡œ ë³€í™˜ëœ í•„ë“œ ìš°ì„  ì‚¬ìš©
      const img = CURRENT_GAME?.image || 
                 CURRENT_GAME?.background_image_url || 
                 (CURRENT_GAME?.world_snapshot && CURRENT_GAME.world_snapshot.image_url) || 
                 '/assets/img/placeholder.jpg';
      const nameLabel = name ? `<strong>${escapeHtml(name)}</strong>: ` : '';
      row.innerHTML=`<img class="avatar" src="${img}" alt="bot"/><div class="bubble">${nameLabel}${escapeHtml(text)}</div>`; 
      chat.appendChild(row); 
      chat.scrollTop=chat.scrollHeight; 
    }
    
    function renderGameHud(userInfo, charactersInfo) {
      if (!hudEl) return;
      
      const attrs = (userInfo && userInfo.attributes) || {};
      const hp = attrs.hp || {};
      const mp = attrs.mp || {};
      const items = (userInfo && userInfo.items) || {};
      const gold = items.gold ?? 0;
      const chars = Array.isArray(charactersInfo) ? charactersInfo : [];
      
      hudEl.innerHTML = `
        <div class="game-hud-section">
          <div class="game-hud-title">í”Œë ˆì´ì–´</div>
          <div>HP: ${hp.current ?? 0} / ${hp.max ?? 0}</div>
          <div>MP: ${mp.current ?? 0} / ${mp.max ?? 0}</div>
          <div>Gold: ${gold}</div>
        </div>
        <div class="game-hud-section">
          <div class="game-hud-title">ë™ë£Œ / NPC</div>
          ${
            chars.length === 0
              ? '<div class="game-hud-char">ì•„ì§ ë™ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
              : chars
                  .map((c) => {
                    const snap = c.snapshot || {};
                    const name = snap.name || '???';
                    const a = snap.attributes || {};
                    const chp = a.hp || {};
                    const cmp = a.mp || {};
                    return `
                      <div class="game-hud-char">
                        <span class="game-hud-char-name">${escapeHtml(name)}</span>
                        <span class="game-hud-char-stats">
                          <span>HP ${chp.current ?? 0}/${chp.max ?? 0}</span>
                          <span>MP ${cmp.current ?? 0}/${cmp.max ?? 0}</span>
                        </span>
                      </div>
                    `;
                  })
                  .join('')
          }
        </div>
      `;
      // game-hero-statsëŠ” flex ë ˆì´ì•„ì›ƒ ìœ ì§€
      hudEl.style.display = 'flex';
      hudEl.style.gap = '24px';
      hudEl.style.color = '#f5f5f5';
    }

    // í† í° ê´€ë¦¬
    const TOKEN_KEY = 'access_token';
    const USER_INFO_KEY = 'user_info_v2';

    function getToken() { return localStorage.getItem(TOKEN_KEY); }
    function isLoggedIn() { return !!getToken(); }

    async function getUserInfo() {
      const userInfoV2 = localStorage.getItem(USER_INFO_KEY);
      if (!userInfoV2) {
        return null;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/v1/auth/validate-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: userInfoV2 }),
          credentials: "include",
        });

        if (res.ok) {
          return await res.json();
        }
        return null;
      } catch (err) {
        console.error('Failed to get user info:', err);
        return null;
      }
    }

    /**
     * ê³„ì • ìƒíƒœ ì²´í¬
     * - ok: true ë©´ ì±„íŒ… ê°€ëŠ¥
     * - ok: false ì´ë©´ reason ìœ¼ë¡œ ìƒíƒœ êµ¬ë¶„
     *   - 'login': ë¡œê·¸ì¸ í•„ìš”
     *   - 'lock': ê³„ì • ì°¨ë‹¨
     *   - 'use': ì‚¬ìš© ë¶ˆê°€
     */
    async function checkAccountStatus() {
      const token = getToken();
      const info  = await getUserInfo();

      console.log('[ACCOUNT] token:', !!token, 'info:', info);

      if (!token) return { ok: false, reason: 'login' };

      if (!info)  return { ok: false, reason: 'login' };

      const is_use = info.is_use || false;
      const is_lock = info.is_lock || false;

      console.log('[ACCOUNT] is_use:', is_use, 'is_lock:', is_lock);

      if (is_lock) return { ok: false, reason: 'lock' };
      if (!is_use) return { ok: false, reason: 'use' };

      return { ok: true, reason: null };
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    function showToast(msg='ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤', ms=2000){
      const el = document.getElementById('toast');
      el.querySelector('.box').textContent = msg;
      el.classList.add('show');
      clearTimeout(showToast.tid);
      showToast.tid = setTimeout(() => el.classList.remove('show'), ms);
    }

    // í˜ë¥´ì¡°ë‚˜ ì´ë¯¸ì§€ URL ì •ê·œí™” í•¨ìˆ˜ (r2.dev ì°¨ë‹¨ í¬í•¨)
    function resolvePersonaUrl(u) {
      if (!u) return "";
      // r2.dev URL ì°¨ë‹¨ ë° ì •ê·œí™”
      if (typeof window.normalizeAssetUrl === 'function') {
        u = window.normalizeAssetUrl(u);
      } else if (u.includes('r2.dev') || u.includes('cloudflarestorage.com')) {
        console.error('ğŸš¨ r2.dev image URL blocked:', u);
        const assetBase = window.ASSET_BASE_URL || 'https://img.arcanaverse.ai';
        try {
          const urlObj = new URL(u);
          u = assetBase + urlObj.pathname + urlObj.search;
        } catch (e) {
          const pathMatch = u.match(/\/assets\/[^?]+/);
          u = assetBase + (pathMatch ? pathMatch[0] : '/assets/persona/placeholder.png');
        }
      }
      if (u.startsWith("http://") || u.startsWith("https://")) return u;
      // buildAssetUrl ì‚¬ìš© (ASSET_BASE_URL ê¸°ë°˜)
      const assetBase = window.ASSET_BASE_URL || window.IMAGE_BASE?.replace('/assets', '') || 'https://img.arcanaverse.ai';
      if (u.startsWith("/")) {
        return assetBase + u;
      }
      return assetBase + "/assets/persona/" + u;
    }
    
    // ê²Œì„ ì„¸ì…˜ì˜ í™œì„± persona ë°˜í™˜ (persona_ref_idë¡œ ë³µêµ¬ ì§€ì›)
    function getActivePersonaForGame() {
      // 0) ì„¸ì…˜ì— player_personaê°€ ì´ë¯¸ "ì¶©ë¶„í•œ ì •ë³´"ë¥¼ ê°–ê³  ìˆìœ¼ë©´ ê·¸ê±¸ ìµœìš°ì„ ìœ¼ë¡œ ì‚¬ìš©
      const sp = currentSession?.player_persona;
      if (sp && (sp.name || sp.image_key || sp.image_url || sp.image?.url)) {
        // preset_XX ì •ë¦¬
        let key = sp.image_key || sp.image?.key || '';
        if (key && key.startsWith('preset_')) {
          const m = key.match(/preset_([MF]\d+)/);
          if (m) key = m[1];
        }

        return {
          persona_ref_id: String(sp.persona_ref_id ?? currentSession?.persona_ref_id ?? sp.persona_id ?? ''),
          persona_id: String(sp.persona_id ?? currentSession?.persona_ref_id ?? ''),
          name: sp.name,
          gender: sp.gender,
          intro: sp.intro || sp.bio || sp.summary || '',
          image_key: key || null,
          image_url: sp.image_url || sp.image?.url || (key ? resolvePersonaUrl(`/assets/persona/${key}.png`) : null),
        };
      }

      // 1) refIdëŠ” ë¬´ì¡°ê±´ ë¬¸ìì—´ë¡œ ì •ê·œí™”í•´ì„œ ë§¤ì¹­ ì‹¤íŒ¨ ì¤„ì´ê¸°
      let refId =
        currentSession?.player_persona?.persona_ref_id ??
        currentSession?.player_persona?._id ??
        currentSession?.persona_ref_id ??
        currentSession?.player_persona?.persona_id ??
        null;

      if (refId != null) refId = String(refId);

      // 2) PERSONAS_LIST ë§¤ì¹­ë„ ë¬¸ìì—´ ë¹„êµë¡œ
      const ps = PERSONAS_LIST || [];
      if (refId && ps.length > 0) {
        const matched = ps.find(p => {
          const a = p.persona_ref_id != null ? String(p.persona_ref_id) : null;
          const b = p._id != null ? String(p._id) : null;
          const c = p.persona_id != null ? String(p.persona_id) : null;
          return a === refId || b === refId || c === refId;
        });

        if (matched) {
          const imageKey = matched.image_key || matched.image?.key || null;
          return {
            persona_ref_id: String(matched.persona_ref_id || matched._id || matched.persona_id || ''),
            persona_id: matched.persona_id != null ? String(matched.persona_id) : null,
            name: matched.name,
            gender: matched.gender,
            intro: matched.intro || matched.bio || matched.summary || '',
            image_key: imageKey,
            image_url: matched.image_url || matched.image?.url || (imageKey ? resolvePersonaUrl(`/assets/persona/${imageKey}.png`) : null),
          };
        }
      }

      // 3) ìµœí›„ fallback: default
      const d = ps.find(p => p.is_default) || ps[0];
      if (!d) return null;

      const imageKey = d.image_key || d.image?.key || null;
      return {
        persona_ref_id: String(d.persona_ref_id || d._id || d.persona_id || ''),
        persona_id: d.persona_id != null ? String(d.persona_id) : null,
        name: d.name,
        gender: d.gender,
        intro: d.intro || d.bio || d.summary || '',
        image_key: imageKey,
        image_url: d.image_url || d.image?.url || (imageKey ? resolvePersonaUrl(`/assets/persona/${imageKey}.png`) : null),
      };
    }

    // í—¤ë”ì˜ persona ë±ƒì§€ ê°±ì‹  (í˜ë¥´ì¡°ë‚˜ ë³€ê²½ ì‹œì—ë§Œ í˜¸ì¶œ, ê¸°ë³¸ í˜ë¥´ì¡°ë‚˜ fallback ë°©ì§€)
    function refreshHeaderPersonaBadge() {
      const persona = getActivePersonaForGame();
      const badgeEl = document.getElementById('headerPersonaBadge');
      const avatarEl = document.getElementById('headerPersonaAvatar');
      const nameEl = document.getElementById('headerPersonaName');
      const personaBtn = document.getElementById('personaBtn');
      
      if (!badgeEl || !avatarEl || !nameEl) {
        console.warn('[PERSONA] Header elements not found');
        return;
      }
      
      console.log('[PERSONA] refreshHeaderPersonaBadge - persona:', persona);
      console.log('[PERSONA] refreshHeaderPersonaBadge - currentSession.player_persona:', currentSession?.player_persona);
      console.log('[PERSONA] refreshHeaderPersonaBadge - currentSession.persona_ref_id:', currentSession?.persona_ref_id);
      
      // âš ï¸ personaê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ í˜ë¥´ì¡°ë‚˜ë¡œ fallbackëœ ê²½ìš°, ê¸°ì¡´ í—¤ë”ë¥¼ ìœ ì§€ (ë®ì–´ì“°ì§€ ì•ŠìŒ)
      if (!persona) {
        console.warn('[PERSONA] No persona found, keeping existing header state');
        // ê¸°ì¡´ í—¤ë” ìƒíƒœë¥¼ ìœ ì§€í•˜ë˜, badgeê°€ ì—†ìœ¼ë©´ Persona ë²„íŠ¼ í‘œì‹œ
        if (badgeEl.style.display === 'none' || !badgeEl.querySelector('img')?.src) {
          badgeEl.style.display = 'none';
          if (personaBtn) {
            personaBtn.style.display = 'inline-block';
            personaBtn.textContent = 'Persona';
          }
        }
        return;
      }
      
      // ê¸°ë³¸ í˜ë¥´ì¡°ë‚˜ë¡œ fallbackëœ ê²½ìš°ë„ ê¸°ì¡´ í—¤ë” ìœ ì§€ (í˜ë¥´ì¡°ë‚˜ ë³€ê²½ ì‹œì—ë§Œ ê°±ì‹ )
      // í˜„ì¬ í—¤ë”ì— ì´ë¯¸ í˜ë¥´ì¡°ë‚˜ê°€ í‘œì‹œë˜ì–´ ìˆê³ , ìƒˆë¡œ ê°€ì ¸ì˜¨ personaê°€ ê¸°ë³¸ í˜ë¥´ì¡°ë‚˜ë©´ ìœ ì§€
      const currentHeaderName = nameEl.textContent;
      const isDefaultPersona = !persona.persona_ref_id || !currentSession?.persona_ref_id || 
                               (persona.name && currentHeaderName && persona.name !== currentHeaderName && 
                                !currentSession?.player_persona?.name);
      
      if (isDefaultPersona && badgeEl.style.display !== 'none' && badgeEl.querySelector('img')?.src && currentHeaderName) {
        console.log('[PERSONA] Default persona fallback detected, keeping existing header state:', currentHeaderName);
        return;
      }
      
      // personaê°€ ìˆìœ¼ë©´ badge í‘œì‹œ
      badgeEl.style.display = 'flex';
      if (personaBtn) personaBtn.style.display = 'none';
      
      // ì´ë¯¸ì§€ URL ì²˜ë¦¬ (image_key ë˜ëŠ” image_url)
      let imageUrl = '';
      if (persona.image_key) {
        imageUrl = resolvePersonaUrl(`/assets/persona/${persona.image_key}.png`);
      } else if (persona.image_url) {
        imageUrl = persona.image_url;
      } else {
        imageUrl = resolvePersonaUrl('/assets/persona/F01.png');
      }
      
      avatarEl.src = imageUrl;
      avatarEl.alt = persona.name || 'persona';
      avatarEl.onerror = function() {
        this.src = resolvePersonaUrl('/assets/persona/F01.png');
      };
      nameEl.textContent = persona.name || 'persona';
      
      console.log('[PERSONA] Header badge updated:', persona.name, imageUrl);
    }

    // í˜ë¥´ì¡°ë‚˜ í”„ë¦¬ë·° í…ìŠ¤íŠ¸ ì¶”ì¶œ
    function getPersonaPreview(p) {
      if (p.bio) return p.bio;
      if (p.summary) return p.summary;
      if (p.detail) return p.detail.substring(0, 120) + (p.detail.length > 120 ? '...' : '');
      if (p.intro) return p.intro;
      return '';
    }

    // í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ì¡°íšŒ
    async function fetchPersonas() {
      try {
        const token = localStorage.getItem('user_info_v2');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['X-User-Info-Token'] = token;
        }

        const res = await fetch(`${API_BASE_URL}/v1/users/me/personas`, {
          credentials: 'include',
          headers
        });

        if (!res.ok) {
          if (res.status === 401) {
            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          }
          throw new Error(`Failed to load: ${res.status}`);
        }

        const personas = await res.json();
        return personas;
      } catch (e) {
        console.error('[PERSONA] Load error:', e);
        throw e;
      }
    }

    // í˜ë¥´ì¡°ë‚˜ ëª¨ë‹¬ ì—´ê¸°
    async function openPersonaModal(forceOpen = false) {
      const modal = document.getElementById('personaModal');
      const body = document.getElementById('personaModalBody');
      const closeBtn = document.getElementById('personaModalClose');
      const cancelBtn = document.getElementById('personaCancelBtn');
      
      isPersonaModalForceOpen = forceOpen;
      
      if (forceOpen) {
        modal.classList.add('force-open');
        if (closeBtn) closeBtn.classList.add('hidden');
        if (cancelBtn) cancelBtn.style.display = 'none';
      } else {
        modal.classList.remove('force-open');
        if (closeBtn) closeBtn.classList.remove('hidden');
        if (cancelBtn) cancelBtn.style.display = 'inline-block';
      }
      
      modal.classList.add('show');
      SELECTED_PERSONA_ID = null;
      body.innerHTML = '<div class="modal-loading">ë¡œë”© ì¤‘...</div>';

      try {
        PERSONAS_LIST = await fetchPersonas();
        renderPersonaList();
      } catch (e) {
        body.innerHTML = `<div class="modal-loading" style="color:#ef4444;">í˜ë¥´ì¡°ë‚˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${e.message}</div>`;
        console.error('[PERSONA] Failed to load personas:', e);
      }
    }

    // í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ë Œë”ë§
    function renderPersonaList() {
      const body = document.getElementById('personaModalBody');
      const selectedInfo = document.getElementById('personaSelectedInfo');
      const confirmBtn = document.getElementById('personaConfirmBtn');
      const cancelBtn = document.getElementById('personaCancelBtn');
      
      if (PERSONAS_LIST.length === 0) {
        // í˜ë¥´ì¡°ë‚˜ê°€ ì—†ì„ ë•Œ: ê°•ì œ ëª¨ë‹¬ í•´ì œ ë° íƒˆì¶œ ë²„íŠ¼ ì œê³µ
        isPersonaModalForceOpen = false;
        const modal = document.getElementById('personaModal');
        const closeBtn = document.getElementById('personaModalClose');
        
        if (modal) modal.classList.remove('force-open');
        if (closeBtn) closeBtn.classList.remove('hidden');
        if (cancelBtn) cancelBtn.style.display = 'inline-block';
        
        body.innerHTML = `
          <div style="text-align:center; padding:40px 20px;">
            <div style="font-size:16px; color:#f3f4f6; margin-bottom:24px;">í˜ë¥´ì¡°ë‚˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div style="font-size:14px; color:#94a3b8; margin-bottom:32px;">My ë©”ë‰´ì—ì„œ í˜ë¥´ì¡°ë‚˜ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</div>
            <div style="display:flex; gap:12px; justify-content:center;">
              <button class="btn-modal primary" onclick="window.location.href='/my.html'">Myë¡œ ì´ë™</button>
            </div>
          </div>
        `;
        selectedInfo.style.display = 'none';
        if (confirmBtn) confirmBtn.style.display = 'none';
        return;
      }
      
      // confirmBtn í‘œì‹œ (í˜ë¥´ì¡°ë‚˜ê°€ ìˆì„ ë•Œ)
      if (confirmBtn) confirmBtn.style.display = 'inline-block';

      // ì¹´ë“œ UIë¡œ ë Œë”ë§
      body.innerHTML = `<div class="persona-list">${PERSONAS_LIST.map(p => {
        const genderText = {
          male: 'ë‚¨ì„±',
          female: 'ì—¬ì„±',
          nonbinary: 'ë…¼ë°”ì´ë„ˆë¦¬'
        }[p.gender] || 'ë…¼ë°”ì´ë„ˆë¦¬';

        // image_key ì²˜ë¦¬
        let imageKey = p.image_key || 'F01';
        if (imageKey && imageKey.startsWith('preset_')) {
          try {
            const num = parseInt(imageKey.replace('preset_', ''));
            if (num <= 4 || num === 9 || num === 10 || num === 13 || num === 15) {
              const mIndex = num <= 4 ? num : (num === 9 ? 5 : num === 10 ? 6 : num === 13 ? 7 : 8);
              imageKey = `M${String(mIndex).padStart(2, '0')}`;
            } else {
              const fIndex = num <= 8 ? num - 4 : (num === 11 ? 3 : num === 12 ? 4 : num === 14 ? 5 : 6);
              imageKey = `F${String(fIndex).padStart(2, '0')}`;
            }
          } catch {
            imageKey = 'F01';
          }
        }
        const imageUrl = resolvePersonaUrl(`/assets/persona/${imageKey}.png`);
        const previewText = getPersonaPreview(p);
        const selected = SELECTED_PERSONA_ID === p.persona_id ? 'selected' : '';
        const defaultClass = p.is_default ? 'default' : '';

        return `
          <div class="persona-card ${selected} ${defaultClass}" onclick="selectPersona('${p.persona_id}')">
            <div class="persona-card-header">
              <img src="${imageUrl}" alt="${escapeHtml(p.name)}" class="persona-avatar" onerror="this.src='${resolvePersonaUrl('/assets/persona/F01.png')}'" />
              <div class="persona-info">
                <div class="persona-name">
                  ${p.is_default ? '<span class="persona-badge">ê¸°ë³¸</span>' : ''}
                  ${escapeHtml(p.name)}
                </div>
                <div class="persona-gender">${genderText}</div>
              </div>
            </div>
            ${previewText ? `<div class="persona-bio">${escapeHtml(previewText)}</div>` : ''}
          </div>
        `;
      }).join('')}</div>`;

      // ì„ íƒëœ í˜ë¥´ì¡°ë‚˜ ì •ë³´ í‘œì‹œ
      if (SELECTED_PERSONA_ID) {
        const selectedPersona = PERSONAS_LIST.find(p => p.persona_id === SELECTED_PERSONA_ID);
        if (selectedPersona) {
          selectedInfo.innerHTML = `ì„ íƒë¨: <strong>${escapeHtml(selectedPersona.name)}</strong>`;
          selectedInfo.style.display = 'block';
          confirmBtn.disabled = false;
        } else {
          selectedInfo.style.display = 'none';
          confirmBtn.disabled = true;
        }
      } else {
        selectedInfo.style.display = 'none';
        confirmBtn.disabled = true;
      }
    }

    // í˜ë¥´ì¡°ë‚˜ ì„ íƒ
    function selectPersona(personaId) {
      SELECTED_PERSONA_ID = personaId;
      renderPersonaList();
    }

    // í˜ë¥´ì¡°ë‚˜ ëª¨ë‹¬ ë‹«ê¸°
    function closePersonaModal() {
      if (isPersonaModalForceOpen) {
        // ê°•ì œ ëª¨ë‹¬ì€ ë‹«ì„ ìˆ˜ ì—†ìŒ
        return;
      }
      
      const modal = document.getElementById('personaModal');
      modal.classList.remove('show');
      modal.classList.remove('force-open');
      SELECTED_PERSONA_ID = null;
      pendingPersonaSelection = null;
    }

    // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
    function showConfirmDialog(message, onConfirm) {
      const dialog = document.getElementById('confirmDialog');
      const messageEl = document.getElementById('confirmDialogMessage');
      
      if (messageEl) {
        messageEl.textContent = message;
      }
      
      dialog.onConfirmCallback = onConfirm;
      dialog.classList.add('show');
    }

    // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
    function closeConfirmDialog(confirmed) {
      const dialog = document.getElementById('confirmDialog');
      dialog.classList.remove('show');
      
      if (confirmed && dialog.onConfirmCallback) {
        dialog.onConfirmCallback();
      }
      
      dialog.onConfirmCallback = null;
    }

    // í˜ë¥´ì¡°ë‚˜ ì„ íƒ ì™„ë£Œ (ì „íˆ¬ ì¤‘ í™•ì¸ í¬í•¨)
    async function confirmPersonaSelection() {
      if (!SELECTED_PERSONA_ID) {
        showToast('í˜ë¥´ì¡°ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!CURRENT_GAME || !CURRENT_GAME.id) {
        console.warn('[PERSONA] No game ID available');
        showToast('ê²Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const selectedPersona = PERSONAS_LIST.find(p => p.persona_id === SELECTED_PERSONA_ID);
      if (!selectedPersona) {
        showToast('ì„ íƒí•œ í˜ë¥´ì¡°ë‚˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì „íˆ¬ ì¤‘ì¸ì§€ í™•ì¸
      const inCombat = currentSession?.combat?.in_combat === true;
      
      if (inCombat) {
        // ì „íˆ¬ ì¤‘ì´ë©´ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        pendingPersonaSelection = selectedPersona;
        showConfirmDialog(
          'ê²Œì„ ì¤‘ì— í˜ë¥´ì¡°ë‚˜ë¥¼ ë³€ê²½í•˜ë©´ ì´í›„ ëŒ€ì‚¬ì™€ ì „íˆ¬ íŒì •ì— ì¦‰ì‹œ ì˜í–¥ì„ ì¤ë‹ˆë‹¤. ì •ë§ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
          () => applyPersonaToGame(selectedPersona)
        );
      } else {
        // ì „íˆ¬ ì¤‘ì´ ì•„ë‹ˆë©´ ì¦‰ì‹œ ì ìš©
        await applyPersonaToGame(selectedPersona);
      }
    }

    // í˜ë¥´ì¡°ë‚˜ë¥¼ ê²Œì„ ì„¸ì…˜ì— ì ìš©
    async function applyPersonaToGame(persona) {
      if (!persona || !CURRENT_GAME || !CURRENT_GAME.id) {
        return;
      }

      const gameId = CURRENT_GAME.id;
      const confirmBtn = document.getElementById('personaConfirmBtn');
      const originalText = confirmBtn ? confirmBtn.textContent : '';
      
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'ì ìš© ì¤‘...';
      }

      try {
        // persona_ref_id ê²°ì •: persona_idë¥¼ ìš°ì„  ì‚¬ìš© (ë°±ì—”ë“œê°€ persona_idë¡œ ì¡°íšŒí•¨)
        const finalRefId = persona.persona_id;
        if (!finalRefId) {
          console.error('[PERSONA] persona_id is required');
          showToast('í˜ë¥´ì¡°ë‚˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.', 2000);
          return;
        }

        // Optimistic UI ì—…ë°ì´íŠ¸
        if (currentSession) {
          currentSession.player_persona = {
            persona_id: persona.persona_id,
            name: persona.name,
            gender: persona.gender,
            intro: persona.intro || persona.bio || persona.summary,
            image_url: persona.image?.url || resolvePersonaUrl(`/assets/persona/${persona.image_key || 'F01'}.png`),
            image_key: persona.image_key || persona.image?.key
          };
          currentSession.persona_ref_id = finalRefId;
          
          // í—¤ë” badge ì¦‰ì‹œ ê°±ì‹ 
          refreshHeaderPersonaBadge();
          
          // âœ… í˜ë¥´ì¡°ë‚˜ ë³€ê²½ ì‹œ game chat ì „ì²´ ë¦¬ë Œë”ë§ (ê¸°ì¡´ ë©”ì‹œì§€ ë°°ì§€ë„ ìƒˆ í˜ë¥´ì¡°ë‚˜ë¡œ í†µì¼)
          console.log('[PERSONA] persona changed, re-rendering game chat');
          renderHudFromSession(currentSession);
          renderChatLogsFromSession(currentSession, { isInitialLoad: true });
        }

        // ì„œë²„ì— ì €ì¥
        const token = localStorage.getItem('user_info_v2');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['X-User-Info-Token'] = token;
        }

        const res = await fetch(`${API_BASE_URL}/v1/games/${gameId}/persona`, {
          method: 'POST',
          credentials: 'include',
          headers,
          body: JSON.stringify({ persona_ref_id: finalRefId })
        });

        if (!res.ok) {
          const errorText = await res.text().catch(() => 'Unknown error');
          console.error(`[PERSONA] API error: ${res.status} ${errorText}`);
          showToast(`í˜ë¥´ì¡°ë‚˜ ì ìš© ì‹¤íŒ¨: HTTP ${res.status}`);
          // TODO: ë¡¤ë°± (ì„ íƒì‚¬í•­)
          return;
        }

        const data = await res.json().catch(() => ({}));
        console.log('[PERSONA] Successfully applied persona:', data);
        
        // ì„œë²„ ì‘ë‹µìœ¼ë¡œ ì„¸ì…˜ ì—…ë°ì´íŠ¸ (canonical ë°ì´í„°)
        if (currentSession && data.player_persona) {
          // image_keyê°€ ì—†ìœ¼ë©´ PERSONAS_LISTì—ì„œ ì°¾ì•„ì„œ ì±„ìš°ê¸° (í”„ë¡ íŠ¸ ë°©ì–´ ë¡œì§)
          if (!data.player_persona.image_key && data.persona_ref_id && PERSONAS_LIST) {
            const foundPersona = PERSONAS_LIST.find(p => p.persona_id === data.persona_ref_id);
            if (foundPersona) {
              const imageKey = foundPersona.image_key || foundPersona.image?.key;
              if (imageKey) {
                data.player_persona.image_key = imageKey;
                console.log('[PERSONA] Filled missing image_key from PERSONAS_LIST:', imageKey);
              }
            }
          }
          
          currentSession.player_persona = data.player_persona;
          currentSession.persona_ref_id = data.persona_ref_id;
          refreshHeaderPersonaBadge();
          
          // âœ… ì„œë²„ ì‘ë‹µ í›„ì—ë„ game chat ì „ì²´ ë¦¬ë Œë”ë§ (ê¸°ì¡´ ë©”ì‹œì§€ ë°°ì§€ë„ ìƒˆ í˜ë¥´ì¡°ë‚˜ë¡œ í†µì¼)
          console.log('[PERSONA] persona updated from server, re-rendering game chat');
          renderHudFromSession(currentSession);
          renderChatLogsFromSession(currentSession, { isInitialLoad: true });
        }
        
        showToast('í˜ë¥´ì¡°ë‚˜ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ê°•ì œ ëª¨ë‹¬ì´ë©´ ë‹«ê¸° ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        if (isPersonaModalForceOpen) {
          isPersonaModalForceOpen = false;
          const modal = document.getElementById('personaModal');
          const closeBtn = document.getElementById('personaModalClose');
          const cancelBtn = document.getElementById('personaCancelBtn');
          modal.classList.remove('force-open');
          if (closeBtn) closeBtn.classList.remove('hidden');
          if (cancelBtn) cancelBtn.style.display = 'inline-block';
        }
        
        closePersonaModal();
      } catch (e) {
        console.error('[PERSONA] Failed to apply persona:', e);
        showToast(`í˜ë¥´ì¡°ë‚˜ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
        // TODO: ë¡¤ë°± (ì„ íƒì‚¬í•­)
      } finally {
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = originalText;
        }
        pendingPersonaSelection = null;
      }
    }

    // í˜„ì¬ í˜ì´ì§€ê°€ /game ì¸ì§€ ì—¬ë¶€
    const isGamePage = window.location.pathname.startsWith('/game') || window.location.pathname.includes('game.html');
    
    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ game_id ì¶”ì¶œ
    let GAME_ID = null;
    if (isGamePage) {
      const params = new URLSearchParams(window.location.search);
      const idParam = params.get('game') || params.get('game_id');
      if (idParam) {
        // 'game_1' í˜•ì‹ì´ë©´ ìˆ«ìë§Œ ì¶”ì¶œ
        const match = idParam.match(/^game_(\d+)$/i);
        GAME_ID = match ? parseInt(match[1], 10) : parseInt(idParam, 10);
      } else if (CURRENT_GAME?.id) {
        GAME_ID = CURRENT_GAME.id;
      }
    }
    
    // HUD / ë‚´ë ˆì´ì…˜ ì˜ì—­ DOM
    const hudEl = document.getElementById('game-hud');
    const narrationEl = document.getElementById('game-narration');

    // ë°±ì—”ë“œ LLM í˜¸ì¶œ
    async function askLLM(message, mode='trpg', choices=0){
      try {
      const token = getToken();
      const userInfoV2 = localStorage.getItem(USER_INFO_KEY);
      const headers = { 
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      };
      
      // JWT ê¸°ë°˜ ì¸ì¦ ì‚¬ìš© (Authorization í—¤ë”)
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      // chat_send ì´ë²¤íŠ¸ ë¡œê¹… (ì±„íŒ… ì›ë¬¸ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
      if (window.logEvent && isGamePage && GAME_ID) {
        window.logEvent(
          window.EVENT.CHAT_SEND,
          'game',
          {
            chat_type: 'game',
            message_len: message ? message.length : 0,
          },
          {
            entity_id: String(GAME_ID),
          }
        );
      }
      
      // ê²Œì„ í˜ì´ì§€ë©´ /v1/games/{id}/turn, ì•„ë‹ˆë©´ /v1/chat/
      const API_URL = isGamePage && GAME_ID
        ? `${API_BASE_URL}/v1/games/${GAME_ID}/turn`
        : `${API_BASE_URL}/v1/chat/`;
      
      // ê²Œì„ í„´ APIëŠ” {user_message: ...} í˜•ì‹, /chatì€ {message: ...} í˜•ì‹
      const payload = isGamePage && GAME_ID
        ? { user_message: message }
        : {
            message, mode,
            model:'trpg-gen', polish_model:'trpg-polish', choices,
            game_id: CURRENT_GAME?.id ?? null,
            game: CURRENT_GAME ? {
              id: CURRENT_GAME.id,
              title: CURRENT_GAME.title,
              scenario_summary: CURRENT_GAME.scenario_summary,
              scenario_detail: CURRENT_GAME.scenario_detail,
              tags: CURRENT_GAME.tags || [],
              world_snapshot: CURRENT_GAME.world_snapshot,
              characters: CURRENT_GAME.characters || [],
            } : null,
          };
        
        console.log('[askLLM] Request URL:', API_URL);
        console.log('[askLLM] API_BASE_URL:', API_BASE_URL);
        console.log('[askLLM] isGamePage:', isGamePage, 'GAME_ID:', GAME_ID);
        console.log('[askLLM] Payload:', payload);
        
        const r = await (window.apiFetch || fetch)(API_URL, {
          method: "POST",
          credentials: "include",
          headers: headers,
          body: JSON.stringify(payload),
        });
        
        console.log('[askLLM] Response status:', r.status, r.statusText);
        console.log('[askLLM] Response headers:', Object.fromEntries(r.headers.entries()));
        
        if (!r.ok) {
          const errorText = await r.text();
          console.error(`[askLLM] HTTP ${r.status} Error:`, errorText);
          throw new Error(`HTTP ${r.status}: ${errorText || 'Server error'}`);
        }
        
      const j = await r.json();
        console.log('[askLLM] Response JSON:', j);
      
      // í„´ ìˆ˜ê°€ ì‘ë‹µìœ¼ë¡œ ì˜¤ë©´ ì œëª© ê°±ì‹ 
      if (j && j.turn !== undefined) {
        updateScenarioTitle(j.turn);
      }
      
      // ë””ë²„ê·¸ ì¶œë ¥
      if (j && j.debug_event) {
        console.log('[EVENT DEBUG]', j.debug_event);
      }
      
      // ê²Œì„ í„´ API ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬
      if (isGamePage && GAME_ID) {
        // === TRPG ê²Œì„ ëª¨ë“œ ì‘ë‹µ ì²˜ë¦¬ ===
        // ë°±ì—”ë“œ ì‘ë‹µì—ì„œ sessionì„ ì§ì ‘ ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€: ì„¸ì…˜ ì „ì²´ êµì²´)
        // í”Œë ˆì´ì–´ ë©”ì‹œì§€ëŠ” ì´ë¯¸ ë°±ì—”ë“œì—ì„œ turn_logsì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ
        // ë¡œì»¬ë¡œ ì¶”ê°€í•˜ì§€ ì•Šê³  ë°±ì—”ë“œê°€ ë‚´ë ¤ì¤€ sessionì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        if (j.session) {
          // ë°±ì—”ë“œ ì‘ë‹µì˜ sessionì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€: ì„¸ì…˜ ì „ì²´ êµì²´)
          const prev = currentSession || null;
          const prevPersonaRefId = prev?.persona_ref_id ?? null;
          const prevPlayerPersona = prev?.player_persona ?? null;

          const prevLength = prev?.turn_logs?.length || 0;
          currentSession = j.session;
          const newLength = currentSession?.turn_logs?.length || 0;

          // âœ… persona ë³´ì¡´: ì„œë²„ê°€ ëˆ„ë½/ë¹ˆê°’ìœ¼ë¡œ ë‚´ë ¤ì¤„ ë•Œ default fallback ë°©ì§€
          // 1) persona_ref_id ë³´ì¡´
          if (!currentSession?.persona_ref_id && prevPersonaRefId) {
            currentSession.persona_ref_id = prevPersonaRefId;
            console.log('[PERSONA][MERGE] preserved persona_ref_id:', prevPersonaRefId);
          }

          // 2) player_persona ë³´ì¡´ (name/image_key/image_url ì¤‘ í•˜ë‚˜ë¼ë„ ì—†ìœ¼ë©´ ë³´ì¡´ ëŒ€ìƒìœ¼ë¡œ íŒë‹¨)
          const sp = currentSession?.player_persona;
          const spHasEnough =
            !!(sp && (sp.name || sp.image_key || sp.image_url || sp.image?.url));

          if (!spHasEnough && prevPlayerPersona) {
            currentSession.player_persona = prevPlayerPersona;
            console.log('[PERSONA][MERGE] preserved player_persona:', prevPlayerPersona?.name);
          }

          console.log("[DEBUG] Using session from response, turn_logs length:", prevLength, "->", newLength);
          
          // âš ï¸ refreshHeaderPersonaBadge() í˜¸ì¶œ ì œê±° - í˜ë¥´ì¡°ë‚˜ ë³€ê²½ ì‹œì—ë§Œ ê°±ì‹ 
          // ì„¸ì…˜ êµì²´ ì‹œì—ëŠ” í—¤ë”ë¥¼ ê°±ì‹ í•˜ì§€ ì•Šì•„ ê¸°ì¡´ í˜ë¥´ì¡°ë‚˜ê°€ ìœ ì§€ë¨
          // refreshHeaderPersonaBadge();
          // âš ï¸ refreshPlayerPersonaBadgesInGameChat()ëŠ” í˜¸ì¶œí•˜ì§€ ì•ŠìŒ - ê¸°ì¡´ ë©”ì‹œì§€ ë°°ì§€ ë³´ì¡´
          
          // 1) HUD ì—…ë°ì´íŠ¸
          renderHudFromSession(currentSession);
          
          // 2) ì±„íŒ… ë¡œê·¸ ì—…ë°ì´íŠ¸ (delta append ë°©ì‹ - ë°°ì§€ ìœ ì§€)
          // ë¡œì»¬ ë©”ì‹œì§€ ë°°ì—´ ì—†ì´ ì˜¤ì§ session.turn_logsë§Œ ë Œë”ë§
          renderChatLogsFromSession(currentSession, { isInitialLoad: false });
          
          // ë””ë²„ê·¸ ë¡œê·¸: persona ì •ë³´ í™•ì¸
          console.log('[PERSONA][POST-ASK] currentSession.persona_ref_id:', currentSession?.persona_ref_id);
          console.log('[PERSONA][POST-ASK] currentSession.player_persona:', currentSession?.player_persona);
          
          // 3) ë‚´ë ˆì´ì…˜ ì—…ë°ì´íŠ¸
          if (narrationEl) {
            const lastNarration = currentSession.turn_logs
              .filter(log => log.speaker_type === 'narration')
              .pop();
            if (lastNarration) {
              narrationEl.textContent = lastNarration.text;
            }
          }
        } else {
          // í´ë°±: ì„¸ì…˜ì„ ë‹¤ì‹œ ë¡œë“œ (í•˜ì§€ë§Œ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ í•œ ë²ˆë§Œ)
          console.warn('[askLLM] j.session not found, loading from API');
          const sessionData = await loadSession(GAME_ID);
          if (sessionData) {
            // persona ë³´ì¡´: ì„œë²„ê°€ ëˆ„ë½/ë¹ˆê°’ìœ¼ë¡œ ë‚´ë ¤ì¤„ ë•Œ default fallback ë°©ì§€
            const prev = currentSession || null;
            const prevPersonaRefId = prev?.persona_ref_id ?? null;
            const prevPlayerPersona = prev?.player_persona ?? null;

            const prevLength = prev?.turn_logs?.length || 0;
            currentSession = sessionData;
            const newLength = currentSession?.turn_logs?.length || 0;

            // âœ… persona ë³´ì¡´: ì„œë²„ê°€ ëˆ„ë½/ë¹ˆê°’ìœ¼ë¡œ ë‚´ë ¤ì¤„ ë•Œ default fallback ë°©ì§€
            // 1) persona_ref_id ë³´ì¡´
            if (!currentSession?.persona_ref_id && prevPersonaRefId) {
              currentSession.persona_ref_id = prevPersonaRefId;
              console.log('[PERSONA][MERGE] preserved persona_ref_id:', prevPersonaRefId);
            }

            // 2) player_persona ë³´ì¡´ (name/image_key/image_url ì¤‘ í•˜ë‚˜ë¼ë„ ì—†ìœ¼ë©´ ë³´ì¡´ ëŒ€ìƒìœ¼ë¡œ íŒë‹¨)
            const sp = currentSession?.player_persona;
            const spHasEnough =
              !!(sp && (sp.name || sp.image_key || sp.image_url || sp.image?.url));

            if (!spHasEnough && prevPlayerPersona) {
              currentSession.player_persona = prevPlayerPersona;
              console.log('[PERSONA][MERGE] preserved player_persona:', prevPlayerPersona?.name);
            }

            console.log("[DEBUG] Loaded session from API, turn_logs length:", prevLength, "->", newLength);
            renderHudFromSession(currentSession);
            renderChatLogsFromSession(currentSession, { isInitialLoad: false });
            
            // ë””ë²„ê·¸ ë¡œê·¸: persona ì •ë³´ í™•ì¸
            console.log('[PERSONA][POST-ASK] currentSession.persona_ref_id:', currentSession?.persona_ref_id);
            console.log('[PERSONA][POST-ASK] currentSession.player_persona:', currentSession?.player_persona);
            if (narrationEl) {
              const lastNarration = currentSession.turn_logs
                .filter(log => log.speaker_type === 'narration')
                .pop();
              if (lastNarration) {
                narrationEl.textContent = lastNarration.text;
              }
            }
          } else {
            console.warn('[askLLM] Session data not available');
          }
        }
        
        return (j.narration || '').trim();
      } else {
        // === ê¸°ì¡´ ì„¸ê³„ê´€ / ì¼ë°˜ ì±„íŒ… ì‘ë‹µ ì²˜ë¦¬ ===
        const answer = j?.answer || j?.message || j?.content || (typeof j === 'string' ? j : '');
        if (answer) {
          addBot(answer);
        }
        return answer;
      }
      } catch(e) {
        console.error('[askLLM] Error:', e);
        console.error('[askLLM] Error stack:', e.stack);
        const errorMsg = e.message || String(e);
        return `(ì˜¤ë¥˜ ë°œìƒ) ${errorMsg}`;
      }
    }

    // ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬
    let currentSession = null;

    // ì„¸ì…˜ ë¡œë”©
    // í„´ ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const scenarioTitleEl = document.querySelector('#game-intro-title');
    
    function updateScenarioTitle(turn) {
      if (!scenarioTitleEl) return;
      
      const t = Number(turn || 0);
      if (!t || t <= 0) {
        scenarioTitleEl.textContent = 'ì†Œê°œ';
      } else {
        scenarioTitleEl.textContent = `ì†Œê°œ - [${t}í„´]`;
      }
    }

    async function loadSession(gameId) {
      try {
        const userInfoV2 = localStorage.getItem(USER_INFO_KEY);
        const headers = { 'Content-Type': 'application/json' };
        
        // user_info_v2 í† í°ì„ í—¤ë”ì— ì¶”ê°€
        if (userInfoV2) {
          headers['X-User-Info-Token'] = userInfoV2;
        }
        
        const res = await fetch(`${API_BASE_URL}/v1/games/${gameId}/session`, {
          method: 'GET',
          credentials: 'include',
          headers: headers,
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        
        // í„´ ìˆ˜ê°€ ì‘ë‹µìœ¼ë¡œ ì˜¤ë©´ ì œëª© ê°±ì‹ 
        if (data && data.turn !== undefined) {
          updateScenarioTitle(data.turn);
        }
        
        return data;
      } catch (error) {
        console.error('[loadSession] Error:', error);
        return null;
      }
    }

    // ì„¸ì…˜ ê¸°ë°˜ HUD ë Œë”ë§
    function renderHudFromSession(session) {
      if (!session || !hudEl) return;
      
      const player = session.player;
      const npcs = session.npcs || [];
      
      hudEl.innerHTML = `
        <div class="game-hud-section">
          <div class="game-hud-title">í”Œë ˆì´ì–´</div>
          <div>HP: ${player.hp} / ${player.hp_max}</div>
          <div>MP: ${player.mp} / ${player.mp_max}</div>
          <div>Gold: ${player.gold}</div>
        </div>
        <div class="game-hud-section">
          <div class="game-hud-title">ë™ë£Œ / NPC</div>
          ${
            npcs.length === 0
              ? '<div class="game-hud-char">ì•„ì§ ë™ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
              : npcs
                  .map((npc) => {
                    return `
                      <div class="game-hud-char">
                        <span class="game-hud-char-name">${escapeHtml(npc.name)}</span>
                        <span class="game-hud-char-stats">
                          <span>HP ${npc.hp}/${npc.hp_max}</span>
                          <span>MP ${npc.mp}/${npc.mp_max}</span>
                        </span>
                      </div>
                    `;
                  })
                  .join('')
          }
        </div>
      `;
      hudEl.style.display = 'flex';
      hudEl.style.gap = '24px';
      hudEl.style.color = '#f5f5f5';
    }

    // ìºë¦­í„° ë§µ ìƒì„± (characters_info ê¸°ë°˜ - idì™€ name ë‘˜ ë‹¤ë¡œ ë§¤í•‘)
    // ë°˜ë“œì‹œ session.characters_infoë§Œ ì‚¬ìš© (game.characters_info ì œê±°)
    function buildCharacterMaps(session) {
      const infoList = session?.characters_info || [];
      
      // idë¡œ ë§¤í•‘í•˜ëŠ” ë§µ
      const byId = new Map();
      // nameìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ë§µ
      const byName = new Map();
      
      // session.characters_infoë§Œ ì‚¬ìš©
      infoList.forEach((c) => {
        const snap = c.snapshot;
        if (!snap) return;
        
        const charId = Number(c.char_ref_id);
        if (!Number.isNaN(charId) && charId) {
          byId.set(charId, snap);
        }
        if (snap.name) {
          byName.set(snap.name.trim(), snap);
        }
      });
      
      console.log("[DEBUG] characterMaps", { 
        infoList,
        byId: Array.from(byId.entries()),
        byName: Array.from(byName.entries())
      });
      
      return { byId, byName };
    }

    // ì•„ë°”íƒ€ URL ê³„ì‚° í•¨ìˆ˜ (í˜ì´ì§€ ë ˆë²¨ì—ì„œ ê³„ì‚°)
    function getAvatarForLog(log, characterMaps, session) {
      const { byId, byName } = characterMaps;
      
      let rawUrl = null;
      let name = log.speaker_name || undefined;
      
      if (log.speaker_type === 'npc' || log.speaker_type === 'monster') {
        const id = log.speaker_id != null ? Number(log.speaker_id) : NaN;
        let snapshot = null;
        
        // 1ì°¨: speaker_idë¡œ ì°¾ê¸°
        if (!Number.isNaN(id)) {
          snapshot = byId.get(id);
        }
        
        // 2ì°¨: speaker_nameìœ¼ë¡œ ì°¾ê¸°
        if (!snapshot && name) {
          snapshot = byName.get(name.trim());
        }
        
        // 3ì°¨: ì„¸ì…˜ì˜ npcsì—ì„œ ì°¾ê¸° (fallback)
        if (!snapshot && log.speaker_id != null) {
          const npc = session.npcs?.find(n => n.id === Number(log.speaker_id));
          if (npc) {
            snapshot = { image_url: npc.image_url, name: npc.name };
          }
        }
        
        if (snapshot) {
          rawUrl = snapshot.image_url || null;
          if (!name) name = snapshot.name || 'NPC';
        } else {
          if (!name) name = 'NPC';
        }
      } else if (log.speaker_type === 'player') {
        rawUrl = null; // í”Œë ˆì´ì–´ëŠ” ì•„ë°”íƒ€ ì—†ìŒ
        if (!name) name = 'í”Œë ˆì´ì–´';
      }
      
      // ë°°ê²½ ì´ë¯¸ì§€ì²˜ëŸ¼ ì²˜ë¦¬: ì´ë¯¸ í’€ URLì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ resolveAssetUrlë¡œ ë³€í™˜
      let avatarUrl = '';
      if (rawUrl) {
        // ì´ë¯¸ í’€ URLì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë°°ê²½ ì´ë¯¸ì§€ì™€ ë™ì¼í•œ ë°©ì‹)
        if (rawUrl.startsWith("http://") || rawUrl.startsWith("https://")) {
          avatarUrl = rawUrl;
        } else {
          // ìƒëŒ€ ê²½ë¡œë©´ R2 Public URLë¡œ ë³€í™˜
          avatarUrl = resolveAssetUrl(rawUrl);
        }
      } else {
        avatarUrl = resolveAssetUrl('/assets/img/placeholder.jpg');
      }
      
      console.log("[DEBUG] avatarForLog", { 
        log: { speaker_type: log.speaker_type, speaker_id: log.speaker_id, speaker_name: log.speaker_name },
        rawUrl,
        avatarUrl,
        name
      });
      
      return { avatarUrl, name };
    }

    // ì¤‘ë³µ ë©”ì‹œì§€ í•„í„°ë§ í•¨ìˆ˜
    function dedupeMessages(messages) {
      const seen = new Map();
      
      const normalize = (t) => {
        if (!t || typeof t !== 'string') return '';
        return t.replace(/[.!\s]+$/g, "");  // ëì˜ . ! ê³µë°± ì œê±°
      };
      
      return messages.filter(msg => {
        // turn, speaker_type, speaker_id, textë¡œ ê³ ìœ  í‚¤ ìƒì„±
        const turn = msg.turn || 0;
        const speakerType = msg.speaker_type || '';
        const speakerId = msg.speaker_id || '';
        const normalizedText = normalize(msg.text || '');
        const key = `${turn}-${speakerType}-${speakerId}-${normalizedText}`;
        
        if (seen.has(key)) {
          console.log("[DEBUG] Dedupe: skipping duplicate message", key);
          return false;
        }
        seen.set(key, true);
        return true;
      });
    }

    // ê²Œì„ ë©”ì‹œì§€ ID ìƒì„± (ì•ˆì •ì  ID ë³´ì¥)
    function getGameMessageId(log) {
      if (log.id) return String(log.id);
      return `${log.turn || 0}-${log.speaker_type || 'unknown'}-${log.speaker_id || ''}`;
    }

    // ë©”ì‹œì§€ role ë¶„ë¥˜ (player/npc/narrator) - actionì€ modifierë¡œ ì²˜ë¦¬
    function getLogRole(log) {
      const st = String(log?.speaker_type ?? '').toLowerCase();
      if (st === 'player') return 'player';
      if (st === 'npc' || st === 'monster') return 'npc';
      return 'narrator';
    }

    // persona ë¯¸ë‹ˆ ë°°ì§€ ìƒì„± (ìŠ¤íƒ¬í”„ ìŠ¤íƒ€ì¼)
    function createMiniPersonaBadge(persona) {
      if (!persona) return null;

      const badge = document.createElement('div');
      badge.className = 'persona-badge persona-badge--mini';
      badge.title = `${persona.name ?? 'persona'}`;

      // persona ì´ë¯¸ì§€ URL ìƒì„± (ë‹¤ì–‘í•œ ì…ë ¥ êµ¬ì¡° ì§€ì›, resolvePersonaUrlë¡œ í†µì¼)
      let src = '';
      // ìš°ì„ ìˆœìœ„: image_url > image?.url > image_key > image?.key > fallback
      if (persona.image_url) {
        src = persona.image_url;
      } else if (persona.image?.url) {
        src = persona.image.url;
      } else {
        let key = persona.image_key || persona.image?.key || '';
        if (key && key.startsWith('preset_')) {
          const m = key.match(/preset_([MF]\d+)/);
          if (m) key = m[1];
        }
        // resolvePersonaUrlì€ /assets/persona/... í˜•íƒœì˜ ê²½ë¡œë¥¼ ë°›ìŒ
        if (key) {
          src = resolvePersonaUrl(`/assets/persona/${key}.png`);
        } else {
          // ìµœì¢… fallback
          src = resolvePersonaUrl('/assets/persona/F01.png');
        }
      }

      if (src) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = persona.name ?? 'persona';
        img.onerror = function() {
          this.src = resolvePersonaUrl('/assets/persona/F01.png');
        };
        badge.appendChild(img);
      } else {
        const fallback = document.createElement('span');
        fallback.className = 'persona-badge__fallback';
        fallback.textContent = String(persona.name ?? 'P').slice(0, 1).toUpperCase();
        badge.appendChild(fallback);
      }

      return badge;
    }

    // ê²Œì„ ë©”ì‹œì§€ ë…¸ë“œ ìƒì„± (role + action modifier ë°©ì‹)
    function createGameMessageElement(log, session) {
      const role = getLogRole(log);
      const isAction = !!log?.is_action;
      const messageId = getGameMessageId(log);

      // ê³µí†µ row (role + action modifier)
      const row = document.createElement('div');
      row.className = `game-msg game-msg--${role}` + (isAction ? ' game-msg--action' : '');
      row.setAttribute('data-message-id', messageId);
      row.dataset.turn = String(log?.turn ?? '');
      row.dataset.speakerType = String(log?.speaker_type ?? '');
      row.dataset.isAction = String(isAction);

      // âœ… NPC: ì•„ë°”íƒ€ë¥¼ bubble "ë°–(ì¢Œì¸¡)"ì— ë¶™ì´ê¸°
      if (role === 'npc') {
        try {
          const characterMaps = buildCharacterMaps(session);
          const { avatarUrl, name } = getAvatarForLog(log, characterMaps, session);

          const av = document.createElement('div');
          av.className = 'game-avatar';
          av.title = name || 'NPC';

          if (avatarUrl) {
            av.style.backgroundImage = `url("${avatarUrl}")`;
          } else {
            av.textContent = (name || 'N').slice(0, 1).toUpperCase();
            av.classList.add('game-avatar--fallback');
          }

          row.appendChild(av);
        } catch (e) {
          console.warn('[createGameMessageElement] NPC avatar creation failed:', e);
        }
      }

      // bubble/card
      const bubble = document.createElement('div');
      bubble.className = 'game-bubble';

      // âœ… action UIëŠ” role ìœ ì§€í•œ ì±„ë¡œ modifierì¼ ë•Œë§Œ
      if (isAction) {
        const head = document.createElement('div');
        head.className = 'game-action-head';
        head.textContent = 'ACTION';
        bubble.appendChild(head);
      }

      // ë‚´ìš©
      const content = document.createElement('div');
      content.className = 'game-content';
      
      // renderMessageText() ì‚¬ìš© (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      const textContent = renderMessageText(log?.text ?? '');
      if (textContent.includes('<em>')) {
        content.innerHTML = textContent;
      } else {
        content.textContent = log?.text ?? '';
      }
      bubble.appendChild(content);

      // âœ… narrator: narrator í‘œì‹(ì‘ê²Œ)
      if (role === 'narrator') {
        const tag = document.createElement('div');
        tag.className = 'game-narrator-tag';
        tag.textContent = 'NARRATOR';
        bubble.appendChild(tag);
      }

      // bubbleì„ rowì— append
      row.appendChild(bubble);

      // âœ… player: is_action ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ persona badge (bubble ë°–, í˜•ì œë¡œ)
      if (role === 'player') {
        // âš ï¸ ìš°ì„ ìˆœìœ„: 1) ì„¸ì…˜ì˜ player_persona (ê°€ì¥ í™•ì‹¤), 2) logì˜ persona_id, 3) í˜„ì¬ í™œì„± persona
        let persona = null;
        let personaId = null;
        
        // 1) ì„¸ì…˜ì˜ player_personaë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì‚¬ìš© (ì„¸ì…˜ êµì²´ ì§í›„ì—ë„ ì•ˆì •ì )
        const sp = session?.player_persona || currentSession?.player_persona;
        if (sp && (sp.name || sp.image_key || sp.image_url || sp.image?.url)) {
          // preset_XX ì •ë¦¬
          let key = sp.image_key || sp.image?.key || '';
          if (key && key.startsWith('preset_')) {
            const m = key.match(/preset_([MF]\d+)/);
            if (m) key = m[1];
          }
          
          persona = {
            persona_ref_id: String(sp.persona_ref_id ?? session?.persona_ref_id ?? currentSession?.persona_ref_id ?? sp.persona_id ?? ''),
            persona_id: String(sp.persona_id ?? session?.persona_ref_id ?? currentSession?.persona_ref_id ?? ''),
            name: sp.name,
            gender: sp.gender,
            intro: sp.intro || sp.bio || sp.summary || '',
            image_key: key || null,
            image_url: sp.image_url || sp.image?.url || (key ? resolvePersonaUrl(`/assets/persona/${key}.png`) : null),
          };
          personaId = persona.persona_ref_id || persona.persona_id;
          console.log('[DEBUG] createGameMessageElement: using session player_persona:', persona.name, persona.image_key);
        }
        
        // 2) logì— persona_idê°€ ìˆìœ¼ë©´ í•´ë‹¹ personaë¥¼ PERSONAS_LISTì—ì„œ ì°¾ê¸°
        if (!persona && (log?.persona_id || log?.persona_ref_id)) {
          personaId = log.persona_id || log.persona_ref_id;
          if (personaId && PERSONAS_LIST && PERSONAS_LIST.length > 0) {
            const matched = PERSONAS_LIST.find(p => {
              const a = p.persona_ref_id != null ? String(p.persona_ref_id) : null;
              const b = p._id != null ? String(p._id) : null;
              const c = p.persona_id != null ? String(p.persona_id) : null;
              const targetId = String(personaId);
              return a === targetId || b === targetId || c === targetId;
            });
            if (matched) {
              persona = {
                persona_ref_id: String(matched.persona_ref_id || matched._id || matched.persona_id || ''),
                persona_id: matched.persona_id != null ? String(matched.persona_id) : null,
                name: matched.name,
                gender: matched.gender,
                intro: matched.intro || matched.bio || matched.summary || '',
                image_key: matched.image_key || matched.image?.key,
                image_url: matched.image_url || matched.image?.url || (matched.image_key ? resolvePersonaUrl(`/assets/persona/${matched.image_key}.png`) : null),
              };
              console.log('[DEBUG] createGameMessageElement: matched persona from log persona_id:', persona.name);
            }
          }
        }
        
        // 3) SELECTED_PERSONA_ID í™•ì¸ (ì‚¬ìš©ìê°€ ì„ íƒí•œ í˜ë¥´ì¡°ë‚˜ ìš°ì„ )
        if (!persona) {
          console.log('[DEBUG] createGameMessageElement: checking SELECTED_PERSONA_ID:', SELECTED_PERSONA_ID, 'PERSONAS_LIST length:', PERSONAS_LIST?.length || 0);
          if (SELECTED_PERSONA_ID && PERSONAS_LIST && PERSONAS_LIST.length > 0) {
            const selectedPersona = PERSONAS_LIST.find(p => p.persona_id === SELECTED_PERSONA_ID);
            console.log('[DEBUG] createGameMessageElement: found selectedPersona:', selectedPersona?.name || 'null');
            if (selectedPersona) {
              persona = {
                persona_ref_id: String(selectedPersona.persona_ref_id || selectedPersona._id || selectedPersona.persona_id || ''),
                persona_id: selectedPersona.persona_id != null ? String(selectedPersona.persona_id) : null,
                name: selectedPersona.name,
                gender: selectedPersona.gender,
                intro: selectedPersona.intro || selectedPersona.bio || selectedPersona.summary || '',
                image_key: selectedPersona.image_key || selectedPersona.image?.key,
                image_url: selectedPersona.image_url || selectedPersona.image?.url || (selectedPersona.image_key ? resolvePersonaUrl(`/assets/persona/${selectedPersona.image_key}.png`) : null),
              };
              personaId = persona.persona_ref_id || persona.persona_id;
              console.log('[DEBUG] createGameMessageElement: using SELECTED_PERSONA_ID:', persona.name);
            }
          }
        }
        
        // 4) í˜„ì¬ í™œì„± persona ì‚¬ìš© (fallback)
        if (!persona) {
          console.log('[DEBUG] createGameMessageElement: calling getActivePersonaForGame() - currentSession.persona_ref_id:', currentSession?.persona_ref_id, 'currentSession.player_persona:', currentSession?.player_persona);
          persona = getActivePersonaForGame();
          if (persona) {
            personaId = persona.persona_ref_id || persona.persona_id;
            console.log('[DEBUG] createGameMessageElement: using active persona as fallback:', persona.name, persona.image_key);
          } else {
            console.warn('[DEBUG] createGameMessageElement: no persona found for player message');
          }
        }
        
        // persona_idë¥¼ data attributeë¡œ ì €ì¥ (ê¸°ì¡´ ë©”ì‹œì§€ ë³´ì¡´ìš©)
        if (personaId) {
          row.setAttribute('data-persona-id', String(personaId));
        }
        
        // ë°°ì§€ ìƒì„±
        const badge = createMiniPersonaBadge(persona);
        if (badge) {
          // ë°°ì§€ì—ë„ persona_id ì €ì¥
          if (personaId) {
            badge.setAttribute('data-persona-id', String(personaId));
          }
          row.appendChild(badge); // bubble í˜•ì œë¡œ append
        }
      }

      return row;
    }

    // ê²Œì„ ë©”ì‹œì§€ ë…¸ë“œë¥¼ ì±„íŒ… ì»¨í…Œì´ë„ˆì— append
    function appendGameMessage(log, session) {
      const chatEl = document.getElementById('chat');
      if (!chatEl) return;
      
      const row = createGameMessageElement(log, session);
      chatEl.appendChild(row);
      
      // ê¸°ì¡´ ìŠ¤í¬ë¡¤ ì •ì±… ìœ ì§€ (ìë™ ë°”ë‹¥)
      const chatContainer = document.querySelector('.game-chat-log');
      if (chatContainer) {
        setTimeout(() => {
          const bottomMarker = document.getElementById('chat-bottom-marker');
          if (bottomMarker) {
            bottomMarker.scrollIntoView({ behavior: 'smooth', block: 'end' });
          } else {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }, 50);
      }
    }

    // ì„¸ì…˜ ê¸°ë°˜ ì±„íŒ… ë¡œê·¸ ë Œë”ë§ (delta append ë°©ì‹ - ë°°ì§€ ìœ ì§€)
    function renderChatLogsFromSession(session, opts = { isInitialLoad: false }) {
      if (!session) {
        console.warn("[DEBUG] renderChatLogsFromSession: no session");
        return;
      }
      
      const chatEl = document.getElementById('chat');
      if (!chatEl) {
        console.warn("[DEBUG] renderChatLogsFromSession: chat element not found");
        return;
      }
      
      // ì´ˆê¸° ë¡œë“œ ì‹œì—ë§Œ ì „ì²´ ë¹„ìš°ê¸° (ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ë¹„ìš°ì§€ ì•ŠìŒ)
      if (opts.isInitialLoad) {
        const beforeLength = chatEl.children.length;
        chatEl.innerHTML = '';
        console.log("[DEBUG] renderChatLogsFromSession: initial load, cleared", beforeLength, "existing messages");
      } else {
        // ì—…ë°ì´íŠ¸ ëª¨ë“œ: ê¸°ì¡´ ë©”ì‹œì§€ ID ìˆ˜ì§‘ (ì¡´ì¬í•˜ëŠ” ë©”ì‹œì§€ ì¶”ì )
        const existingIds = new Set(
          Array.from(chatEl.querySelectorAll('[data-message-id]'))
            .map(el => el.getAttribute('data-message-id'))
            .filter(Boolean)
        );
        console.log("[DEBUG] renderChatLogsFromSession: update mode, existing messages:", existingIds.size);
        
        // ì„¸ì…˜ì˜ turn_logsì—ì„œ ì¤‘ë³µ ì œê±°
        const rawLogs = session.turn_logs || [];
        const logs = dedupeMessages(rawLogs);
        
        // ì•„ì§ ì—†ëŠ” ë©”ì‹œì§€ë§Œ append (delta append)
        let newCount = 0;
        logs.forEach((log) => {
          if (log.speaker_type === 'narration') {
            return;
          }
          
          const messageId = getGameMessageId(log);
          if (!existingIds.has(messageId)) {
            appendGameMessage(log, session);
            newCount++;
          }
        });
        console.log("[DEBUG] renderChatLogsFromSession: appended", newCount, "new messages");
        
        // ì„ íƒì§€ ë²„íŠ¼ ì²˜ë¦¬ (ë§ˆì§€ë§‰ í„´ë§Œ)
        const actionsEl = document.getElementById('game-turn-actions');
        if (actionsEl && logs.length > 0) {
          const lastLog = logs[logs.length - 1];
          const choices = lastLog?.choices || lastLog?.meta?.choices || [];
          if (choices.length > 0) {
            actionsEl.innerHTML = '';
            choices.forEach((choice) => {
              const btn = document.createElement('button');
              btn.textContent = choice.text || choice;
              btn.onclick = () => {
                const choiceText = choice.text || choice;
                const ta = document.getElementById('ta');
                if (ta) {
                  ta.value = choiceText;
                  const sendBtn = document.getElementById('send');
                  if (sendBtn) sendBtn.click();
                }
              };
              actionsEl.appendChild(btn);
            });
          }
        }
        
        return; // ì—…ë°ì´íŠ¸ ëª¨ë“œëŠ” ì—¬ê¸°ì„œ ì¢…ë£Œ
      }
      
      // ì´ˆê¸° ë¡œë“œ ëª¨ë“œ: ì „ì²´ ë Œë”ë§
      // ìºë¦­í„° ë§µ ìƒì„± (idì™€ name ë‘˜ ë‹¤ë¡œ ë§¤í•‘) - sessionë§Œ ì‚¬ìš©
      const characterMaps = buildCharacterMaps(session);
      
      // ì„¸ì…˜ì˜ turn_logsë¥¼ ë Œë”ë§ (ì˜¤ì§ session.turn_logsë§Œ ì‚¬ìš©)
      // ì¤‘ë³µ ë©”ì‹œì§€ í•„í„°ë§ ì ìš©
      const rawLogs = session.turn_logs || [];
      const logs = dedupeMessages(rawLogs);
      console.log("[DEBUG] turn_logs length", rawLogs.length, "-> deduped", logs.length);
      
      logs.forEach((log) => {
        if (log.speaker_type === 'narration') {
          // ë‚´ë ˆì´ì…˜ì€ ë³„ë„ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (ë…¸ë€ ì˜ì—­ì—ë§Œ í‘œì‹œ)
          return;
        }
        
        appendGameMessage(log, session);
      });
      
      // ë§ˆì§€ë§‰ í„´ì˜ ì„ íƒì§€ ì²˜ë¦¬ (í•œ ë²ˆë§Œ, ì¤‘ë³µ ë°©ì§€)
      const actionsEl = document.getElementById('game-turn-actions');
      if (logs.length > 0 && actionsEl) {
        const lastLog = logs[logs.length - 1];
        const choices = lastLog?.choices || lastLog?.meta?.choices || [];
        console.log("[DEBUG] Rendering choices for last log:", choices.length, "choices");
        if (choices.length > 0) {
          // ì¤‘ë³µ ë°©ì§€: ê¸°ì¡´ ë²„íŠ¼ ì œê±° í›„ ì¶”ê°€
          actionsEl.innerHTML = '';
          choices.forEach((choice, index) => {
            const btn = document.createElement('button');
            btn.textContent = choice.text || choice;
            btn.onclick = () => {
              const choiceText = choice.text || choice;
              const ta = document.getElementById('ta');
              if (ta) {
                ta.value = choiceText;
                const sendBtn = document.getElementById('send');
                if (sendBtn) sendBtn.click();
              }
            };
            actionsEl.appendChild(btn);
          });
        }
      }
      
      // ìë™ ìŠ¤í¬ë¡¤ (í•˜ë‹¨ ë§ˆì»¤ë¡œ) - ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ í›„ ì‹¤í–‰
      // window.scrollToëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì±„íŒ… ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        const bottomMarker = document.getElementById('chat-bottom-marker');
        const chatContainer = chatEl.closest('.game-chat-log');
        if (bottomMarker && chatContainer) {
          // ì±„íŒ… ë¡œê·¸ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤
          bottomMarker.scrollIntoView({ behavior: 'smooth', block: 'end' });
        } else if (chatEl) {
          // í´ë°±: ì§ì ‘ ìŠ¤í¬ë¡¤
          chatEl.scrollTop = chatEl.scrollHeight;
        }
      }, 100);
    }

    // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ë Œë”ë§ (*ëŒ€ì‚¬* â†’ ê¸°ìš¸ì„ì²´)
    function renderMessageText(text) {
      if (!text) return '';
      
      // *í…ìŠ¤íŠ¸* íŒ¨í„´ ì°¾ê¸°
      const actionPattern = /^\*(.+?)\*$/;
      const match = text.match(actionPattern);
      
      if (match && match[1]) {
        return `<em>${escapeHtml(match[1])}</em>`;
      }
      
      return escapeHtml(text);
    }

    // player ë©”ì‹œì§€ ë°°ì§€ ê°±ì‹  (í˜ë¥´ì¡°ë‚˜ ë³€ê²½ ì‹œì—ë§Œ í˜¸ì¶œ, ê¸°ì¡´ ë©”ì‹œì§€ì˜ persona_idëŠ” ë³´ì¡´)
    function refreshPlayerPersonaBadgesInGameChat() {
      try {
        const persona = getActivePersonaForGame();
        if (!persona) {
          console.log('[PERSONA] No active persona, skipping badge refresh');
          return;
        }

        const playerRows = document.querySelectorAll('.game-msg--player');
        let updated = 0;
        let preserved = 0;

        playerRows.forEach(row => {
          // ê¸°ì¡´ ë©”ì‹œì§€ì˜ persona_id í™•ì¸ (data attributeì—ì„œ)
          const existingPersonaId = row.getAttribute('data-persona-id');
          
          // persona_idê°€ ìˆìœ¼ë©´ í•´ë‹¹ personaë¥¼ ì°¾ì•„ì„œ ì‚¬ìš© (ê¸°ì¡´ ë©”ì‹œì§€ ë³´ì¡´)
          if (existingPersonaId && PERSONAS_LIST && PERSONAS_LIST.length > 0) {
            const matched = PERSONAS_LIST.find(p => {
              const a = p.persona_ref_id != null ? String(p.persona_ref_id) : null;
              const b = p._id != null ? String(p._id) : null;
              const c = p.persona_id != null ? String(p.persona_id) : null;
              const targetId = String(existingPersonaId);
              return a === targetId || b === targetId || c === targetId;
            });
            
            if (matched) {
              // ê¸°ì¡´ personaë¡œ ë°°ì§€ ê°±ì‹ 
              const preservedPersona = {
                persona_ref_id: String(matched.persona_ref_id || matched._id || matched.persona_id || ''),
                persona_id: matched.persona_id != null ? String(matched.persona_id) : null,
                name: matched.name,
                gender: matched.gender,
                intro: matched.intro || matched.bio || matched.summary || '',
                image_key: matched.image_key || matched.image?.key,
                image_url: matched.image_url || matched.image?.url || (matched.image_key ? resolvePersonaUrl(`/assets/persona/${matched.image_key}.png`) : null),
              };
              
              // ê¸°ì¡´ ë°°ì§€ ì œê±°
              row.querySelectorAll('.persona-badge--mini').forEach(b => b.remove());
              
              // ê¸°ì¡´ personaë¡œ ìƒˆ ë°°ì§€ ìƒì„±
              const badge = createMiniPersonaBadge(preservedPersona);
              if (badge) {
                badge.setAttribute('data-persona-id', String(existingPersonaId));
                row.appendChild(badge);
                preserved++;
              }
              return;
            }
          }
          
          // persona_idê°€ ì—†ê±°ë‚˜ ë§¤ì¹­ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ í˜„ì¬ í™œì„± persona ì‚¬ìš© (ìƒˆ ë©”ì‹œì§€ ë˜ëŠ” í˜ë¥´ì¡°ë‚˜ ë³€ê²½)
          // ê¸°ì¡´ ë°°ì§€ ì œê±°
          row.querySelectorAll('.persona-badge--mini').forEach(b => b.remove());
          
          // í˜„ì¬ í™œì„± personaë¡œ ë°°ì§€ ìƒì„±
          const badge = createMiniPersonaBadge(persona);
          if (badge) {
            // í˜„ì¬ í™œì„± persona_id ì €ì¥
            const currentPersonaId = persona.persona_ref_id || persona.persona_id;
            if (currentPersonaId) {
              badge.setAttribute('data-persona-id', String(currentPersonaId));
              row.setAttribute('data-persona-id', String(currentPersonaId));
            }
            row.appendChild(badge);
            updated++;
          }
        });

        if (updated > 0 || preserved > 0) {
          console.log(`[PERSONA] Updated ${updated} badges, preserved ${preserved} badges with original persona`);
        }
      } catch (e) {
        console.error('[PERSONA] Error refreshing player badges:', e);
      }
    }

    // ì´ˆê¸°í™”
    // .top-hud(.game-hero-card) width ë™ê¸°í™” í•¨ìˆ˜
    // ì£¼ì˜: CSS game-inner-widthë¡œ ê³ ì • í­ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë™ì  width ì„¤ì •ì€ ì œê±°
    // function syncHudWidth() {
    //   const topHud = document.querySelector('.top-hud') || document.querySelector('.game-hero-card');
    //   if (topHud) {
    //     const hudWidth = topHud.clientWidth;
    //     document.documentElement.style.setProperty('--hud-width', hudWidth + 'px');
    //     console.log('[HUD Width] Synced to:', hudWidth + 'px');
    //   }
    // }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ HUD í­ ë™ê¸°í™”
    // CSS game-inner-widthë¡œ ê³ ì • í­ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì œê±°
    // window.addEventListener('resize', () => {
    //   syncHudWidth();
    // });

    document.addEventListener('DOMContentLoaded', async ()=>{
      // HUD í­ ë™ê¸°í™” ì œê±° - CSS game-inner-widthë¡œ ê³ ì • í­ ì‚¬ìš©
      // syncHudWidth();
      console.log("[DEBUG] Rendering game chat template - apps/web-html/game.html");
      
      // ë’¤ë¡œê°€ê¸°
      document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); else location.href='/home.html'; };
      
      // Persona ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      const personaBtn = document.getElementById('personaBtn');
      const headerPersonaBadge = document.getElementById('headerPersonaBadge');
      if (personaBtn) personaBtn.onclick = () => openPersonaModal(false);
      if (headerPersonaBadge) headerPersonaBadge.onclick = () => openPersonaModal(false);
      
      // ëª¨ë‹¬ backdrop í´ë¦­ìœ¼ë¡œ ë‹«ê¸° (ê°•ì œ ëª¨ë‹¬ì´ ì•„ë‹ ë•Œë§Œ)
      document.getElementById('personaModal').addEventListener('click', (e) => {
        if (e.target.id === 'personaModal' && !isPersonaModalForceOpen) {
          closePersonaModal();
        }
      });

      // URL â†’ ê²Œì„ id ì •ê·œí™”
      const raw  = qs('game') || qs('game_id') || null;
      const norm = normalizeGameId(raw) || 1;
      dbg('[param] raw='+raw+' norm='+norm);

      // ìƒì„¸ API í˜¸ì¶œ
      let game=null;
      try { game = await fetchGame(norm); }
      catch(e){ dbg('[error] '+e.message); game = {id:norm, title:'ë¯¸í™•ì¸ ê²Œì„', background_image_path:'/assets/img/placeholder.jpg', scenario_summary:'ì •ë³´ ì—†ìŒ'}; }
      CURRENT_GAME = game;
      paintGame(game);
      
      // ì´ë¯¸ì§€ ë¡œë“œ í›„ HUD í­ ì¬ë™ê¸°í™” ì œê±° - CSS game-inner-widthë¡œ ê³ ì • í­ ì‚¬ìš©
      // setTimeout(() => {
      //   syncHudWidth();
      // }, 100);
      
      // ì„¸ì…˜ ë¡œë”© (ì´ˆê¸° ë¡œë“œë§Œ - gameIdë§Œ ì˜ì¡´ì„±, session/turn_logsëŠ” ì˜ì¡´ì„±ì— ë„£ì§€ ì•ŠìŒ)
      const sessionData = await loadSession(norm);
      if (sessionData) {
        // ìµœì´ˆ ì„¸ì…˜ ë¡œë“œ ì‹œ í„´ ìˆ˜ í‘œì‹œ
        if (sessionData.turn !== undefined) {
          updateScenarioTitle(sessionData.turn);
        }
        // ë°±ì—”ë“œê°€ ì„¸ì…˜ ê°ì²´ë¥¼ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        currentSession = sessionData;
        console.log("[DEBUG] Initial session load, turn_logs length:", currentSession.turn_logs.length);
        
        // 1) HUD ë¨¼ì €
        renderHudFromSession(currentSession);
        
        // 2) personas ë¨¼ì € ë¡œë“œ (ê°€ëŠ¥í•˜ë©´ ì—¬ê¸°ì„œ)
        try {
          PERSONAS_LIST = await fetchPersonas();
        } catch (e) {
          console.warn('[GAME][BOOTSTRAP] Failed to load personas:', e);
        }
        
        // 3) header ê°±ì‹ 
        refreshHeaderPersonaBadge();
        
        // 4) ì±„íŒ… ë Œë” (ì´ ì‹œì ì—ëŠ” PERSONAS_LISTê°€ ì±„ì›Œì ¸ì„œ ë°°ì§€ ìƒì„± ê°€ëŠ¥)
        renderChatLogsFromSession(currentSession, { isInitialLoad: true });
        
        // 5) í˜¹ì‹œ still null ì¼€ì´ìŠ¤(ì„¸ì…˜ì— player_persona ìˆê³  personas ì—†ì–´ë„) ëŒ€ë¹„ í›„ì²˜ë¦¬ í•œë²ˆ ë”
        refreshPlayerPersonaBadgesInGameChat();
        
        // ë‚´ë ˆì´ì…˜ ì˜ì—­ ì—…ë°ì´íŠ¸
        if (narrationEl && currentSession.turn_logs.length > 0) {
          const lastNarration = currentSession.turn_logs
            .filter(log => log.speaker_type === 'narration')
            .pop();
          if (lastNarration) {
            narrationEl.textContent = lastNarration.text;
          }
        }
        
        // personaê°€ ì—†ìœ¼ë©´ ê°•ì œ ëª¨ë‹¬ ì—´ê¸° (í˜ë¥´ì¡°ë‚˜ ëª©ë¡ì´ ìˆì„ ë•Œë§Œ ê°•ì œ)
        const needsPersona = !currentSession.player_persona && !currentSession.persona_ref_id;
        const hasPersonas = (PERSONAS_LIST?.length ?? 0) > 0;
        
        if (needsPersona && hasPersonas) {
          console.log('[PERSONA] No persona found in session, forcing modal open');
          await openPersonaModal(true);
        } else if (needsPersona && !hasPersonas) {
          // í˜ë¥´ì¡°ë‚˜ê°€ ì—†ìœ¼ë©´ ê°•ì œ ëª¨ë‹¬ ì—†ì´ ì¼ë°˜ ëª¨ë‹¬ë¡œ ì—´ê¸° (ë‹«ê¸° ê°€ëŠ¥)
          console.log('[PERSONA] No persona found in session, opening modal (closable)');
          await openPersonaModal(false);
        }
      } else {
        // ì´ˆê¸° ë‚´ë ˆì´ì…˜ ì˜ì—­ì— ê²Œì„ ì†Œê°œ í…ìŠ¤íŠ¸ ì„¤ì •
        if (narrationEl) {
          const initialText = game.scenario_summary || game.scenario_detail || game.title || 'ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.';
          narrationEl.textContent = initialText;
        }
        
        // ì„¸ì…˜ì´ ì—†ì–´ë„ í˜ë¥´ì¡°ë‚˜ ëª©ë¡ ë¡œë“œ ë° í—¤ë” badge ê°±ì‹  (í—¤ë” badgeìš©, í•˜ì§€ë§Œ ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ê°•ì œ ëª¨ë‹¬ì€ ì—´ì§€ ì•ŠìŒ)
        try {
          PERSONAS_LIST = await fetchPersonas();
        } catch (e) {
          console.warn('[GAME][BOOTSTRAP] Failed to load personas:', e);
        }
        refreshHeaderPersonaBadge();
      }

      // ê²Œì„ì€ ì¸ì‚¬ë§ ì—†ì´ ììœ ë¡­ê²Œ ì±„íŒ… ì‹œì‘

      // ì…ë ¥ ë™ì‘
      const ta=document.getElementById('ta'), btn=document.getElementById('send');
      
      // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ì…ë ¥/ì „ì†¡ ì‹œë„ ì‹œ ê³„ì • ìƒíƒœ ì²´í¬
      async function checkLoginAndSend(){
        const status = await checkAccountStatus();

        if (!status.ok) {
          if (status.reason === 'login') {
            showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'lock') {
            showToast('í˜„ì¬ ê³„ì •ì´ ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'use') {
            showToast('í˜„ì¬ ì‚¬ìš©ì´ ë¶ˆê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else {
            showToast('ê³„ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 2000);
          }
          ta.blur();
          return false;
        }
        return true;
      }

      async function send(){
        // ë¡œê·¸ì¸ ì²´í¬
        if (!(await checkLoginAndSend())) return;
        
        const v=ta.value.trim(); if(!v)return;
        
        // í”Œë ˆì´ì–´ ë©”ì‹œì§€ëŠ” ì„¸ì…˜ì— í¬í•¨ë˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        // (ë°±ì—”ë“œì—ì„œ turn_logsì— ì¶”ê°€ë˜ê³ , askLLMì—ì„œ ì„¸ì…˜ ì¬ë¡œë“œ ì‹œ ë Œë”ë§ë¨)
        
        ta.value=''; btn.disabled=true;
        
        console.log('[send] Starting API call with message:', v);
        console.log('[send] API_BASE_URL:', API_BASE_URL);
        console.log('[send] isGamePage:', isGamePage, 'GAME_ID:', GAME_ID);
        
        try{ 
          const ans=await askLLM(v,'trpg');
          console.log('[send] Received answer:', ans);
          // ê²Œì„ í˜ì´ì§€ê°€ ì•„ë‹ ë•Œë§Œ addBot í˜¸ì¶œ (ê²Œì„ í˜ì´ì§€ëŠ” askLLM ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
          if (!isGamePage && ans) {
            addBot(ans||'(ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤)');
          }
        }
        catch(e){ 
          console.error('[send] Error caught:', e);
          if (isGamePage && GAME_ID) {
            // ì—ëŸ¬ ë©”ì‹œì§€ë§Œ ì¶”ê°€ (ì„¸ì…˜ ì¬ë Œë”ë§ì€ í•˜ì§€ ì•ŠìŒ)
            const chatEl = document.getElementById('chat');
            if (chatEl) {
              const row = document.createElement('div');
              row.className = 'msg';
              row.innerHTML = `<div class="bubble">ì„œë²„ ì˜¤ë¥˜: ${escapeHtml(e.message)}</div>`;
              chatEl.appendChild(row);
              const bottomMarker = document.getElementById('chat-bottom-marker');
              if (bottomMarker) {
                bottomMarker.scrollIntoView({ behavior: 'smooth', block: 'end' });
              } else {
                chatEl.scrollTop = chatEl.scrollHeight;
              }
            }
          } else {
            addBot('ì„œë²„ ì˜¤ë¥˜: '+e.message);
          }
        }
        finally{ 
          btn.disabled=false; 
          ta.focus(); 
        }
      }
      
      // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ ê³„ì • ìƒíƒœ ì²´í¬
      ta.addEventListener('focus', async (ev) => {
        const status = await checkAccountStatus();
        if (!status.ok) {
          ev.preventDefault();
          ta.blur();

          if (status.reason === 'login') {
            showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'lock') {
            showToast('í˜„ì¬ ê³„ì •ì´ ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'use') {
            showToast('í˜„ì¬ ì‚¬ìš©ì´ ë¶ˆê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else {
            showToast('ê³„ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 2000);
          }
        }
      });

      // í´ë¦­ ì‹œë„ ì‹œ ê³„ì • ìƒíƒœ ì²´í¬
      ta.addEventListener('click', async (ev) => {
        const status = await checkAccountStatus();
        if (!status.ok) {
          ev.preventDefault();
          ta.blur();

          if (status.reason === 'login') {
            showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'lock') {
            showToast('í˜„ì¬ ê³„ì •ì´ ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else if (status.reason === 'use') {
            showToast('í˜„ì¬ ì‚¬ìš©ì´ ë¶ˆê°€í•œ ìƒíƒœì…ë‹ˆë‹¤.', 2000);
          } else {
            showToast('ê³„ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 2000);
          }
        }
      });

      btn.onclick=send;
      ta.addEventListener('keydown', ev=>{ 
        if (ev.key==='Enter' && !ev.shiftKey){ 
          ev.preventDefault(); 
          send(); 
        }
      });
    });

    // ë””ë²„ê·¸ ìœ í‹¸: ê²Œì„ ë°°ì§€ ìƒíƒœ ì²´í¬
    window.__debugGameBadges = function () {
      const playerRows = document.querySelectorAll('.game-msg--player').length;
      const miniBadges = document.querySelectorAll('.persona-badge--mini').length;
      const npcAvatars = document.querySelectorAll('.game-msg--npc .game-avatar').length;
      console.log({ 
        playerRows, 
        miniBadges, 
        npcAvatars, 
        currentSessionPersonaRef: currentSession?.persona_ref_id, 
        currentSessionPlayerPersona: currentSession?.player_persona 
      });
      return { playerRows, miniBadges, npcAvatars };
    };
  </script>
</body>
</html>



