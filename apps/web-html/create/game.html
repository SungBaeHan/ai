<!-- =============================================
create/game.html - 게임 생성 화면
- 좌측: 배경 이미지 미리보기, 세계관 정보
- 우측: 게임 설정 폼
- 다크 테마 유지
============================================= -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>게임 만들기 - Arcanaverse</title>
  <script src="/js/config.js"></script>
  <script src="/static/js/session.js"></script>
  <script>
    window.API_BASE_URL = 'https://api.arcanaverse.ai';
    window.API_BASE = 'https://api.arcanaverse.ai';
  </script>
  <style>
    :root { color-scheme: dark; }
    body { 
      margin:0; 
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, 'Apple SD Gothic Neo','Malgun Gothic',sans-serif; 
      background:#0b0f14; 
      color:#e5e7eb;
    }

    /* Top Navigation */
    .nav { position:sticky; top:0; z-index:30; background:#0b1118; border-bottom:1px solid #18212c; }
    .navin { max-width:1200px; margin:0 auto; padding:8px 12px; display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; }
    .tab { text-align:center; padding:10px 8px; border-radius:10px; background:#0f172a; color:#a5b4fc; border:1px solid #1e293b; font-size:12px; cursor:pointer; user-select:none; text-decoration:none; transition:all .15s ease; }
    .tab:hover { background:#1e293b; }
    .tab.active { background:#1e3a8a; border-color:#3b82f6; color:#e0e7ff; }

    /* Main Container */
    .container { max-width:1400px; margin:24px auto 40px; padding:0 16px; }
    
    h1 {
      font-size:28px;
      font-weight:700;
      margin:0 0 8px 0;
      color:#f3f4f6;
    }

    .subtitle {
      font-size:14px;
      color:#94a3b8;
      margin:0 0 32px 0;
    }

    /* Two Column Layout */
    .two-column {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:32px;
      align-items:start;
    }

    .column {
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .column h2 {
      font-size:20px;
      font-weight:700;
      margin:0 0 16px 0;
      color:#f3f4f6;
      padding-bottom:12px;
      border-bottom:1px solid #1f2937;
    }

    /* Form Elements */
    label {
      display:block;
      font-size:14px;
      font-weight:500;
      color:#e5e7eb;
      margin-bottom:8px;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width:100%;
      padding:10px 12px;
      background:#0f172a;
      border:1px solid #1f2937;
      border-radius:8px;
      color:#e5e7eb;
      font-size:14px;
      font-family:inherit;
      transition:border-color .15s ease;
      box-sizing:border-box;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      outline:none;
      border-color:#3b82f6;
    }

    textarea {
      resize:vertical;
      min-height:80px;
    }

    /* Image Uploader */
    .image-uploader {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:12px;
      padding:20px;
      text-align:center;
    }

    .image-uploader p {
      margin:0 0 16px 0;
      color:#94a3b8;
      font-size:14px;
    }

    .image-uploader input[type="file"] {
      width:100%;
      padding:8px;
      background:#0f172a;
      border:1px dashed #334155;
      border-radius:8px;
      color:#e5e7eb;
      cursor:pointer;
      margin-bottom:16px;
    }

    .image-uploader .preview {
      width:100%;
      aspect-ratio:16/10;
      background:#0b1220;
      border:1px solid #1f2937;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#64748b;
      font-size:14px;
      margin-top:12px;
      overflow:hidden;
    }

    .image-uploader .preview img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Tag Field */
    fieldset.tag-field {
      border:1px solid #1f2937;
      border-radius:8px;
      padding:16px;
      margin:0;
      background:#0f172a;
    }

    fieldset.tag-field legend {
      font-size:14px;
      font-weight:500;
      color:#e5e7eb;
      padding:0 8px;
    }

    .tag-checkboxes {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap:12px;
      margin-top:12px;
    }

    .tag-checkboxes label {
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
      font-size:13px;
      cursor:pointer;
      padding:6px 10px;
      border-radius:6px;
      background:#111827;
      border:1px solid #1f2937;
      transition:all .15s ease;
    }

    .tag-checkboxes label:hover {
      background:#1f2937;
      border-color:#334155;
    }

    .tag-checkboxes input[type="checkbox"] {
      width:auto;
      margin:0;
      cursor:pointer;
    }

    .tag-checkboxes input[type="checkbox"]:checked + span {
      color:#3b82f6;
    }

    /* World Preview Card */
    .world-preview {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:12px;
      padding:16px;
      margin-top:16px;
    }

    .world-preview h3 {
      font-size:16px;
      font-weight:600;
      margin:0 0 12px 0;
      color:#f3f4f6;
    }

    .world-preview p {
      font-size:13px;
      color:#94a3b8;
      margin:8px 0;
      line-height:1.5;
    }

    .world-preview .tags {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:12px;
    }

    .world-preview .tag-chip {
      font-size:11px;
      padding:4px 8px;
      border:1px solid #334155;
      border-radius:999px;
      background:#0b1220;
      color:#a5b4fc;
    }

    /* Character Selection */
    .character-list {
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }

    .character-item {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .character-item img {
      width:48px;
      height:48px;
      border-radius:6px;
      object-fit:cover;
    }

    .character-item .info {
      flex:1;
    }

    .character-item .name {
      font-size:14px;
      font-weight:600;
      color:#f3f4f6;
      margin-bottom:4px;
    }

    .character-item .role-select {
      width:auto;
      min-width:120px;
      padding:6px 8px;
      font-size:12px;
    }

    .character-item .remove-btn {
      padding:6px 12px;
      background:#dc2626;
      color:#ffffff;
      border:none;
      border-radius:6px;
      font-size:12px;
      cursor:pointer;
    }

    .character-item .remove-btn:hover {
      background:#b91c1c;
    }

    /* Attribute Settings */
    .attribute-list {
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }

    .attribute-item {
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
    }

    .attribute-item input[type="checkbox"] {
      width:auto;
      margin:0;
      cursor:pointer;
    }

    .attribute-item label {
      flex:1;
      margin:0;
      font-size:14px;
    }

    .attribute-item input[type="number"] {
      width:80px;
      padding:6px 8px;
    }

    /* Rule Settings */
    .rule-section {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:16px;
      margin-top:12px;
    }

    .rule-section h4 {
      font-size:14px;
      font-weight:600;
      margin:0 0 12px 0;
      color:#f3f4f6;
    }

    .rule-row {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }

    .rule-row label {
      flex:1;
      margin:0;
      font-size:13px;
    }

    .rule-row input[type="number"] {
      width:100px;
      padding:6px 8px;
    }

    .rule-row input[type="checkbox"] {
      width:auto;
      margin:0;
      cursor:pointer;
    }

    /* Actions */
    .actions {
      display:flex;
      gap:12px;
      margin-top:32px;
      padding-top:24px;
      border-top:1px solid #1f2937;
    }

    .btn-primary {
      flex:1;
      padding:12px 24px;
      background:#3b82f6;
      color:#ffffff;
      border:1px solid #2563eb;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all .15s ease;
    }

    .btn-primary:hover {
      background:#2563eb;
      border-color:#1d4ed8;
    }

    .btn-primary:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    /* World Select List */
    .world-select-list {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
    }

    .world-card {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:12px;
      cursor:pointer;
      transition:all .15s ease;
    }

    .world-card:hover {
      border-color:#3b82f6;
      background:#1e293b;
      transform:translateY(-2px);
    }

    /* Modal Styles */
    .modal-backdrop {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.75);
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .modal-dialog {
      background:#0f172a;
      border:1px solid #1f2937;
      border-radius:12px;
      width:100%;
      max-width:900px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
    }

    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px;
      border-bottom:1px solid #1f2937;
    }

    .modal-header h3 {
      margin:0;
      font-size:18px;
      font-weight:600;
      color:#f3f4f6;
    }

    .modal-search {
      padding:16px 20px;
      border-bottom:1px solid #1f2937;
    }

    .modal-body {
      flex:1;
      overflow-y:auto;
    }

    .modal-footer {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      border-top:1px solid #1f2937;
    }

    /* World Modal List */
    .world-modal .modal-body {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
    }

    .world-modal .world-card {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:12px;
      cursor:pointer;
      transition:all .15s ease;
    }

    .world-modal .world-card:hover {
      border-color:#3b82f6;
      background:#1e293b;
      transform:translateY(-2px);
    }

    /* Character Modal List */
    .char-modal .modal-body {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:12px;
    }

    .char-modal .char-card {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
      padding:12px;
      cursor:pointer;
      transition:all .15s ease;
    }

    .char-modal .char-card:hover {
      border-color:#3b82f6;
      background:#1e293b;
      transform:translateY(-2px);
    }

    .char-modal .char-card.selected {
      border-color:#3b82f6;
      background:#1e3a8a;
    }

    /* Toast Layer */
    .toast { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition:opacity .18s ease; z-index:50; }
    .toast.show { opacity:1; pointer-events:auto; }
    .toast .box { pointer-events:auto; min-width:200px; max-width:80vw; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; padding:14px 18px; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.45); text-align:center; }

    /* 반응형 */
    @media (max-width: 1200px) {
      .two-column {
        grid-template-columns: 1fr;
        gap:40px;
      }
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <div class="nav">
    <div class="navin">
      <a href="/home.html" class="tab" data-nav="logo">Logo</a>
      <a href="/home.html" class="tab" data-nav="search">Search</a>
      <a href="/create/index.html" class="tab active" data-nav="create">Create</a>
      <a href="/home.html" class="tab" data-nav="list">My List</a>
      <a href="/my.html" class="tab" data-nav="my">My</a>
    </div>
  </div>

  <main class="container">
    <h1>게임 생성</h1>
    <p class="subtitle">세계관, 캐릭터, 룰을 선택해서 TRPG 세션을 생성합니다.</p>

    <section class="two-column">
      <!-- 좌측: 미리보기 -->
      <section class="column left">
        <h2>미리보기</h2>

        <div class="image-uploader" data-field="background_image">
          <p>게임 배경 이미지를 업로드하세요.</p>
          <input type="file" accept="image/*" id="background-image-upload" />
          <div class="preview" id="background-image-preview">
            <span>이미지 미리보기</span>
          </div>
        </div>

        <div id="world-preview-container" style="display:none;">
          <div class="world-preview">
            <img id="world-preview-image" src="" alt="세계관 이미지" style="width:100%; aspect-ratio:16/10; object-fit:cover; border-radius:8px; margin-bottom:12px;" />
            <h3 id="world-preview-name">세계관 이름</h3>
            <p id="world-preview-summary">세계관 설명이 여기에 표시됩니다.</p>
            <div class="tags" id="world-preview-tags"></div>
          </div>
        </div>
      </section>

      <!-- 우측: 게임 설정 폼 -->
      <section class="column right">
        <h2>게임 설정</h2>

        <!-- 게임 기본 정보 -->
        <div>
          <h3 style="font-size:16px; font-weight:600; margin:0 0 16px 0; color:#f3f4f6;">게임 기본 정보</h3>
          
          <label>
            <font color="red">*</font> 게임명
            <input type="text" id="game-title" placeholder="잿빛 대지 생존전" required />
          </label>

          <fieldset class="tag-field" data-field="tags">
            <legend>게임 유형 태그</legend>
            <div class="tag-checkboxes">
              <label><input type="checkbox" value="전투 중심" data-field="tags" /> <span>전투 중심</span></label>
              <label><input type="checkbox" value="협상 중심" data-field="tags" /> <span>협상 중심</span></label>
              <label><input type="checkbox" value="던전 탐험" data-field="tags" /> <span>던전 탐험</span></label>
              <label><input type="checkbox" value="미스터리" data-field="tags" /> <span>미스터리</span></label>
              <label><input type="checkbox" value="생존" data-field="tags" /> <span>생존</span></label>
              <label><input type="checkbox" value="현대" data-field="tags" /> <span>현대</span></label>
              <label><input type="checkbox" value="판타지" data-field="tags" /> <span>판타지</span></label>
              <label><input type="checkbox" value="스팀펑크" data-field="tags" /> <span>스팀펑크</span></label>
              <label><input type="checkbox" value="하드코어" data-field="tags" /> <span>하드코어</span></label>
            </div>
          </fieldset>
        </div>

        <!-- 세계관 선택 -->
        <div>
          <h3 style="font-size:16px; font-weight:600; margin:0 0 16px 0; color:#f3f4f6;">세계관 선택</h3>
          
          <label>
            <font color="red">*</font> 세계관
            <!-- Hidden select for form submission -->
            <select id="world-select" name="world_ref_id" style="display:none;"></select>
            <!-- Display field that looks like a select -->
            <div id="world-select-display" class="select-display">
              <span id="world-select-text">세계관을 선택하세요</span>
            </div>
          </label>
        </div>

        <!-- 시나리오 정보 -->
        <div>
          <h3 style="font-size:16px; font-weight:600; margin:0 0 16px 0; color:#f3f4f6;">시나리오 정보</h3>
          
          <label>
            시나리오 요약
            <textarea id="scenario-summary" rows="2" placeholder="잿빛 대지에서 생존자 길드의 일원이 되어 폐허가 된 도시를 탐험합니다."></textarea>
          </label>

          <label>
            시나리오 상세 (LLM 프롬프트용)
            <textarea id="scenario-detail" rows="6" placeholder="이 게임은 '잿빛 대지'라는 황폐화된 대륙에서 진행된다. 플레이어들은 생존자 길드의 일원으로서..."></textarea>
          </label>
        </div>

        <!-- 캐릭터 선택 및 역할 설정 -->
        <div>
          <h3 style="font-size:16px; font-weight:600; margin:0 0 16px 0; color:#f3f4f6;">캐릭터 선택 및 역할 설정</h3>
          
          <label>
            캐릭터 선택 (최대 5명)
            <!-- Hidden select for form submission -->
            <select id="character-select" name="character_ids" multiple style="display:none;"></select>
            <!-- Display field that looks like a select -->
            <div id="character-select-display" class="select-display">
              <span id="character-select-text">캐릭터를 선택하세요 (최대 5명)</span>
            </div>
          </label>
          
          <!-- 선택된 캐릭터를 태그/칩 형태로 보여줄 컨테이너 -->
          <div id="character-selected-chips" class="chip-container" style="margin-top:12px;"></div>

          <!-- 선택된 캐릭터 리스트 (역할 설정용) -->
          <div id="character-list" class="character-list" style="margin-top:16px;"></div>
        </div>

        <!-- 속성 설정 -->
        <div>
          <h3 style="font-size:16px; font-weight:600; margin:0 0 16px 0; color:#f3f4f6;">속성 설정</h3>
          
          <div id="attribute-list" class="attribute-list"></div>
        </div>

        <!-- 주사위 및 룰 설정 -->
        <div>
          <h3 style="font-size:16px; font-weight:600; margin:0 0 16px 0; color:#f3f4f6;">주사위 및 룰 설정</h3>
          
          <div class="rule-section">
            <h4>주사위 설정</h4>
            <div class="rule-row">
              <label>주사위 개수</label>
              <input type="number" id="dice-count" min="1" max="5" value="5" />
            </div>
            <div class="rule-row">
              <label>주사위 면수</label>
              <input type="number" id="dice-faces" min="4" value="20" />
            </div>
            <div class="rule-row">
              <label>최대값</label>
              <input type="number" id="dice-max" readonly value="100" style="background:#1f2937; color:#94a3b8;" />
            </div>
          </div>

          <div class="rule-section">
            <h4>성공 기준 / 난이도</h4>
            <div class="rule-row">
              <label>기본 성공 기준</label>
              <input type="number" id="success-base" value="60" />
            </div>
            <div class="rule-row">
              <label>쉬움 (easy)</label>
              <input type="number" id="difficulty-easy" value="-10" />
            </div>
            <div class="rule-row">
              <label>보통 (normal)</label>
              <input type="number" id="difficulty-normal" value="0" />
            </div>
            <div class="rule-row">
              <label>어려움 (hard)</label>
              <input type="number" id="difficulty-hard" value="10" />
            </div>
            <div class="rule-row">
              <label>매우 어려움 (very_hard)</label>
              <input type="number" id="difficulty-very-hard" value="20" />
            </div>
            <div class="rule-row">
              <label>능력치 보정 (ability_scale)</label>
              <input type="number" id="ability-scale" step="0.1" value="1.0" />
            </div>
          </div>

          <div class="rule-section">
            <h4>데미지 설정</h4>
            <div class="rule-row">
              <label>STR 배수 (str_multiplier)</label>
              <input type="number" id="str-multiplier" step="0.1" value="1.0" />
            </div>
            <div class="rule-row">
              <label>고정 보너스 (flat_bonus)</label>
              <input type="number" id="flat-bonus" value="0" />
            </div>
            <div class="rule-row">
              <label>성공 보너스 배수 (success_bonus_scale)</label>
              <input type="number" id="success-bonus-scale" step="0.1" value="1.0" />
            </div>
            <div class="rule-row">
              <label>
                <input type="checkbox" id="on-fail-zero" checked />
                실패 시 데미지 0 (on_fail_zero)
              </label>
            </div>
          </div>

          <div class="rule-section">
            <h4>크리티컬 설정</h4>
            <div class="rule-row">
              <label>임계값 비율 (threshold_ratio, 0~1)</label>
              <input type="number" id="critical-threshold" step="0.01" min="0" max="1" value="0.95" />
            </div>
            <div class="rule-row">
              <label>크리티컬 배수 (multiplier)</label>
              <input type="number" id="critical-multiplier" step="0.1" value="2.0" />
            </div>
            <div class="rule-row">
              <label>기본 보너스 배수 (base_bonus_multiplier)</label>
              <input type="number" id="critical-base-bonus" step="0.1" value="1.5" />
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btn-game-save" class="btn-primary">게임 생성</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Toast Layer -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <div class="box">준비중입니다</div>
  </div>

  <script>
    // API Base URL
    const API_BASE_URL = getApiBaseUrl();

    // Toast 표시
    function showToast(msg, ms = 2000) {
      const el = document.getElementById('toast');
      if (!el) {
        console.warn('Toast element not found');
        return;
      }
      const box = el.querySelector('.box');
      if (box) {
        box.textContent = msg;
      }
      el.classList.add('show');
      clearTimeout(showToast.tid);
      showToast.tid = setTimeout(() => {
        if (el) {
          el.classList.remove('show');
        }
      }, ms);
    }

    // 이미지 경로 해결 함수
    function resolvePath(p) {
      if (!p) return '/assets/img/placeholder.jpg';
      if (/^https?:\/\//i.test(p)) return p;
      p = String(p).replace(/\\/g, '/').trim();
      if (p.startsWith('/')) return p;
      if (p.startsWith('assets/')) return '/' + p;
      // 세계관 이미지 처리
      if (p.includes('/world/') || p.startsWith('world/') || p.startsWith('assets/world/')) {
        p = p.replace(/^assets\/?/, '');
        p = p.replace(/^world\//, 'world/');
        return '/assets/' + p;
      }
      // 캐릭터 이미지 처리
      if (p.includes('/char/') || p.startsWith('char/') || /^char_\d+/i.test(p) || p.startsWith('assets/char/')) {
        p = p.replace(/^assets\/?/, '');
        p = p.replace(/^char\//, 'char/');
        return '/assets/' + p;
      }
      return '/assets/img/' + p;
    }

    // 전역 상태
    let backgroundImageFile = null;
    let selectedWorld = null;
    let selectedCharacters = [];
    let worldsList = [];
    let charactersList = [];

    // 속성 정의
    const attributes = [
      { key: 'hp', label: '체력 (HP)', enabled: true, max: 100, base: 80 },
      { key: 'mp', label: '마력 (MP)', enabled: true, max: 80, base: 30 },
      { key: 'sp', label: '기력 (SP)', enabled: true, max: 60, base: 20 },
      { key: 'str', label: '무력 (STR)', enabled: true, max: 20, base: 10 },
      { key: 'int', label: '지력 (INT)', enabled: true, max: 20, base: 10 },
      { key: 'pol', label: '정치 (POL)', enabled: false, max: 20, base: 10 },
      { key: 'cha', label: '매력 (CHA)', enabled: true, max: 20, base: 10 },
      { key: 'agi', label: '민첩 (AGI)', enabled: true, max: 20, base: 10 },
      { key: 'log', label: '지능 (LOG)', enabled: false, max: 20, base: 10 },
      { key: 'wis', label: '지혜 (WIS)', enabled: true, max: 20, base: 10 },
      { key: 'luck', label: '행운 (LUCK)', enabled: true, max: 20, base: 10 },
    ];

    // 역할 목록
    const roles = [
      { value: 'random', label: '랜덤' },
      { value: 'warrior', label: '전사' },
      { value: 'mage', label: '마법사' },
      { value: 'rogue', label: '로그' },
      { value: 'hunter', label: '사냥꾼' },
      { value: 'healer', label: '힐러' },
      { value: 'diplomat', label: '외교관' },
      { value: 'merchant', label: '상인' },
      { value: 'engineer', label: '기술자' },
    ];

    // 속성 리스트 렌더링
    function renderAttributes() {
      const container = document.getElementById('attribute-list');
      if (!container) {
        console.warn('Attribute list container not found');
        return;
      }
      container.innerHTML = '';
      
      attributes.forEach(attr => {
        const item = document.createElement('div');
        item.className = 'attribute-item';
        item.innerHTML = `
          <input type="checkbox" id="attr-${attr.key}" ${attr.enabled ? 'checked' : ''} />
          <label for="attr-${attr.key}" style="flex:1; margin:0;">${attr.label}</label>
          <label style="margin:0; font-size:12px; color:#94a3b8;">max:</label>
          <input type="number" id="attr-${attr.key}-max" value="${attr.max}" min="1" />
          <label style="margin:0; font-size:12px; color:#94a3b8;">base:</label>
          <input type="number" id="attr-${attr.key}-base" value="${attr.base}" min="0" />
        `;
        container.appendChild(item);
      });
    }

    // 배경 이미지 선택 처리 (미리보기만, 업로드는 저장 시)
    const bgImageUpload = document.getElementById('background-image-upload');
    if (bgImageUpload) {
      bgImageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        backgroundImageFile = file;

        // 로컬 미리보기만
        const reader = new FileReader();
        reader.onload = function(event) {
          const preview = document.getElementById('background-image-preview');
          if (preview) {
            preview.innerHTML = `<img src="${event.target.result}" alt="Preview" />`;
          }
        };
        reader.readAsDataURL(file);
      });
    }

    // 세계관 목록 로드 및 카드 렌더링
    async function loadWorlds() {
      try {
        const response = await fetch(`${API_BASE_URL}/v1/worlds?offset=0&limit=200`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('세계관 목록 로드 실패');
        }

        const data = await response.json();
        worldsList = data.items || [];

        renderWorldList();
      } catch (error) {
        console.error('Load worlds error:', error);
        showToast('세계관 목록을 불러오는 중 오류가 발생했습니다.', 2000);
      }
    }

    // 태그를 안전하게 배열로 변환하는 헬퍼 함수
    function safeTags(tags) {
      if (Array.isArray(tags)) return tags;
      if (typeof tags === 'string') return [tags];
      return [];
    }

    // 세계관 모달 카드 리스트 렌더링
    function renderWorldModalList() {
      const container = document.getElementById('world-modal-list');
      container.innerHTML = '';
      
      // 검색 필터링
      const filtered = worldsList.filter(world => {
        if (!worldSearchText) return true;
        const search = worldSearchText.toLowerCase();
        const name = (world.name || '').toLowerCase();
        const summary = (world.summary || '').toLowerCase();
        const tags = safeTags(world.tags).join(' ').toLowerCase();
        return name.includes(search) || summary.includes(search) || tags.includes(search);
      });
      
      filtered.forEach(world => {
        const card = document.createElement('div');
        card.className = 'world-card';
        card.addEventListener('click', () => selectWorldFromModal(world));
        
        const imageUrl = resolvePath(world.image || world.image_path || '/assets/img/placeholder.jpg');
        const tags = safeTags(world.tags);
        card.innerHTML = `
          <img src="${imageUrl}" alt="${world.name}" style="width:100%; aspect-ratio:16/10; object-fit:cover; border-radius:6px; margin-bottom:8px;" />
          <div style="font-weight:600; color:#f3f4f6; margin-bottom:4px; font-size:14px;">${world.name || '이름 없음'}</div>
          <div style="font-size:11px; color:#94a3b8; margin-bottom:8px; display:flex; flex-wrap:wrap; gap:4px;">
            ${tags.slice(0, 3).map(tag => `<span style="padding:2px 6px; background:#0b1220; border-radius:4px;">${tag}</span>`).join('')}
          </div>
          <div style="font-size:12px; color:#64748b; line-height:1.4; height:32px; overflow:hidden;">${(world.summary || '').substring(0, 50)}${(world.summary || '').length > 50 ? '...' : ''}</div>
        `;
        
        container.appendChild(card);
      });
    }

    // 선택된 세계관 카드 렌더링
    function renderSelectedWorld() {
      const cardEl = document.getElementById('selected-world-card');
      const placeholderEl = document.getElementById('selected-world-placeholder');
      
      if (!cardEl || !placeholderEl) return;
      
      if (selectedWorld) {
        cardEl.style.display = 'block';
        placeholderEl.style.display = 'none';
        
        const imageUrl = resolvePath(selectedWorld.image || selectedWorld.image_path || '/assets/img/placeholder.jpg');
        const tags = safeTags(selectedWorld.tags);
        
        const imgEl = document.getElementById('selected-world-image');
        if (imgEl) imgEl.src = imageUrl;
        
        const nameEl = document.getElementById('selected-world-name');
        if (nameEl) nameEl.textContent = selectedWorld.name || '이름 없음';
        
        const summaryEl = document.getElementById('selected-world-summary');
        if (summaryEl) summaryEl.textContent = selectedWorld.summary || '설명 없음';
        
        const tagsContainer = document.getElementById('selected-world-tags');
        if (tagsContainer) {
          tagsContainer.innerHTML = '';
          tags.forEach(tag => {
            const span = document.createElement('span');
            span.style.cssText = 'padding:2px 6px; background:#0b1220; border-radius:4px; font-size:11px;';
            span.textContent = tag;
            tagsContainer.appendChild(span);
          });
        }
      } else {
        cardEl.style.display = 'none';
        placeholderEl.style.display = 'block';
      }
    }

    // 세계관 모달 열기
    function openWorldModal() {
      showWorldModal = true;
      const modal = document.getElementById('world-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      worldSearchText = '';
      const searchInput = document.getElementById('world-search-input');
      if (searchInput) {
        searchInput.value = '';
      }
      
      if (worldsList.length === 0) {
        loadWorlds();
      } else {
        renderWorldModalList();
      }
    }

    // 세계관 모달 닫기
    function closeWorldModal() {
      showWorldModal = false;
      const modal = document.getElementById('world-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // 모달에서 세계관 선택
    function selectWorldFromModal(world) {
      selectedWorld = world;
      
      // 오른쪽 display 필드 업데이트
      if (worldSelectText) {
        worldSelectText.textContent = world.name || '세계관을 선택하세요';
      }
      
      // hidden select에 값 설정
      syncWorldHiddenField();
      
      // 왼쪽 미리보기 업데이트 (배경 이미지가 없을 때만)
      if (!backgroundImageFile) {
        const imageUrl = resolvePath(world.image || world.image_path || '/assets/img/placeholder.jpg');
        
        const previewName = document.getElementById('world-preview-name');
        if (previewName) previewName.textContent = world.name || '이름 없음';
        
        const previewSummary = document.getElementById('world-preview-summary');
        if (previewSummary) previewSummary.textContent = world.summary || '설명 없음';
        
        const previewImage = document.getElementById('world-preview-image');
        if (previewImage) previewImage.src = imageUrl;
        
        const tagsContainer = document.getElementById('world-preview-tags');
        if (tagsContainer) {
          tagsContainer.innerHTML = '';
          safeTags(world.tags).forEach(tag => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = tag;
            tagsContainer.appendChild(chip);
          });
        }

        const previewContainer = document.getElementById('world-preview-container');
        if (previewContainer) {
          previewContainer.style.display = 'block';
        }
      }
      
      closeWorldModal();
    }

    // 세계관 hidden select 동기화
    function syncWorldHiddenField() {
      if (!worldSelectHidden || !selectedWorld) return;
      
      const worldId = selectedWorld.id || selectedWorld._id || selectedWorld.mongo_id;
      const idStr = String(worldId);
      
      // option 없으면 새로 만든다
      let opt = Array.from(worldSelectHidden.options).find(o => o.value === idStr);
      if (!opt) {
        opt = document.createElement('option');
        opt.value = idStr;
        opt.textContent = selectedWorld.name || idStr;
        worldSelectHidden.appendChild(opt);
      }
      
      worldSelectHidden.value = idStr;
    }

    // 세계관 제거 (필요시 사용)
    function removeWorld() {
      selectedWorld = null;
      if (worldSelectText) {
        worldSelectText.textContent = '세계관을 선택하세요';
      }
      if (worldSelectHidden) {
        worldSelectHidden.value = '';
      }
      const previewContainer = document.getElementById('world-preview-container');
      if (previewContainer) {
        previewContainer.style.display = 'none';
      }
    }

    // 캐릭터 목록 로드
    async function loadCharacters() {
      try {
        const response = await fetch(`${API_BASE_URL}/v1/characters?offset=0&limit=200`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('캐릭터 목록 로드 실패');
        }

        const data = await response.json();
        charactersList = data.items || [];

        renderCharacterModalList();
      } catch (error) {
        console.error('Load characters error:', error);
        showToast('캐릭터 목록을 불러오는 중 오류가 발생했습니다.', 2000);
      }
    }

    // 캐릭터 찾기 헬퍼 함수
    function findCharacter(charRefId) {
      return charactersList.find(c => {
        const cid = c.id || c.pk || c.slug;
        return String(cid) == String(charRefId);
      });
    }

    // 캐릭터 모달 열기
    function openCharacterModal() {
      showCharacterModal = true;
      const modal = document.getElementById('character-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      characterSearchText = '';
      const searchInput = document.getElementById('character-search-input');
      if (searchInput) {
        searchInput.value = '';
      }
      
      // 현재 선택된 캐릭터 ID로 임시 선택 초기화
      tempSelectedCharIds = selectedCharacters.map(c => c.char_ref_id);
      updateTempSelectedCount();
      
      if (charactersList.length === 0) {
        loadCharacters();
      } else {
        renderCharacterModalList();
      }
    }

    // 캐릭터 모달 닫기
    function closeCharacterModal() {
      showCharacterModal = false;
      const modal = document.getElementById('character-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // 캐릭터 모달 카드 리스트 렌더링
    function renderCharacterModalList() {
      const container = document.getElementById('character-modal-list');
      if (!container) return;
      
      container.innerHTML = '';
      
      // 검색 필터링
      const filtered = charactersList.filter(char => {
        if (!characterSearchText) return true;
        const search = characterSearchText.toLowerCase();
        const name = (char.name || '').toLowerCase();
        const summary = (char.summary || '').toLowerCase();
        const tags = safeTags(char.tags).join(' ').toLowerCase();
        return name.includes(search) || summary.includes(search) || tags.includes(search);
      });
      
      filtered.forEach(char => {
        const charId = char.id || char.pk || char.slug;
        const isSelected = tempSelectedCharIds.includes(parseInt(charId)) || tempSelectedCharIds.includes(String(charId));
        
        const card = document.createElement('div');
        card.className = 'char-card';
        if (isSelected) {
          card.classList.add('selected');
        }
        card.addEventListener('click', () => toggleTempCharacter(charId));
        
        const imageUrl = resolvePath(char.image || char.cover || '/assets/img/placeholder.jpg');
        const tags = safeTags(char.tags);
        card.innerHTML = `
          <img src="${imageUrl}" alt="${char.name || '캐릭터'}" style="width:100%; aspect-ratio:1; object-fit:cover; border-radius:6px; margin-bottom:8px;" />
          <div style="font-weight:600; color:#f3f4f6; margin-bottom:4px; font-size:14px;">${char.name || '이름 없음'}</div>
          <div style="font-size:11px; color:#94a3b8; margin-bottom:4px; display:flex; flex-wrap:wrap; gap:4px;">
            ${tags.slice(0, 2).map(tag => `<span style="padding:2px 6px; background:#0b1220; border-radius:4px;">${tag}</span>`).join('')}
          </div>
          <div style="font-size:11px; color:#64748b; line-height:1.3; height:28px; overflow:hidden;">${(char.summary || '').substring(0, 40)}${(char.summary || '').length > 40 ? '...' : ''}</div>
        `;
        
        container.appendChild(card);
      });
    }

    // 임시 선택된 캐릭터 토글
    function toggleTempCharacter(charId) {
      const numId = parseInt(charId) || charId;
      const strId = String(charId);
      const index = tempSelectedCharIds.findIndex(id => id === numId || id === strId);
      
      if (index >= 0) {
        // 이미 선택됨 → 제거
        tempSelectedCharIds.splice(index, 1);
      } else {
        // 선택 안 됨 → 추가 (최대 5명)
        if (tempSelectedCharIds.length >= 5) {
          showToast('최대 5명까지 선택할 수 있습니다.', 2000);
          return;
        }
        tempSelectedCharIds.push(numId);
      }
      
      updateTempSelectedCount();
      renderCharacterModalList();
    }

    // 임시 선택 개수 업데이트
    function updateTempSelectedCount() {
      const countEl = document.getElementById('temp-selected-count');
      if (countEl) {
        countEl.textContent = tempSelectedCharIds.length;
      }
    }

    // 캐릭터 선택 적용
    function applyCharacterSelection() {
      // 기존 역할 유지
      const oldRolesById = {};
      selectedCharacters.forEach(c => {
        oldRolesById[c.char_ref_id] = c.role;
      });
      
      // 새 선택으로 재구성
      selectedCharacters = tempSelectedCharIds.map(id => ({
        char_ref_id: parseInt(id) || id,
        role: oldRolesById[id] || oldRolesById[String(id)] || 'random',
      }));
      
      // 오른쪽 display 필드 및 칩 업데이트
      renderSelectedCharacterChips();
      
      // hidden select 동기화
      syncCharacterHiddenField();
      
      // 역할 설정 리스트 렌더링
      renderCharacterList();
      
      closeCharacterModal();
    }

    // 선택된 캐릭터 칩 렌더링
    function renderSelectedCharacterChips() {
      if (!charSelectedChips) return;
      
      charSelectedChips.innerHTML = '';
      
      const selectedChars = selectedCharacters
        .map(item => {
          const char = findCharacter(item.char_ref_id);
          return char ? { ...item, char } : null;
        })
        .filter(Boolean);
      
      selectedChars.forEach(item => {
        const char = item.char;
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `
          <span class="chip-label">${char.name || '이름 없음'}</span>
          <button type="button" class="chip-remove">×</button>
        `;
        
        const removeBtn = chip.querySelector('.chip-remove');
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            selectedCharacters = selectedCharacters.filter(c => c.char_ref_id !== item.char_ref_id);
            renderSelectedCharacterChips();
            syncCharacterHiddenField();
            renderCharacterList();
          });
        }
        
        charSelectedChips.appendChild(chip);
      });
      
      // display 텍스트 업데이트
      if (charSelectText) {
        if (selectedChars.length === 0) {
          charSelectText.textContent = '캐릭터를 선택하세요 (최대 5명)';
        } else {
          charSelectText.textContent = `${selectedChars.length}명 선택됨`;
        }
      }
    }

    // 캐릭터 hidden select 동기화
    function syncCharacterHiddenField() {
      if (!charSelectHidden) return;
      
      // select[multiple]로 처리
      charSelectHidden.innerHTML = '';
      
      selectedCharacters.forEach(item => {
        const opt = document.createElement('option');
        opt.value = String(item.char_ref_id);
        opt.selected = true;
        charSelectHidden.appendChild(opt);
      });
    }

    // 캐릭터 리스트 렌더링
    function renderCharacterList() {
      const container = document.getElementById('character-list');
      if (!container) return;
      
      container.innerHTML = '';

      selectedCharacters.forEach((charItem, index) => {
        const char = findCharacter(charItem.char_ref_id);
        
        if (!char) return; // 캐릭터를 찾을 수 없으면 스킵
        
        const imageUrl = resolvePath(char.image || char.cover || '/assets/img/placeholder.jpg');
        const name = char.name || '알 수 없음';
        const tags = safeTags(char.tags);
        
        const item = document.createElement('div');
        item.className = 'character-item';
        item.innerHTML = `
          <img src="${imageUrl}" alt="${name}" />
          <div class="info">
            <div class="name">${name}</div>
            <div style="font-size:11px; color:#94a3b8; margin-top:4px; display:flex; flex-wrap:wrap; gap:4px;">
              ${tags.slice(0, 3).map(tag => `<span style="padding:2px 6px; background:#0b1220; border-radius:4px; font-size:10px;">${tag}</span>`).join('')}
            </div>
          </div>
          <select class="role-select" data-index="${index}">
            ${roles.map(r => `<option value="${r.value}" ${charItem.role === r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
          </select>
          <button type="button" class="remove-btn" data-index="${index}">제거</button>
        `;
        container.appendChild(item);
      });

      // 역할 변경
      container.querySelectorAll('.role-select').forEach(select => {
        select.addEventListener('change', function() {
          const index = parseInt(this.getAttribute('data-index'));
          if (selectedCharacters[index]) {
            selectedCharacters[index].role = this.value;
          }
        });
      });

      // 제거 버튼
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          if (selectedCharacters[index]) {
            selectedCharacters.splice(index, 1);
            renderCharacterList();
          }
        });
      });
    }

    // 주사위 최대값 계산
    function updateDiceMax() {
      const countEl = document.getElementById('dice-count');
      const facesEl = document.getElementById('dice-faces');
      const maxEl = document.getElementById('dice-max');
      
      if (!countEl || !facesEl || !maxEl) return;
      
      const count = parseInt(countEl.value) || 5;
      const faces = parseInt(facesEl.value) || 20;
      maxEl.value = count * faces;
    }

    const diceCountEl = document.getElementById('dice-count');
    if (diceCountEl) {
      diceCountEl.addEventListener('input', updateDiceMax);
    }
    
    const diceFacesEl = document.getElementById('dice-faces');
    if (diceFacesEl) {
      diceFacesEl.addEventListener('input', updateDiceMax);
    }

    // 게임 저장
    const btnGameSave = document.getElementById('btn-game-save');
    if (!btnGameSave) {
      console.warn('게임 저장 버튼을 찾을 수 없습니다.');
    } else {
      btnGameSave.addEventListener('click', async function() {
      const btn = this;

      // 필수 필드 체크
      const titleEl = document.getElementById('game-title');
      const title = titleEl ? titleEl.value.trim() : '';
      if (!title) {
        showToast('게임명을 입력해주세요.', 2000);
        return;
      }

      if (!selectedWorld) {
        showToast('세계관을 선택해주세요.', 2000);
        return;
      }

      // 권한 체크
      const accountStatus = await checkAccountStatus();
      if (!accountStatus.ok) {
        if (accountStatus.reason === 'login') {
          showToast('로그인이 필요합니다.', 2000);
        } else if (accountStatus.reason === 'lock') {
          showToast('현재 계정이 차단된 상태입니다.', 2000);
        } else if (accountStatus.reason === 'use') {
          showToast('현재 사용이 불가한 상태입니다.', 2000);
        }
        return;
      }

      try {
        btn.disabled = true;
        showToast('게임 생성 중...', 3000);

        // 이미지 파일 확인 (선택사항이므로 필수 체크는 하지 않음)

        // 태그 수집
        const tags = Array.from(document.querySelectorAll('[data-field="tags"] input[type="checkbox"]:checked'))
          .map(cb => cb.value);

        // 속성 수집
        const attributesData = {};
        attributes.forEach(attr => {
          const enabledEl = document.getElementById(`attr-${attr.key}`);
          const maxEl = document.getElementById(`attr-${attr.key}-max`);
          const baseEl = document.getElementById(`attr-${attr.key}-base`);
          const enabled = enabledEl ? enabledEl.checked : attr.enabled;
          const max = maxEl ? (parseInt(maxEl.value) || attr.max) : attr.max;
          const base = baseEl ? (parseInt(baseEl.value) || attr.base) : attr.base;
          attributesData[attr.key] = { enabled, max, base };
        });

        // 룰 수집 (null 체크 포함)
        const getValue = (id, defaultValue) => {
          const el = document.getElementById(id);
          return el ? el.value : defaultValue;
        };
        const getChecked = (id, defaultValue) => {
          const el = document.getElementById(id);
          return el ? el.checked : defaultValue;
        };
        const getIntValue = (id, defaultValue) => {
          const el = document.getElementById(id);
          return el ? (parseInt(el.value) || defaultValue) : defaultValue;
        };
        const getFloatValue = (id, defaultValue) => {
          const el = document.getElementById(id);
          return el ? (parseFloat(el.value) || defaultValue) : defaultValue;
        };
        
        const rules = {
          success_base: getIntValue('success-base', 60),
          difficulty_mod: {
            easy: getIntValue('difficulty-easy', -10),
            normal: getIntValue('difficulty-normal', 0),
            hard: getIntValue('difficulty-hard', 10),
            very_hard: getIntValue('difficulty-very-hard', 20),
          },
          ability_scale: getFloatValue('ability-scale', 1.0),
          attributes: attributesData,
          dice: {
            count: getIntValue('dice-count', 5),
            faces: getIntValue('dice-faces', 20),
          },
          damage: {
            str_multiplier: getFloatValue('str-multiplier', 1.0),
            flat_bonus: getIntValue('flat-bonus', 0),
            success_bonus_scale: getFloatValue('success-bonus-scale', 1.0),
            on_fail_zero: getChecked('on-fail-zero', true),
          },
          critical: {
            threshold_ratio: getFloatValue('critical-threshold', 0.95),
            multiplier: getFloatValue('critical-multiplier', 2.0),
            base_bonus_multiplier: getFloatValue('critical-base-bonus', 1.5),
          },
        };

        // 캐릭터 배열 (char_ref_id와 role만, snapshot은 백엔드에서 생성)
        const characters = selectedCharacters.map(char => ({
          char_ref_id: parseInt(char.char_ref_id) || char.char_ref_id,
          role: char.role || 'random',
        }));

        // 요청 데이터 (world_snapshot과 character snapshot은 백엔드에서 생성)
        const worldRefId = selectedWorld.id || selectedWorld._id || selectedWorld.mongo_id;
        const scenarioSummaryEl = document.getElementById('scenario-summary');
        const scenarioDetailEl = document.getElementById('scenario-detail');
        const payload = {
          title: title,
          world_ref_id: parseInt(worldRefId) || worldRefId,
          scenario_summary: scenarioSummaryEl ? scenarioSummaryEl.value.trim() : '',
          scenario_detail: scenarioDetailEl ? scenarioDetailEl.value.trim() : '',
          tags: tags,
          characters: characters,
          rules: rules,
        };

        // FormData로 이미지 + 메타 전송 (캐릭터/세계관 생성과 동일한 방식)
        const formData = new FormData();
        if (backgroundImageFile) {
          formData.append('file', backgroundImageFile);
        }
        formData.append('meta', JSON.stringify(payload));

        // 인증 헤더 추가 (FormData는 Content-Type을 자동으로 설정하므로 제외)
        const headers = getAuthHeaders();
        delete headers['Content-Type'];

        const response = await fetch(`${API_BASE_URL}/v1/games`, {
          method: 'POST',
          headers: headers,
          credentials: 'include',
          body: formData,
        });

        if (!response.ok) {
          let errorDetail = '게임 생성 중 오류가 발생했습니다.';
          try {
            const error = await response.json();
            errorDetail = error.detail || errorDetail;
          } catch (e) {
            // JSON 파싱 실패 시 기본 메시지 사용
          }
          showToast(errorDetail, 3000);
          btn.disabled = false;
          return;
        }

        const result = await response.json();
        showToast('게임이 성공적으로 생성되었습니다!', 2000);
        
        // 2초 후 홈으로 이동 (또는 게임 상세 페이지로)
        setTimeout(() => {
          window.location.href = '/home.html';
        }, 2000);
      } catch (error) {
        console.error('Save error:', error);
        showToast('게임 생성 요청 중 네트워크 오류가 발생했습니다.', 3000);
        btn.disabled = false;
      }
    });

    // 이벤트 리스너 등록 (null 체크 포함)
    // 세계관 선택 display 필드
    const worldSelectDisplay = document.getElementById('world-select-display');
    if (worldSelectDisplay) {
      worldSelectDisplay.addEventListener('click', openWorldModal);
    }
    
    const worldSelectText = document.getElementById('world-select-text');
    const worldSelectHidden = document.getElementById('world-select');
    
    // 캐릭터 선택 display 필드
    const charSelectDisplay = document.getElementById('character-select-display');
    if (charSelectDisplay) {
      charSelectDisplay.addEventListener('click', openCharacterModal);
    }
    
    const charSelectText = document.getElementById('character-select-text');
    const charSelectHidden = document.getElementById('character-select');
    const charSelectedChips = document.getElementById('character-selected-chips');
    
    const btnCloseWorldModal = document.getElementById('btn-close-world-modal');
    if (btnCloseWorldModal) {
      btnCloseWorldModal.addEventListener('click', closeWorldModal);
    }
    
    const btnCloseWorldModalFooter = document.getElementById('btn-close-world-modal-footer');
    if (btnCloseWorldModalFooter) {
      btnCloseWorldModalFooter.addEventListener('click', closeWorldModal);
    }
    
    const btnCloseCharacterModal = document.getElementById('btn-close-character-modal');
    if (btnCloseCharacterModal) {
      btnCloseCharacterModal.addEventListener('click', closeCharacterModal);
    }
    
    const btnCloseCharacterModalFooter = document.getElementById('btn-close-character-modal-footer');
    if (btnCloseCharacterModalFooter) {
      btnCloseCharacterModalFooter.addEventListener('click', closeCharacterModal);
    }
    
    const btnApplyCharacterSelection = document.getElementById('btn-apply-character-selection');
    if (btnApplyCharacterSelection) {
      btnApplyCharacterSelection.addEventListener('click', applyCharacterSelection);
    }
    
    // 검색 입력 필드
    const worldSearchInput = document.getElementById('world-search-input');
    if (worldSearchInput) {
      worldSearchInput.addEventListener('input', function(e) {
        worldSearchText = e.target.value;
        renderWorldModalList();
      });
    }
    
    const characterSearchInput = document.getElementById('character-search-input');
    if (characterSearchInput) {
      characterSearchInput.addEventListener('input', function(e) {
        characterSearchText = e.target.value;
        renderCharacterModalList();
      });
    }
    
    // 모달 배경 클릭 시 닫기
    const worldModal = document.getElementById('world-modal');
    if (worldModal) {
      worldModal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeWorldModal();
        }
      });
    }
    
    const characterModal = document.getElementById('character-modal');
    if (characterModal) {
      characterModal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeCharacterModal();
        }
      });
    }

    // 초기화
    (async function() {
      renderAttributes();
      updateDiceMax();
      
      // 초기 선택 상태 표시
      if (selectedWorld && worldSelectText) {
        worldSelectText.textContent = selectedWorld.name || '세계관을 선택하세요';
        syncWorldHiddenField();
      }
      
      // 초기 캐릭터 선택 상태 표시
      if (selectedCharacters.length > 0) {
        renderSelectedCharacterChips();
        syncCharacterHiddenField();
        renderCharacterList();
      }
      
      // 세계관/캐릭터 목록은 모달 열 때 로드
    })();
  </script>
</body>
</html>

