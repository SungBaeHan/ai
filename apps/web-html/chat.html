<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat · TRPG</title>
<style>
  :root{ --bg:#0b0f14; --ink:#e5ecf3; --sub:#a7bed6; --accent:#60a5fa; --border:#1f2a36; }
  *{box-sizing:border-box} body{margin:0; background:var(--bg); color:var(--ink); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .page{min-height:100dvh; display:flex; flex-direction:column; position:relative;}
  .hero{position:fixed; inset:0; z-index:-2; background:center/cover no-repeat; filter: blur(14px) brightness(.45); transform:scale(1.04);}
  .veil{position:fixed; inset:0; z-index:-1; background: radial-gradient(ellipse at 50% 20%, rgba(0,0,0,.12), rgba(0,0,0,.7) 60%, rgba(0,0,0,.9));}
  header{ display:flex; align-items:center; gap:10px; padding:12px 14px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.7), rgba(11,15,20,0)); }
  header img.avatar{ width:28px; height:28px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,.2);}
  header .title{ font-weight:700; letter-spacing:.2px; }
  a.back{ color:#cfe4ff; text-decoration:none; padding:6px 8px; border-radius:8px; background:rgba(0,0,0,.25); border:1px solid var(--border);}
  main{ flex:1 1 auto; padding:10px 12px 94px; }
  .day{ align-self:center; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:999px; color:#cfe4ff; font-size:12px; margin:8px 0; border:1px solid var(--border); }
  .row{ display:flex; gap:10px; margin:10px 0; align-items:flex-end; }
  .row .bubble{ max-width: 86vw; padding:12px 14px; border-radius:16px; line-height:1.6; box-shadow:0 6px 18px rgba(0,0,0,.35); }
  .row.me{ justify-content:flex-end; }
  .row.me .bubble{ background: linear-gradient(180deg, rgba(96,165,250,.15), rgba(96,165,250,.08)); border:1px solid rgba(96,165,250,.35); }
  .row.ai .bubble{ background: rgba(10,14,18,.78); border:1px solid var(--border); }
  .row img.avatar{ width:32px; height:32px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,.2);}
  .inputbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(0deg, rgba(11,15,20,1), rgba(11,15,20,.92)); border-top:1px solid var(--border); padding:10px 12px calc(env(safe-area-inset-bottom)+10px); display:flex; gap:8px; }
  .inputbar textarea{ flex:1 1 auto; resize:none; border:1px solid var(--border); background:rgba(15,20,26,.8); color:var(--ink); border-radius:12px; min-height:42px; max-height:120px; padding:10px 12px; }
  .inputbar button{ background: var(--accent); color:#05223e; border:none; border-radius:12px; padding: 0 14px; font-weight:700; min-width:74px; }
  .choices{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0 42px; }
  .choice{ background:rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.35); color:#cfe4ff; padding:8px 10px; border-radius:12px; cursor:pointer; }
  .hint{ color:var(--sub); font-size:12px; }

  .profile { width: 100%; }
  .profile-hero{ height: 200px; border-radius:12px; background-size:cover; background-position:center; margin:-6px -6px 8px -6px; filter: brightness(.9); }
  .profile-body{ display:flex; flex-direction:column; gap:6px; }
  .profile-title{ font-weight:700; opacity:.9; }
  .profile-name{ font-size:18px; font-weight:800; letter-spacing:.2px; }
  .profile-arch{ font-size:13px; color:var(--sub); }
  .profile-bio{ font-size:14px; color:#cfe4ff; line-height:1.6; }
  .profile-tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top:2px; }
  .profile-tags span{ font-size:12px; color:#cfe4ff; background:rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.35); border-radius:999px; padding:4px 8px; }
</style>

<body class="page">
  <div id="hero" class="hero" style="background-image:url('/assets/img/bg_default.jpg')"></div>
  <div class="veil"></div>

  <header>
    <a class="back" href="/">← 홈</a>
    <img id="avatar" class="avatar" src="/assets/img/placeholder.png" alt="">
    <div id="title" class="title">세션</div>
  </header>

  <main id="log"><div class="day">오늘</div></main>

  <div class="inputbar">
    <textarea id="input" placeholder="메시지 입력..."></textarea>
    <button id="send">보내기</button>
  </div>

<script>
  const CANDIDATES = ['characters.json','/json/characters.json'];
  const API = ''; // same-origin

  function qs(key){ return new URL(location.href).searchParams.get(key); }

  // ← 핵심: 값이 있을 땐 그대로 쓰고, 없을 때만 fallback 사용
  function resolvePath(p, fallback = '/assets/img/placeholder.png') {
    if (!p) return fallback;
    if (/^https?:|^data:/.test(p)) return p;
    if (p.startsWith('/')) return p;
    return '/assets/img/' + p.replace(/^(\.\/)+/, '');
  }

  function profileHTML(ch){
    const tags = (ch.tags||[]).map(t=>`<span>${t}</span>`).join('');
    const bio  = ch.longBio || ch.shortBio || '';
    return `
      <div class="profile">
        <div class="profile-hero" style="background-image:url('${resolvePath(ch.image, '/assets/img/bg_default.jpg')}')"></div>
        <div class="profile-body">
          <div class="profile-title">소개</div>
          <div class="profile-name">${ch.name||''}</div>
          <div class="profile-arch">${ch.archetype||''}</div>
          <div class="profile-bio">${bio}</div>
          ${tags ? `<div class="profile-tags">${tags}</div>`:''}
        </div>
      </div>`;
  }

  function md(text){
    return (text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>');
  }

  function row(kind, html, avatarSrc){
    const me = kind==='me';
    const wrap = document.createElement('div');
    wrap.className = 'row ' + (me?'me':'ai');
    if(!me){
      const av = document.createElement('img');
      av.className='avatar';
      av.src = resolvePath(avatarSrc, '/assets/img/placeholder.png');
      av.alt=''; wrap.appendChild(av);
    }
    const b = document.createElement('div'); b.className='bubble'; b.innerHTML = html; wrap.appendChild(b);
    return wrap;
  }

  function append(kind, text, avatar){
    const wrap = row(kind, md(text), avatar);
    document.getElementById('log').appendChild(wrap);
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  function appendHTML(kind, html, avatar){
    const wrap = row(kind, html, avatar);
    wrap.querySelector('.bubble').innerHTML = html;
    document.getElementById('log').appendChild(wrap);
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  async function loadFirst(paths){
    for(const p of paths){
      try{ const r = await fetch(p); if(!r.ok) throw new Error(r.statusText); return await r.json(); }
      catch(_){}
    }
    return {characters:[{id:'char_01',name:'동료',image:'/assets/img/placeholder.png',greeting:'안녕! 같이 시작해보자.'}]};
  }

  function extractChoices(answer){
    const out = []; let seen = new Set(); let inChoices = false;
    for(const raw of (answer||'').split(/\r?\n/)){
      const line = raw.trim();
      if(!inChoices){ if(/\[선택지\]/.test(line)) inChoices = true; continue; }
      if(!line) break;
      const m = line.match(/^(?:[-•]|\(?\d+\)?[.)])\s*(.+)$|^\((.+)\)$|^\[(.+)\]$/);
      const t = (m ? (m[1]||m[2]||m[3]) : line).replace(/^[\(\[]|[\)\]]$/g,'');
      if(t && !seen.has(t)){ out.push(t); seen.add(t); }
      if(out.length>=3) break;
    }
    return out;
  }

  (async function init(){
    const charId = qs('character') || sessionStorage.getItem('lastChar') || 'char_01';
    const data = await loadFirst(CANDIDATES);
    const byId = Object.fromEntries((data.characters||[]).map(c=>[c.id,c]));
    const ch = byId[charId] || (data.characters||[])[0];

    // UI 세팅 (값이 있으면 ch.image가 우선, 없을 땐 fallback 사용)
    document.getElementById('title').textContent = (ch.name||'세션');
    document.getElementById('avatar').src = resolvePath(ch.image, '/assets/img/placeholder.png');
    document.getElementById('hero').style.backgroundImage = 'url(' + resolvePath(ch.image, '/assets/img/bg_default.jpg') + ')';
    sessionStorage.setItem('lastChar', ch.id);

    const log   = document.getElementById('log');
    const input = document.getElementById('input');
    const send  = document.getElementById('send');

    async function callChat(message){
      const persona =
        '[캐릭터 동료]\n'
        + `- 이름: ${ch.name||''}\n`
        + `- 성격/역할: ${ch.archetype||''}\n`
        + `- 배경요약: ${(ch.longBio||ch.shortBio||'')}\n`
        + `- 태그: ${(ch.tags||[]).join(', ')}\n`
        + '- 말투: 구어체, 간결, 1인칭.\n\n';

      const payload = {
        message: persona + message,
        mode: 'trpg',
        model: 'trpg-gen',
        temperature: 0.9,
        top_p: 0.95
      };
      const r = await fetch('/v1/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload), credentials:'include'
      });
      if(!r.ok) throw new Error(r.statusText);
      return await r.json();
    }

    async function handleSend(){
      const t = (input.value||'').trim(); if(!t) return;
      append('me', t, ch.image); input.value='';
      const ph = row('ai','<span class="hint">생각 중…</span>', ch.image); log.appendChild(ph);
      try{
        const data = await callChat(t);
        const ans = data.answer || '';
        ph.querySelector('.bubble').innerHTML = md(ans.split('\n\n[선택지]')[0]||ans);
        const choices = extractChoices(ans);
        if(choices.length){
          const bar = document.createElement('div'); bar.className='choices';
          for(const c of choices){
            const btn = document.createElement('button'); btn.className='choice'; btn.textContent = c;
            btn.onclick = ()=>{ input.value = c; handleSend(); };
            bar.appendChild(btn);
          }
          log.appendChild(bar);
        }
      }catch(e){
        ph.querySelector('.bubble').innerHTML = '에러: ' + (e?.message || String(e));
      }finally{
        window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
      }
    }

    document.getElementById('send').addEventListener('click', handleSend);
    document.getElementById('input').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });

    // 첫 화면: 프로필 카드 + 인사
    appendHTML('ai', profileHTML(ch), ch.image);
    if(ch.greeting) append('ai', ch.greeting, ch.image);
  })();
</script>
</body>
</html>
