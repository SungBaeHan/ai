<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat • TRPG</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0f14; color:#e5e7eb; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, 'Apple SD Gothic Neo','Malgun Gothic',sans-serif; }
    .topbar-wrap { display:flex; justify-content:center; border-bottom:1px solid #1b2430; background:#0e141c; position:sticky; top:0; z-index:20; }
    .topbar { width:100%; max-width:980px; display:flex; align-items:center; gap:10px; padding:10px 14px; }
    .back { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid #223042; background:#0f172a; color:#cbd5e1; cursor:pointer; }
    .title { font-weight:700; font-size:15px; color:#f1f5f9; }
    .hero { position:relative; margin:18px auto; max-width:980px; }
    .hero img { width:100%; border-radius:14px; border:1px solid #1f2937; box-shadow:0 10px 28px rgba(0,0,0,.35); display:block; }
    .panel { max-width:980px; margin:10px auto 18px; background:#0f172a; border:1px solid #1e293b; border-radius:12px; padding:12px 14px; }
    .chips { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip { padding:3px 8px; font-size:11px; border-radius:999px; border:1px solid #334155; color:#a5b4fc; background:#0b1220; }
    .chat { max-width:980px; margin:0 auto 90px; }
    .msg { display:flex; gap:10px; margin:10px 0; }
    .me  .bubble { background:#0b1220; }
    .bubble { background:#111827; border:1px solid #1f2937; padding:10px 12px; border-radius:12px; white-space:pre-wrap; }
    .inputBar { position:fixed; left:0; right:0; bottom:0; border-top:1px solid #1b2430; background:#0e141c; padding:12px; }
    .inputIn { max-width:980px; margin:0 auto; display:flex; gap:8px; }
    textarea { flex:1; resize:none; background:#0b1220; border:1px solid #1f2937; border-radius:10px; color:#e5e7eb; padding:10px 12px; min-height:44px; }
    button { padding:0 14px; border-radius:10px; border:1px solid #334155; background:#111827; color:#c7d2fe; height:44px; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .bg { position:fixed; inset:0; background-position:center; background-size:cover; opacity:.12; filter:blur(4px); z-index:-1; }
    .hint { font-size:12px; color:#9ca3af; margin:6px 0 0 0; }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div>

  <div class="topbar-wrap">
    <div class="topbar">
      <button id="backBtn" class="back" title="뒤로 가기" aria-label="뒤로">←</button>
      <div class="title" id="title">로딩 중…</div>
    </div>
  </div>

  <div class="hero"><img id="hero" alt="cover" src="/assets/img/placeholder.jpg" /></div>

  <div class="panel" id="about">
    <div style="font-weight:700; margin-bottom:6px;">소개</div>
    <div id="bio" style="opacity:.9"></div>
    <div class="chips">
      <span class="chip">TRPG</span>
      <span class="chip" id="chip-name">캐릭터</span>
    </div>
    <div class="hint">Tip: 메세지를 보내면 /v1/chat (TRPG 모드)로 요청합니다.</div>
  </div>

  <div class="chat" id="chat"></div>

  <div class="inputBar">
    <div class="inputIn">
      <textarea id="ta" placeholder="메시지 입력…"></textarea>
      <button id="send">보내기</button>
    </div>
  </div>

  <script>
    // ===== utils =====
    const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#0e141c"/><text x="50%" y="50%" fill="#94a3b8" font-size="48" font-family="sans-serif" text-anchor="middle" dominant-baseline="middle">No Image</text></svg>`);
    function qs(k){ return new URL(location.href).searchParams.get(k); }
    function normalizeCharId(v){ if(!v) return null; if(/^char_\d{1,2}$/i.test(v)) return 'char_' + String(parseInt(v.split('_')[1],10)).padStart(2,'0'); if(/^\d+$/.test(v)) return parseInt(v,10); return v; }
    function resolvePath(p){ if (!p) return '/assets/img/placeholder.jpg'; if (/^https?:\/\//i.test(p)) return p; return p.startsWith('/') ? p : '/assets/img/' + p; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c])); }
    function safeSetHero(imgUrl){ const hero = document.getElementById('hero'); hero.onerror = () => { hero.src = FALLBACK_SVG; }; hero.src = imgUrl || '/assets/img/placeholder.jpg'; }

    // ===== data loaders =====
    const LOCAL_CANDIDATES = ['/json/characters.json','/characters.json','/static/characters.json'];
    async function loadFromApi(){ const r = await fetch('/v1/characters?offset=0&limit=200', { cache:'no-store' }); if(!r.ok) throw new Error('HTTP '+r.status); const j = await r.json(); return j.items || []; }
    async function loadFromLocal(url){ const r = await fetch(url, { cache:'no-store' }); if(!r.ok) throw new Error('HTTP '+r.status); const j = await r.json(); return j.characters || j.items || j || []; }
    async function loadCharacters(){ try { return await loadFromApi(); } catch(_){ for(const url of LOCAL_CANDIDATES){ try{ const v = await loadFromLocal(url); if(v && v.length) return v; }catch(__){} } return []; } }

    // ===== paint =====
    function paintCharacter(ch){
      document.getElementById('title').textContent = ch.name || ch.id;
      document.getElementById('chip-name').textContent = ch.name || '캐릭터';
      document.getElementById('bio').textContent = (ch.longBio || ch.shortBio || ch.greeting || ch.detail || ch.summary || '').toString();
      const img = resolvePath(ch.image || ch.cover);
      safeSetHero(img);
      document.getElementById('bg').style.backgroundImage = `url("${img}")`;
    }

    // ===== chat helpers =====
    function addUser(text){
      const chat = document.getElementById('chat');
      const row = document.createElement('div'); row.className='msg me';
      row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
    }
    function addBot(text){
      const chat = document.getElementById('chat');
      const row = document.createElement('div'); row.className='msg';
      row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
    }
    async function askLLM(message, mode='trpg'){
      const r = await fetch('/v1/chat/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          message,
          mode,              // 'trpg' | 'qa'
          model:'trpg-gen',  // 서버 올라마 태그에 맞춰 조정
          polish_model:'trpg-polish'
        })
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return j.answer || '';
    }

    // ===== init =====
    (async function init(){
      // back
      document.getElementById('backBtn').onclick = () => { if (history.length > 1) history.back(); else location.href = '/'; };

      // decide char
      const raw = qs('character') || qs('character_id') || sessionStorage.getItem('lastChar') || null;
      const norm = normalizeCharId(raw);
      const items = await loadCharacters();
      const byNumId = Object.fromEntries(items.filter(x => typeof x.id === 'number').map(x => [x.id, x]));
      const byName  = Object.fromEntries(items.map(x => [String(x.name||'').trim(), x]));
      function findByCharCode(code){ if(!code) return null; const m = String(code).match(/^char_(\d{2})$/i); if(!m) return null; const needle = '/char_' + m[1] + '.'; return items.find(x => typeof x.image === 'string' && x.image.includes(needle)) || null; }
      let ch = null;
      if (typeof norm === 'number') ch = byNumId[norm] || null;
      if (!ch && typeof norm === 'string' && /^char_\d{2}$/i.test(norm)) ch = findByCharCode(norm);
      if (!ch && typeof raw === 'string') ch = byName[String(raw).trim()] || null;
      if (!ch && items.length) ch = items[0];
      if (!ch) ch = { id:'char_01', name:'동료', image:'/assets/img/placeholder.jpg', greeting:'안녕! 같이 시작해보자.' };
      try { sessionStorage.setItem('lastChar', ch.id); } catch(_){}
      paintCharacter(ch);

      // first greeting if exists
      if (ch.greeting) addBot(ch.greeting);

      // send
      const ta = document.getElementById('ta');
      const btn = document.getElementById('send');
      async function send(){
        const v = ta.value.trim();
        if(!v) return;
        addUser(v);
        ta.value=''; btn.disabled = true;
        try {
          const ans = await askLLM(v, 'trpg');
          addBot(ans || '(응답이 비어있습니다)');
        } catch(e){
          addBot('서버 오류: ' + e.message);
        } finally {
          btn.disabled = false; ta.focus();
        }
      }
      btn.onclick = send;
      ta.addEventListener('keydown', (ev)=>{
        if (ev.key === 'Enter' && !ev.shiftKey) {
          ev.preventDefault();
          send();
        }
      });
    })();
  </script>
</body>
</html>
