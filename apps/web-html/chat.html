<!-- ========================================
     apps/web-html/chat.html — 상세(채팅) 화면
     - URL ?character=char_06 또는 ?character=6 지원
     - /v1/characters/:id 단건 호출해서 렌더
     - 이미지 경로 보정(resolvePath)로 /assets/char/… 보장
     ======================================== -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat • TRPG</title>
  <script src="/js/config.js"></script>
  <script>
    // Cloudflare Pages 배포 환경에서 사용할 기본 API 엔드포인트
    window.API_BASE_URL = 'https://api.arcanaverse.ai';
    window.API_BASE = 'https://api.arcanaverse.ai';  // API_BASE도 함께 설정
  </script>
  <style>
    :root { color-scheme: dark; } /* 다크 테마 힌트 */
    body { margin:0; background:#0b0f14; color:#e5e7eb; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,'Apple SD Gothic Neo','Malgun Gothic',sans-serif; }
    .topbar-wrap { display:flex; justify-content:center; border-bottom:1px solid #1b2430; background:#0e141c; position:sticky; top:0; z-index:20; }
    .topbar { width:100%; max-width:980px; display:flex; align-items:center; gap:10px; padding:10px 14px; }
    .back { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid #223042; background:#0f172a; color:#cbd5e1; cursor:pointer; }
    .title { font-weight:700; font-size:15px; color:#f1f5f9; flex:1; }
    .persona-btn { padding:6px 12px; border-radius:8px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; font-size:13px; cursor:pointer; transition:all .15s ease; }
    .persona-btn:hover { background:#334155; border-color:#475569; }
    .hero { position:relative; margin:18px auto; max-width:980px; }
    .hero img { width:100%; border-radius:14px; border:1px solid #1f2937; box-shadow:0 10px 28px rgba(0,0,0,.35); display:block; }
    .panel { max-width:980px; margin:10px auto 18px; background:#0f172a; border:1px solid #1e293b; border-radius:12px; padding:12px 14px; }
    .chips { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip { padding:3px 8px; font-size:11px; border-radius:999px; border:1px solid #334155; color:#a5b4fc; background:#0b1220; }
    .hint { font-size:12px; color:#9ca3af; margin-top:6px; }
    .chat { max-width:980px; margin:0 auto 90px; padding:0 4px; }
    .msg { display:flex; align-items:flex-start; gap:10px; margin:14px 0; animation:fadeInUp .35s ease; }
    .msg.me { flex-direction:row-reverse; }
    .avatar { width:42px; height:42px; border-radius:50%; object-fit:cover; box-shadow:0 0 6px rgba(0,0,0,.4); }
    .bubble { background:#111827; border:1px solid #1f2937; padding:10px 14px; border-radius:14px; white-space:pre-wrap; line-height:1.6; max-width:70%; }
    .me .bubble { background:rgba(63,131,248,0.25); border-color:#334155; }
    .inputBar { position:fixed; left:0; right:0; bottom:0; border-top:1px solid #1b2430; background:#0e141c; padding:12px; }
    .inputIn { max-width:980px; margin:0 auto; display:flex; gap:8px; }
    textarea { flex:1; resize:none; background:#0b1220; border:1px solid #1f2937; border-radius:10px; color:#e5e7eb; padding:10px 12px; min-height:44px; }
    button { padding:0 14px; border-radius:10px; border:1px solid #334155; background:#111827; color:#c7d2fe; height:44px; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .bg { position:fixed; inset:0; background-position:center; background-size:cover; opacity:.4; filter:blur(1.5px) brightness(0.9); z-index:-1; transition:filter .5s ease, opacity .5s ease; }
    .debug { max-width:980px; margin:6px auto 0; font-size:12px; color:#93c5fd; opacity:.9; white-space:pre-wrap; }
    /* toast layer */
    .toast { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition:opacity .18s ease; z-index:50; }
    .toast.show { opacity:1; }
    .toast .box { pointer-events:auto; min-width:200px; max-width:80vw; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; padding:14px 18px; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.45); text-align:center; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    
    /* persona modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .modal-backdrop.show { opacity:1; pointer-events:auto; }
    .modal { background:#111827; border:1px solid #1f2937; border-radius:12px; width:90%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #1f2937; }
    .modal-header h2 { margin:0; font-size:18px; color:#f3f4f6; }
    .modal-close { background:none; border:none; color:#94a3b8; font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; }
    .modal-close:hover { color:#e5e7eb; }
    .modal-body { padding:20px; max-height:60vh; overflow-y:auto; }
    
    /* Persona Card Styles (from personas.html) */
    .persona-list { display:flex; flex-direction:column; gap:12px; }
    .persona-card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; transition:all .15s ease; cursor:pointer; }
    .persona-card:hover { border-color:#3b82f6; }
    .persona-card.selected { border-color:#3b82f6; border-width:2px; background:#1e3a8a; }
    .persona-card.default { border-color:#3b82f6; background:#1e3a8a; }
    .persona-card-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .persona-avatar { width:64px; height:64px; border-radius:8px; background:#1f2937; object-fit:cover; border:2px solid #334155; }
    .persona-info { flex:1; }
    .persona-name { font-size:16px; font-weight:600; color:#f3f4f6; margin-bottom:4px; }
    .persona-badge { display:inline-block; padding:2px 8px; background:#3b82f6; color:#fff; border-radius:4px; font-size:11px; font-weight:600; margin-right:6px; }
    .persona-gender { font-size:12px; color:#94a3b8; }
    .persona-bio { font-size:13px; color:#cbd5e1; line-height:1.5; margin-bottom:12px; max-height:60px; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
    .persona-selected-info { padding:12px; background:#1e293b; border-radius:8px; margin-top:12px; font-size:13px; color:#cbd5e1; }
    .persona-selected-info strong { color:#3b82f6; }
    .modal-footer { padding:20px; border-top:1px solid #1f2937; flex-shrink:0; }
    .btn-modal { padding:10px 20px; border-radius:6px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; font-size:14px; font-weight:500; cursor:pointer; transition:all .15s ease; }
    .btn-modal:hover { background:#334155; }
    .btn-modal.primary { background:#3b82f6; border-color:#2563eb; color:#fff; }
    .btn-modal.primary:hover { background:#2563eb; }
    .modal-loading { text-align:center; padding:40px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div> <!-- 흐림 배경 -->

  <div class="topbar-wrap">
    <div class="topbar">
      <button id="backBtn" class="back" title="뒤로 가기">←</button> <!-- 뒤로가기 -->
      <div class="title" id="title">로딩 중…</div>                   <!-- 캐릭터 이름 -->
      <button id="personaBtn" class="persona-btn" title="페르조나 설정">Persona</button> <!-- 페르조나 버튼 -->
    </div>
  </div>

  <div class="hero"><img id="hero" alt="cover" src="/assets/img/placeholder.jpg" /></div> <!-- 히어로 이미지 -->
  <div class="debug" id="dbg"></div> <!-- 디버그 로그(요청/이미지 경로) -->

  <div class="panel" id="about">
    <div style="font-weight:700; margin-bottom:6px;">소개</div>
    <div id="bio" style="opacity:.9"></div> <!-- 장문 소개/배경 -->
    <div class="chips">
      <span class="chip">TRPG</span>
      <span class="chip" id="chip-name">캐릭터</span>
    </div>
    <div class="hint">Tip: 메세지를 보내면 /v1/chat (TRPG 모드)로 요청합니다.</div>
  </div>

  <div class="chat" id="chat"></div> <!-- 채팅 로그 -->

  <div class="inputBar">
    <div class="inputIn">
      <textarea id="ta" placeholder="메시지 입력…"></textarea>  <!-- 입력창 -->
      <button id="send">보내기</button>                         <!-- 전송 -->
    </div>
  </div>

  <!-- Toast Layer -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <div class="box">준비중입니다</div>
  </div>

  <!-- Persona Modal -->
  <div id="personaModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>페르조나 선택</h2>
        <button class="modal-close" onclick="closePersonaModal()">×</button>
      </div>
      <div class="modal-body" id="personaModalBody">
        <div class="modal-loading">로딩 중...</div>
      </div>
      <div class="modal-footer">
        <div id="personaSelectedInfo" class="persona-selected-info" style="display:none;"></div>
        <div style="display:flex; justify-content:flex-end; gap:12px; width:100%;">
          <button class="btn-modal" onclick="closePersonaModal()">취소</button>
          <button class="btn-modal primary" id="personaConfirmBtn" onclick="confirmPersonaSelection()" disabled>완료</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 절대경로 API_BASE_URL 상수 정의
    const API_BASE_URL =
      window.location.hostname === "arcanaverse.ai" ||
      window.location.hostname === "www.arcanaverse.ai"
        ? "https://api.arcanaverse.ai"
        : "http://localhost:8000";

  /*
  console.info("[chat] inline script loaded");

  window.addEventListener("error", (e) => {
    console.error("[chat] JS error:", e.message, e.filename, e.lineno);
  });
  */


    // --- 전역/유틸 -------------------------------------------------------------
    let CURRENT_CHAR = null;  // 현재 캐릭터
    let CURRENT_SESSION = null;  // 현재 세션
    let PERSONAS_LIST = [];  // 페르조나 목록
    let SELECTED_PERSONA_ID = null;  // 선택된 페르조나 ID
    const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#0e141c"/><text x="50%" y="50%" fill="#94a3b8" font-size="48" font-family="sans-serif" text-anchor="middle" dominant-baseline="middle">No Image</text></svg>`
    );
    const dbg = (m) => { 
      const el=document.getElementById('dbg'); 
      // el.textContent = (el.textContent?el.textContent+"\n":"") + m; 
      // console.log(m); 
    };

    function qs(k){ return new URL(location.href).searchParams.get(k); } // 쿼리 파서

    // 'char_06' → 6 / '6' → 6
    function normalizeCharId(v){
      if(!v) return null;
      if(/^char_\d{1,6}$/i.test(v)) return parseInt(v.split('_')[1],10);
      if(/^\d+$/.test(v)) return parseInt(v,10);
      return v;
    }

    // 이미지 경로 보정 → 항상 /assets/char/... 또는 /assets/img/... 로
    function resolvePath(p){
      if (!p) return '/assets/img/placeholder.jpg';
      if (/^https?:\/\//i.test(p)) return p;
      p = String(p).replace(/\\/g, '/').trim();
      if (p.startsWith('/')) return p;
      if (p.startsWith('assets/')) return '/' + p;

      if (p.includes('/char/') || p.startsWith('char/') || /^char_\d+/i.test(p) || p.startsWith('assets/char/')) {
        if (p.startsWith('assets/')) return '/' + p;
        if (p.startsWith('char_'))   return '/assets/char/' + p;
        if (p.startsWith('char/'))   return '/assets/' + p;
        // ▼ 여기와
        return '/assets/char/' + p.replace(/^\/+/, '');
      }
      // ▼ 여기도
      return '/assets/img/' + p.replace(/^\/+/, '');
    }

    // 안전한 hero 이미지 로더(404 시 SVG로 대체)
    function safeSetHero(imgUrl){
      const hero=document.getElementById('hero');
      hero.onerror=()=>{ dbg('[hero 404] '+imgUrl); hero.src=FALLBACK_SVG; };
      hero.onload =()=>{ dbg('[hero 200] '+imgUrl); };
      hero.src=imgUrl||'/assets/img/placeholder.jpg';
      dbg('[hero set] '+hero.src);
    }

    // 단일 캐릭터 API 호출 (상세)
    async function fetchCharacter(id){
      dbg('[fetch] /v1/characters/'+id);
      const r = await fetch(`${API_BASE_URL}/v1/characters/${id}`, {
        method: "GET",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        cache: 'no-store'
      });
      dbg('[fetch status] '+r.status);
      if(!r.ok) throw new Error('캐릭터 불러오기 실패: HTTP '+r.status);
      const j = await r.json();
      dbg('[fetch image] '+j.image);
      return j;
    }

    // 캐릭터 채팅 bootstrap API 호출 (기존 메시지 불러오기)
    async function bootstrapCharacterChat(characterId, limit = 50){
      const token = getToken();
      if (!token) {
        console.log('[CHAT][BOOTSTRAP] skip - no token');
        return { session: null, messages: [] };
      }

      // character_id 정규화 (char_XX 형태 처리)
      let charIdStr = characterId;
      if (typeof charIdStr === 'string' && charIdStr.startsWith('char_')) {
        try {
          charIdStr = String(parseInt(charIdStr.split('_')[1], 10));
        } catch (e) {
          charIdStr = String(characterId);
        }
      } else {
        charIdStr = String(characterId);
      }

      console.log(`[CHAT][BOOTSTRAP] request character_id=${charIdStr} limit=${limit}`);

      try {
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };

        const url = `${API_BASE_URL}/v1/characters/${charIdStr}/chat/bootstrap?limit=${limit}`;
        const r = await fetch(url, {
          method: "GET",
          credentials: "include",
          headers: headers,
          cache: 'no-store'
        });

        console.log(`[CHAT][BOOTSTRAP] response status=${r.status}`);

        if (!r.ok) {
          const errorText = await r.text();
          console.error(`[CHAT][BOOTSTRAP] fail status=${r.status} detail=${errorText}`);
          
          if (r.status === 401) {
            console.error('[CHAT][BOOTSTRAP] Authentication failed - token may be expired');
            showToast('세션이 만료되었습니다. 다시 로그인해주세요.', 3000);
          }
          
          return { session: null, messages: [] };
        }

        const data = await r.json();
        const messages = data.messages || [];
        const session = data.session;

        console.log(`[CHAT][BOOTSTRAP] ok messages=${messages.length} session_id=${session ? session.id : 'null'}`);
        
        // 세션 정보를 전역 변수에 저장
        if (session) {
          CURRENT_SESSION = session;
        }

        return { session, messages };
      } catch (e) {
        console.error(`[CHAT][BOOTSTRAP] fail error=${e.message}`, e);
        return { session: null, messages: [] };
      }
    }

    // 상단/배경/칩 렌더
    function paintCharacter(ch){
      document.getElementById('title').textContent=ch.name||ch.id;
      document.getElementById('chip-name').textContent=ch.name||'캐릭터';
      document.getElementById('bio').textContent=(ch.longBio||ch.background||ch.shortBio||ch.detail||ch.summary||ch.greeting||'').toString();

      const img=resolvePath(ch.image||ch.cover);
      dbg('[resolved img] '+img);
      safeSetHero(img);                                         // 히어로 이미지
      document.getElementById('bg').style.backgroundImage=`url("${img}")`; // 흐림 배경

      const wrap=document.querySelector('.chips');              // world/genre/style 칩
      wrap.querySelectorAll('.chip.extra').forEach(n=>n.remove());
      ['world','genre','style'].forEach(k=>{
        const v=(ch[k]||'').toString().trim();
        if(v){ const s=document.createElement('span'); s.className='chip extra'; s.textContent=v; wrap.appendChild(s); }
      });
    }

    // 채팅 메시지 DOM 유틸
    function escapeHtml(s){ 
      return String(s||'').replace(
        /[&<>"']/g,
        c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
      );
    }
    function addUser(text){ const chat=document.getElementById('chat'); const row=document.createElement('div'); row.className='msg me'; row.innerHTML=`<div class="bubble">${escapeHtml(text)}</div>`; chat.appendChild(row); chat.scrollTop=chat.scrollHeight; }
    function addBot(text){  const chat=document.getElementById('chat'); const row=document.createElement('div'); row.className='msg'; const img=resolvePath(CURRENT_CHAR?.image); row.innerHTML=`<img class="avatar" src="${img}" alt="bot"/><div class="bubble">${escapeHtml(text)}</div>`; chat.appendChild(row); chat.scrollTop=chat.scrollHeight; }

    // 토큰 관리
    const TOKEN_KEY = 'access_token';
    const USER_INFO_KEY = 'user_info_v2';

    function getToken() { return localStorage.getItem(TOKEN_KEY); }
    function isLoggedIn() { return !!getToken(); }

    async function getUserInfo() {
      const userInfoV2 = localStorage.getItem(USER_INFO_KEY);
      if (!userInfoV2) {
        return null;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/v1/auth/validate-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: userInfoV2 }),
          credentials: "include",
        });

        if (res.ok) {
          return await res.json();
        }
        return null;
      } catch (err) {
        console.error('Failed to get user info:', err);
        return null;
      }
    }

    /**
     * 계정 상태 체크
     * - ok: true 면 채팅 가능
     * - ok: false 이면 reason 으로 상태 구분
     *   - 'login': 로그인 필요
     *   - 'lock': 계정 차단
     *   - 'use': 사용 불가
     */
    async function checkAccountStatus() {
      const token = getToken();
      const info  = await getUserInfo();

      console.log('[ACCOUNT] token:', !!token, 'info:', info);

      if (!token) return { ok: false, reason: 'login' };

      if (!info)  return { ok: false, reason: 'login' };

      const is_use = info.is_use || false;
      const is_lock = info.is_lock || false;

      console.log('[ACCOUNT] is_use:', is_use, 'is_lock:', is_lock);

      if (is_lock) return { ok: false, reason: 'lock' };
      if (!is_use) return { ok: false, reason: 'use' };

      return { ok: true, reason: null };
    }

    // 토스트 메시지 표시
    function showToast(msg='준비중입니다', ms=2000){
      const el = document.getElementById('toast');
      el.querySelector('.box').textContent = msg;
      el.classList.add('show');
      clearTimeout(showToast.tid);
      showToast.tid = setTimeout(() => el.classList.remove('show'), ms);
    }

    // 페르조나 이미지 URL 정규화 함수 (personas.html에서 가져옴)
    const R2_BASE = "https://pub-09b0f3cad63f4891868948d43f19febf.r2.dev";
    function resolvePersonaUrl(u) {
      if (!u) return "";
      // 이미 절대 URL이면 그대로 반환
      if (u.startsWith("http://") || u.startsWith("https://")) return u;
      // 상대 경로(/assets/...)를 R2 절대 URL로 변환
      if (u.startsWith("/")) return `${R2_BASE}${u}`;
      // /로 시작하지 않으면 /assets/persona/를 prefix로 추가
      return `${R2_BASE}/assets/persona/${u}`;
    }

    // 페르조나 프리뷰 텍스트 추출 (우선순위: bio > summary > detail > 빈 문자열)
    function getPersonaPreview(p) {
      if (p.bio) return p.bio;
      if (p.summary) return p.summary;
      if (p.detail) return p.detail.substring(0, 120) + (p.detail.length > 120 ? '...' : '');
      return '';
    }

    // 페르조나 목록 조회
    async function fetchPersonas() {
      try {
        const token = localStorage.getItem('user_info_v2');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['X-User-Info-Token'] = token;
        }

        const res = await fetch(`${API_BASE_URL}/v1/users/me/personas`, {
          credentials: 'include',
          headers
        });

        if (!res.ok) {
          if (res.status === 401) {
            throw new Error('로그인이 필요합니다.');
          }
          throw new Error(`Failed to load: ${res.status}`);
        }

        const personas = await res.json();
        return personas;
      } catch (e) {
        console.error('[PERSONA] Load error:', e);
        throw e;
      }
    }

    // 페르조나 모달 열기
    async function openPersonaModal() {
      const modal = document.getElementById('personaModal');
      const body = document.getElementById('personaModalBody');
      
      modal.classList.add('show');
      SELECTED_PERSONA_ID = null;
      body.innerHTML = '<div class="modal-loading">로딩 중...</div>';

      try {
        PERSONAS_LIST = await fetchPersonas();
        renderPersonaList();
      } catch (e) {
        body.innerHTML = `<div class="modal-loading" style="color:#ef4444;">페르조나를 불러오는데 실패했습니다: ${e.message}</div>`;
        console.error('[PERSONA] Failed to load personas:', e);
      }
    }

    // 페르조나 목록 렌더링
    function renderPersonaList() {
      const body = document.getElementById('personaModalBody');
      const selectedInfo = document.getElementById('personaSelectedInfo');
      const confirmBtn = document.getElementById('personaConfirmBtn');
      
      if (PERSONAS_LIST.length === 0) {
        body.innerHTML = '<div class="modal-loading">페르조나가 없습니다. My 메뉴에서 페르조나를 생성해주세요.</div>';
        selectedInfo.style.display = 'none';
        confirmBtn.disabled = true;
        return;
      }

      // 카드 UI로 렌더링
      body.innerHTML = `<div class="persona-list">${PERSONAS_LIST.map(p => {
        const genderText = {
          male: '남성',
          female: '여성',
          nonbinary: '논바이너리'
        }[p.gender] || '논바이너리';

        // image_key 처리
        let imageKey = p.image_key || 'F01';
        if (imageKey && imageKey.startsWith('preset_')) {
          try {
            const num = parseInt(imageKey.replace('preset_', ''));
            if (num <= 4 || num === 9 || num === 10 || num === 13 || num === 15) {
              const mIndex = num <= 4 ? num : (num === 9 ? 5 : num === 10 ? 6 : num === 13 ? 7 : 8);
              imageKey = `M${String(mIndex).padStart(2, '0')}`;
            } else {
              const fIndex = num <= 8 ? num - 4 : (num === 11 ? 3 : num === 12 ? 4 : num === 14 ? 5 : 6);
              imageKey = `F${String(fIndex).padStart(2, '0')}`;
            }
          } catch {
            imageKey = 'F01';
          }
        }
        const imageUrl = resolvePersonaUrl(`/assets/persona/${imageKey}.png`);
        const previewText = getPersonaPreview(p);
        const selected = SELECTED_PERSONA_ID === p.persona_id ? 'selected' : '';
        const defaultClass = p.is_default ? 'default' : '';

        return `
          <div class="persona-card ${selected} ${defaultClass}" onclick="selectPersona('${p.persona_id}')">
            <div class="persona-card-header">
              <img src="${imageUrl}" alt="${escapeHtml(p.name)}" class="persona-avatar" onerror="this.src='${resolvePersonaUrl('/assets/persona/F01.png')}'" />
              <div class="persona-info">
                <div class="persona-name">
                  ${p.is_default ? '<span class="persona-badge">기본</span>' : ''}
                  ${escapeHtml(p.name)}
                </div>
                <div class="persona-gender">${genderText}</div>
              </div>
            </div>
            ${previewText ? `<div class="persona-bio">${escapeHtml(previewText)}</div>` : ''}
          </div>
        `;
      }).join('')}</div>`;

      // 선택된 페르조나 정보 표시
      if (SELECTED_PERSONA_ID) {
        const selectedPersona = PERSONAS_LIST.find(p => p.persona_id === SELECTED_PERSONA_ID);
        if (selectedPersona) {
          selectedInfo.innerHTML = `선택됨: <strong>${escapeHtml(selectedPersona.name)}</strong>`;
          selectedInfo.style.display = 'block';
          confirmBtn.disabled = false;
        } else {
          selectedInfo.style.display = 'none';
          confirmBtn.disabled = true;
        }
      } else {
        selectedInfo.style.display = 'none';
        confirmBtn.disabled = true;
      }
    }

    // 페르조나 선택
    function selectPersona(personaId) {
      SELECTED_PERSONA_ID = personaId;
      renderPersonaList();
    }

    // 페르조나 모달 닫기
    function closePersonaModal() {
      const modal = document.getElementById('personaModal');
      modal.classList.remove('show');
      SELECTED_PERSONA_ID = null;
    }

    // 페르조나 선택 완료
    async function confirmPersonaSelection() {
      if (!SELECTED_PERSONA_ID) {
        showToast('페르조나를 선택해주세요.');
        return;
      }

      if (!CURRENT_SESSION || !CURRENT_SESSION.id) {
        console.warn('[PERSONA] No session ID available');
        showToast('세션 정보를 찾을 수 없습니다.');
        return;
      }

      const sessionId = CURRENT_SESSION.id;
      const confirmBtn = document.getElementById('personaConfirmBtn');
      const originalText = confirmBtn.textContent;
      confirmBtn.disabled = true;
      confirmBtn.textContent = '적용 중...';

      try {
        const token = localStorage.getItem('user_info_v2');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['X-User-Info-Token'] = token;
        }

        // 임시 엔드포인트 호출 (백엔드가 아직 없을 수 있음)
        const res = await fetch(`${API_BASE_URL}/v1/character-sessions/${sessionId}/persona`, {
          method: 'POST',
          credentials: 'include',
          headers,
          body: JSON.stringify({ persona_id: SELECTED_PERSONA_ID })
        });

        if (!res.ok) {
          if (res.status === 404) {
            console.log('[PERSONA] API endpoint not found (404) - this is expected if backend is not implemented yet');
            showToast('페르조나 적용 API가 아직 구현되지 않았습니다.');
          } else {
            const errorText = await res.text().catch(() => 'Unknown error');
            console.error(`[PERSONA] API error: ${res.status} ${errorText}`);
            showToast(`페르조나 적용 실패: HTTP ${res.status}`);
          }
          return;
        }

        const data = await res.json().catch(() => ({}));
        console.log('[PERSONA] Successfully applied persona:', data);
        showToast('페르조나가 적용되었습니다.');
        closePersonaModal();
      } catch (e) {
        console.error('[PERSONA] Failed to apply persona:', e);
        showToast(`페르조나 적용 중 오류가 발생했습니다: ${e.message}`);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    }

    // 백엔드 LLM 호출
    async function askLLM(message, mode='trpg', choices=0){
      try {
      const token = getToken();
      const headers = { 'Content-Type': 'application/json' };
      
      // 로그인 토큰이 있으면 헤더에 추가
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const payload = {
        message, mode,
        model:'trpg-gen', polish_model:'trpg-polish', choices,
        character_id: CURRENT_CHAR?.id ?? null,
        character: CURRENT_CHAR ? {
          id: CURRENT_CHAR.id, name: CURRENT_CHAR.name, archetype: CURRENT_CHAR.archetype,
          summary: CURRENT_CHAR.summary, shortBio: CURRENT_CHAR.shortBio, longBio: CURRENT_CHAR.longBio,
          background: CURRENT_CHAR.background, scenario: CURRENT_CHAR.scenario, system_prompt: CURRENT_CHAR.system_prompt,
          greeting: CURRENT_CHAR.greeting, tags: CURRENT_CHAR.tags,
        } : null,
      };
        
        const url = `${API_BASE_URL}/v1/chat/`;
        console.log('[askLLM] Request URL:', url);
        console.log('[askLLM] API_BASE_URL:', API_BASE_URL);
        console.log('[askLLM] Payload:', payload);
        
        const r = await fetch(url, {
          method: "POST",
          credentials: "include",
          headers: headers,
          body: JSON.stringify(payload),
        });
        
        console.log('[askLLM] Response status:', r.status, r.statusText);
        console.log('[askLLM] Response headers:', Object.fromEntries(r.headers.entries()));
        
        if (!r.ok) {
          const errorText = await r.text();
          console.error(`[askLLM] HTTP ${r.status} Error:`, errorText);
          throw new Error(`HTTP ${r.status}: ${errorText || 'Server error'}`);
        }
        
      const j = await r.json();
        console.log('[askLLM] Response JSON:', j);
      return (j?.answer||'').trim();
      } catch(e) {
        console.error('[askLLM] Error:', e);
        console.error('[askLLM] Error stack:', e.stack);
        const errorMsg = e.message || String(e);
        return `(오류 발생) ${errorMsg}`;
      }
    }

    // 초기화
    document.addEventListener('DOMContentLoaded', async ()=>{
      // 뒤로가기
      document.getElementById('backBtn').onclick=()=>{ if(history.length>1) history.back(); else location.href='/'; };
      
      // 페르조나 버튼
      document.getElementById('personaBtn').onclick = openPersonaModal;
      
      // 모달 외부 클릭 시 닫기
      document.getElementById('personaModal').addEventListener('click', (e) => {
        if (e.target.id === 'personaModal') {
          closePersonaModal();
        }
      });

      // URL → 캐릭터 id 정규화
      const raw  = qs('character') || qs('character_id') || sessionStorage.getItem('lastChar') || null;
      const norm = normalizeCharId(raw) || 1;
      dbg('[param] raw='+raw+' norm='+norm);

      // 상세 API 호출
      let ch=null;
      try { ch = await fetchCharacter(norm); }
      catch(e){ dbg('[error] '+e.message); ch = {id:norm, name:'미확인 캐릭터', image:'/assets/img/placeholder.jpg', summary:'정보 없음'}; }
      CURRENT_CHAR = ch;
      try{ sessionStorage.setItem('lastChar', ch.id); }catch(_){}
      paintCharacter(ch);

      // Bootstrap: 기존 채팅 메시지 불러오기
      let isLoadingBootstrap = true;
      const sendBtn = document.getElementById('send');
      const inputTa = document.getElementById('ta');
      
      // 로딩 중에는 입력 비활성화
      sendBtn.disabled = true;
      inputTa.disabled = true;

      try {
        const bootstrapResult = await bootstrapCharacterChat(norm, 50);
        const messages = bootstrapResult.messages || [];
        
        // 메시지가 있으면 기존 메시지 렌더링 (created_at 오름차순 정렬 보장)
        if (messages.length > 0) {
          // created_at 기준으로 한 번 더 정렬 (안전장치)
          messages.sort((a, b) => {
            const timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
            const timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
            return timeA - timeB;
          });

          // 기존 메시지 렌더링
          messages.forEach(msg => {
            if (msg.role === 'user') {
              addUser(msg.content || '');
            } else if (msg.role === 'assistant') {
              addBot(msg.content || '');
            }
          });
        } else {
          // 메시지가 없으면 초기 문단(scenario/greeting) 출력
          const intro=[ch.scenario||"", ch.greeting||""].filter(Boolean).join("\n\n").trim();
          if(intro) addBot(intro);
        }
      } catch (e) {
        console.error('[CHAT][BOOTSTRAP] Error loading messages:', e);
        // 실패해도 초기 문단은 출력
        const intro=[ch.scenario||"", ch.greeting||""].filter(Boolean).join("\n\n").trim();
        if(intro) addBot(intro);
      } finally {
        // 로딩 완료 후 입력 활성화
        isLoadingBootstrap = false;
        sendBtn.disabled = false;
        inputTa.disabled = false;
        inputTa.focus();
      }

      // 입력 동작
      const ta=document.getElementById('ta'), btn=document.getElementById('send');
      
      // 비로그인 상태에서 입력/전송 시도 시 계정 상태 체크
      async function checkLoginAndSend(){
        const status = await checkAccountStatus();

        if (!status.ok) {
          if (status.reason === 'login') {
            showToast('로그인이 필요합니다.', 2000);
          } else if (status.reason === 'lock') {
            showToast('현재 계정이 차단된 상태입니다.', 2000);
          } else if (status.reason === 'use') {
            showToast('현재 사용이 불가한 상태입니다.', 2000);
          } else {
            showToast('계정 상태를 확인할 수 없습니다.', 2000);
          }
          ta.blur();
          return false;
        }
        return true;
      }

      async function send(){
        // 로그인 체크
        if (!(await checkLoginAndSend())) return;
        
        const v=ta.value.trim(); if(!v)return;
        addUser(v); ta.value=''; btn.disabled=true;
        
        console.log('[send] Starting API call with message:', v);
        console.log('[send] API_BASE_URL:', API_BASE_URL);
        
        try{ 
          const ans=await askLLM(v,'trpg');
          console.log('[send] Received answer:', ans);
          addBot(ans||'(응답이 비어있습니다)');
        }
        catch(e){ 
          console.error('[send] Error caught:', e);
          addBot('서버 오류: '+e.message);
        }
        finally{ 
          btn.disabled=false; 
          ta.focus(); 
        }
      }
      
      // 입력 필드 포커스 시 계정 상태 체크
      ta.addEventListener('focus', async (ev) => {
        const status = await checkAccountStatus();
        if (!status.ok) {
          ev.preventDefault();
          ta.blur();

          if (status.reason === 'login') {
            showToast('로그인이 필요합니다.', 2000);
          } else if (status.reason === 'lock') {
            showToast('현재 계정이 차단된 상태입니다.', 2000);
          } else if (status.reason === 'use') {
            showToast('현재 사용이 불가한 상태입니다.', 2000);
          } else {
            showToast('계정 상태를 확인할 수 없습니다.', 2000);
          }
        }
      });

      // 클릭 시도 시 계정 상태 체크
      ta.addEventListener('click', async (ev) => {
        const status = await checkAccountStatus();
        if (!status.ok) {
          ev.preventDefault();
          ta.blur();

          if (status.reason === 'login') {
            showToast('로그인이 필요합니다.', 2000);
          } else if (status.reason === 'lock') {
            showToast('현재 계정이 차단된 상태입니다.', 2000);
          } else if (status.reason === 'use') {
            showToast('현재 사용이 불가한 상태입니다.', 2000);
          } else {
            showToast('계정 상태를 확인할 수 없습니다.', 2000);
          }
        }
      });

      btn.onclick=send;
      ta.addEventListener('keydown', ev=>{ 
        if (ev.key==='Enter' && !ev.shiftKey){ 
          ev.preventDefault(); 
          send(); 
        }
      });
    });
  </script>
  <div id="gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;"></div>
<script>
(async () => {
  try {
    /* === API BASE URL 자동 감지 수정 === */

    const isLocal =
      typeof window !== 'undefined' &&
      (window.location.hostname === 'localhost' ||
       window.location.hostname === '127.0.0.1');

    console.log('[API BASE URL]:', API_BASE_URL);
    const url = `${API_BASE_URL}/assets/images?prefix=char/&limit=60&signed=true`;

    const res = await fetch(url, { credentials: 'include' });
    const data = await res.json();

    const $g = document.getElementById('gallery') || (() => {
      const div = document.createElement('div');
      div.id = 'gallery';
      div.style.display = 'grid';
      div.style.gridTemplateColumns = 'repeat(auto-fill,minmax(140px,1fr))';
      div.style.gap = '12px';
      document.body.appendChild(div);
      return div;
    })();

    $g.innerHTML = '';
    (data.items || []).forEach(item => {
      const img = document.createElement('img');
      img.src = item.url;
      img.alt = item.key || '';
      img.loading = 'lazy';
      img.style.width = '100%';
      img.style.height = '200px';
      img.style.objectFit = 'cover';
      img.referrerPolicy = 'no-referrer';
      img.crossOrigin = 'anonymous';
      $g.appendChild(img);
    });
  } catch (e) {
    console.error('Failed to load images', e);
  }
})();
</script>
</body>
</html>
